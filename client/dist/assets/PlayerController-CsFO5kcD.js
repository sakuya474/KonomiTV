var Qe=Object.defineProperty;var et=(t,e,o)=>e in t?Qe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o;var H=(t,e,o)=>et(t,typeof e!="symbol"?e+"":e,o);import{d as z,m as re,ao as te,U as w,P as ke,_ as W,c as _,w as b,e as F,b as s,a as m,k as K,h as E,r as M,t as $,n as T,o as d,R as S,G as We,H as je,a0 as Ye,a9 as xe,ap as tt,q as de,W as st,aq as it,ar as Ee,as as ot,F as J,u as Z,af as C,f as ye,g as ie,l as B,V as at,at as pe,M as ge,ag as Ke,p as Y,v as _e,au as Me,X as N,av as Ge,z as se,y as Ze,ac as Pe,aw as he,ai as ce,j as Re,ax as Be,ay as nt,az as rt}from"./index-BlIJpv-7.js";import{u as oe,C as ve,a as lt}from"./ChannelsStore-BCf0-Zxq.js";import{u as U,a as G}from"./symbol-CV4md8sc.js";import{V as Ve,_ as ct}from"./VSpacer-DQJmI_81.js";import{W as dt,K as _t,B as ut,H as we,m as ue,D as mt,L as pt,a as ht,b as De,c as Fe,M as Ue}from"./MediaSessionManager-Cp5v9VbW.js";import{V as Je}from"./VDialog-Dkum87Ep.js";import{V as ft,d as yt}from"./VCard-Bnp_HOJz.js";import{V as be}from"./VSwitch-C7H_LQZv.js";import{V as $e}from"./VSlider-C9f81qhc.js";import{V as Oe,m as gt,a as vt}from"./VTextField-DvhXYUD7.js";import{V as Ie,m as wt,a as bt,b as kt}from"./VSelectionControl-BMf-zyn-.js";import{S as St,a as Ct}from"./swiper-9TkivNcs.js";import{F as He}from"./index-ChpS_lob.js";import{C as $t}from"./CommentMuteSettings-BJYyUkEd.js";import{c as Te,b as Le,a as Tt}from"./VMenu-CHDKPEWg.js";import{d as Lt}from"./vuedraggable.umd-Cb4rs8Yv.js";import{u as Se,T as ne}from"./Twitter-P-YKqiZu.js";import{C as qe}from"./CaptureManager-Cwt7_uhH.js";import{V as xt}from"./Videos-DONS0idW.js";import{P as me}from"./PlayerUtils-D6ABkBVB.js";const Pt=z({name:"Watch-Header",props:{playback_mode:{type:String,required:!0}},data(){return{Utils:Object.freeze(w),ProgramUtils:Object.freeze(ke),time:te().format(w.isSmartphoneHorizontal()?"HH:mm:ss":"YYYY/MM/DD HH:mm:ss")}},computed:{...re(oe,U)},methods:{formatTime(t){const e=w.isSmartphoneHorizontal(),o=t.format(e?"HH:mm:ss":"YYYY/MM/DD HH:mm:ss");return w.apply28HourClock(o)},updateTimeCore(){const t=te();this.time=this.formatTime(t);const e=t.millisecond();return e>800?500:1e3-e},uptimeTime(){setTimeout(()=>{this.uptimeTime()},this.updateTimeCore())}},created(){this.time=this.formatTime(te()),setTimeout(()=>{this.uptimeTime()},1e3)},beforeUnmount(){this.uptimeTime=()=>{}}}),It=["src"],Mt=["innerHTML"],Rt={class:"watch-header__program-time"},Vt={class:"watch-header__now"};function Ht(t,e,o,i,a,l){const r=M("Icon"),f=M("router-link");return d(),_("header",{class:T(["watch-header",{"watch-header--video":t.playback_mode==="Video"}])},[b((d(),K(f,{class:"watch-header__back-icon",to:t.playback_mode==="Live"?"/tv/":"/videos/"},{default:E(()=>[m(r,{icon:"fluent:chevron-left-12-filled",width:"21px"})]),_:1},8,["to"])),[[S]]),t.playback_mode==="Live"?(d(),_("img",{key:0,class:"watch-header__broadcaster",src:`${t.Utils.api_base_url}/channels/${t.channelsStore.channel.current.id}/logo`},null,8,It)):F("",!0),s("span",{class:"watch-header__program-title",innerHTML:t.ProgramUtils.decorateProgramInfo(t.playback_mode==="Live"?t.channelsStore.channel.current.program_present:t.playerStore.recorded_program,"title")},null,8,Mt),s("span",Rt,$(t.ProgramUtils.getProgramTime(t.playback_mode==="Live"?t.channelsStore.channel.current.program_present:t.playerStore.recorded_program,!0)),1),m(Ve),s("span",Vt,$(t.time),1)],2)}const At=W(Pt,[["render",Ht],["__scopeId","data-v-b8c95e7e"]]),Et=je({...wt({falseIcon:"$radioOff",trueIcon:"$radioOn"})},"VRadio"),fe=We()({name:"VRadio",props:Et(),setup(t,e){let{slots:o}=e;return Ye(()=>{const i=Ie.filterProps(t);return m(Ie,xe(i,{class:["v-radio",t.class],style:t.style,type:"radio"}),o)}),{}}}),Bt=je({height:{type:[Number,String],default:"auto"},...gt(),...ot(bt(),["multiple"]),trueIcon:{type:Ee,default:"$radioOn"},falseIcon:{type:Ee,default:"$radioOff"},type:{type:String,default:"radio"}},"VRadioGroup"),Dt=We()({name:"VRadioGroup",inheritAttrs:!1,props:Bt(),emits:{"update:modelValue":t=>!0},setup(t,e){let{attrs:o,slots:i}=e;const a=tt(),l=de(()=>t.id||`radio-group-${a}`),r=st(t,"modelValue");return Ye(()=>{const[f,v]=it(o),u=Oe.filterProps(t),h=Ie.filterProps(t),c=i.label?i.label({label:t.label,props:{for:l.value}}):t.label;return m(Oe,xe({class:["v-radio-group",t.class],style:t.style},f,u,{modelValue:r.value,"onUpdate:modelValue":y=>r.value=y,id:l.value}),{...i,default:y=>{let{id:n,messagesId:p,isDisabled:L,isReadonly:P}=y;return m(J,null,[c&&m(vt,{id:n.value},{default:()=>[c]}),m(kt,xe(h,{id:n.value,"aria-describedby":p.value,defaultsTarget:"VRadio",trueIcon:t.trueIcon,falseIcon:t.falseIcon,type:t.type,disabled:L.value,readonly:P.value,"aria-labelledby":c?n.value:void 0,multiple:!1},v,{modelValue:r.value,"onUpdate:modelValue":x=>r.value=x}),i)])}})}),{}}}),Ft={class:"px-5 pb-6"},Ut={class:"d-flex align-center",style:{width:"85px"}},Ot={class:"text-right",style:{width:"42px"}},qt={class:"d-flex align-center",style:{width:"85px"}},Nt={class:"text-right",style:{width:"42px"}},zt={class:"d-flex align-center",style:{width:"85px"}},Wt={class:"text-right",style:{width:"42px"}},jt=z({__name:"LShapedScreenCropSettings",setup(t){const e=Z(),o=U();return(i,a)=>{const l=M("Icon");return d(),K(Je,{"max-width":"700",transition:"slide-y-transition",modelValue:C(o).lshaped_screen_crop_settings_modal,"onUpdate:modelValue":a[6]||(a[6]=r=>C(o).lshaped_screen_crop_settings_modal=r)},{default:E(()=>[m(yt,{class:"lshaped-screen-crop-settings-modal"},{default:E(()=>[m(ft,{class:"px-5 pt-3 pb-3 d-flex align-center font-weight-bold"},{default:E(()=>[m(l,{icon:"fluent:crop-20-filled",height:"28px"}),a[7]||(a[7]=s("span",{class:"ml-3"},"Ｌ字画面のクロップ",-1)),m(Ve),m(be,{class:"mr-4",color:"primary","hide-details":"",modelValue:C(e).settings.lshaped_screen_crop_enabled,"onUpdate:modelValue":a[0]||(a[0]=r=>C(e).settings.lshaped_screen_crop_enabled=r)},null,8,["modelValue"]),b((d(),_("div",{class:"d-flex align-center rounded-circle cursor-pointer px-2 py-2",onClick:a[1]||(a[1]=r=>C(o).lshaped_screen_crop_settings_modal=!1)},[m(l,{icon:"fluent:dismiss-12-filled",width:"23px",height:"23px"})])),[[S]])]),_:1}),s("div",Ft,[m($e,{color:"primary",modelValue:C(e).settings.lshaped_screen_crop_zoom_level,"onUpdate:modelValue":a[2]||(a[2]=r=>C(e).settings.lshaped_screen_crop_zoom_level=r),min:100,max:200,step:1,"show-ticks":"always","hide-details":"",class:"ml-0 mr-0 mb-4"},{prepend:E(()=>[s("div",Ut,[m(l,{icon:"mdi:magnify",width:"20px"}),a[8]||(a[8]=s("span",{class:"ml-2"},"拡大率",-1))])]),append:E(()=>[s("div",Ot,$(C(e).settings.lshaped_screen_crop_zoom_level)+"%",1)]),_:1},8,["modelValue"]),m($e,{color:"primary",modelValue:C(e).settings.lshaped_screen_crop_x_position,"onUpdate:modelValue":a[3]||(a[3]=r=>C(e).settings.lshaped_screen_crop_x_position=r),min:0,max:100,step:1,"show-ticks":"always","hide-details":"",class:"ml-0 mr-0 mb-4"},{prepend:E(()=>[s("div",qt,[m(l,{icon:"mdi:arrow-left-right",width:"20px"}),a[9]||(a[9]=s("span",{class:"ml-2"},"Ｘ座標",-1))])]),append:E(()=>[s("div",Nt,$(C(e).settings.lshaped_screen_crop_x_position)+"%",1)]),_:1},8,["modelValue"]),m($e,{color:"primary",modelValue:C(e).settings.lshaped_screen_crop_y_position,"onUpdate:modelValue":a[4]||(a[4]=r=>C(e).settings.lshaped_screen_crop_y_position=r),min:0,max:100,step:1,"show-ticks":"always","hide-details":"",class:"ml-0 mr-0 mb-4"},{prepend:E(()=>[s("div",zt,[m(l,{icon:"mdi:arrow-up-down",width:"20px"}),a[10]||(a[10]=s("span",{class:"ml-2"},"Ｙ座標",-1))])]),append:E(()=>[s("div",Wt,$(C(e).settings.lshaped_screen_crop_y_position)+"%",1)]),_:1},8,["modelValue"]),a[11]||(a[11]=s("div",{class:"mt-5 ml-0"},[s("div",{class:"d-flex align-center"},[s("span",null,"拡大起点")]),s("div",{class:"text-text-darken-1 mt-2",style:{"font-size":"13.5px"}}," 拡大率を変更したときに、どの位置を基準に拡大するかを設定します。 ")],-1)),m(Dt,{class:"zoom-origin-radio-group mt-3 ml-0",color:"primary",inline:"","hide-details":"",modelValue:C(e).settings.lshaped_screen_crop_zoom_origin,"onUpdate:modelValue":a[5]||(a[5]=r=>C(e).settings.lshaped_screen_crop_zoom_origin=r)},{default:E(()=>[m(fe,{label:"左上",value:"TopLeft"}),m(fe,{label:"左下",value:"BottomLeft"}),m(fe,{label:"右上",value:"TopRight"}),m(fe,{label:"右下",value:"BottomRight"})]),_:1},8,["modelValue"])])]),_:1})]),_:1},8,["modelValue"])}}}),Yt=W(jt,[["__scopeId","data-v-d082ffe0"]]),Kt=z({name:"Panel-ChannelTab",components:{Swiper:Ct,SwiperSlide:St},data(){return{Utils:Object.freeze(w),ChannelUtils:Object.freeze(ve),ProgramUtils:Object.freeze(ke),active_tab_index:0,swiper_instance:null}},computed:{...re(oe,U)},watch:{active_tab_index(){var t,e;(t=this.swiper_instance)==null||t.updateAutoHeight(),(e=this.swiper_instance)==null||e.slideTo(this.active_tab_index)},async"playerStore.tv_panel_active_tab"(){var t;await w.sleep(.05),(t=this.swiper_instance)==null||t.updateAutoHeight()},async"playerStore.video_panel_active_tab"(){var t;await w.sleep(.05),(t=this.swiper_instance)==null||t.updateAutoHeight()}},async mounted(){var t,e,o;if(await w.sleep(.05),(t=this.swiper_instance)==null||t.updateAutoHeight(),(e=document.querySelector(".channels-list-container"))==null||e.addEventListener("scroll",()=>{var i;(i=this.swiper_instance)==null||i.updateAutoHeight()},{passive:!0}),this.playerStore.tv_panel_active_tab==="Channel")for(let i=0;i<20;i++)await w.sleep(.1),(o=this.swiper_instance)==null||o.updateAutoHeight()}}),Gt={class:"channels-container channels-container--watch"},Zt={class:"channels-tab"},Jt={class:"channels-list-container"},Xt={class:"channels"},Qt={class:"channel__broadcaster"},es=["src"],ts={class:"channel__broadcaster-content"},ss={class:"channel__broadcaster-name"},is={class:"ml-1"},os={class:"channel__program-present"},as=["innerHTML"],ns={class:"channel__program-present-time"},rs={class:"channel__program-following"},ls={class:"channel__program-following-title"},cs=["innerHTML"],ds={class:"channel__program-following-time"},_s={class:"channel__progressbar"};function us(t,e,o,i,a,l){const r=M("router-link"),f=M("SwiperSlide"),v=M("Swiper");return d(),_("div",Gt,[s("div",Zt,[s("div",{class:"channels-tab__buttons",style:ye({"--tab-length":Array.from(t.channelsStore.channels_list_with_pinned_for_watch).length,"--active-tab-index":t.active_tab_index})},[(d(!0),_(J,null,ie(Array.from(t.channelsStore.channels_list_with_pinned_for_watch),([u],h)=>(d(),K(at,{variant:"flat",class:"channels-tab__button",key:u,onClick:c=>t.active_tab_index=h},{default:E(()=>[B($(u),1)]),_:2},1032,["onClick"]))),128)),e[2]||(e[2]=s("div",{class:"channels-tab__highlight"},null,-1))],4)]),s("div",Jt,[m(v,{class:"channels-list","space-between":32,"auto-height":!0,"touch-start-prevent-default":!1,observer:!0,"observe-parents":!0,onSwiper:e[0]||(e[0]=u=>t.swiper_instance=u),onSlideChange:e[1]||(e[1]=u=>t.active_tab_index=u.activeIndex)},{default:E(()=>[(d(!0),_(J,null,ie(Array.from(t.channelsStore.channels_list_with_pinned_for_watch),([u,h])=>(d(),K(f,{key:u},{default:E(()=>[s("div",Xt,[(d(!0),_(J,null,ie(h,c=>b((d(),K(r,{class:"channel",draggable:"false",key:c.id,to:`/tv/watch/${c.display_channel_id}`},{default:E(()=>[s("div",Qt,[s("img",{class:"channel__broadcaster-icon",loading:"lazy",decoding:"async",src:`${t.Utils.api_base_url}/channels/${c.id}/logo`},null,8,es),s("div",ts,[s("span",ss,"Ch: "+$(c.channel_number)+" "+$(c.name),1),s("div",{class:T(["channel__broadcaster-force",`channel__broadcaster-force--${t.ChannelUtils.getChannelForceType(c.jikkyo_force)}`])},[e[3]||(e[3]=s("svg",{class:"iconify iconify--fa-solid",width:"9.63px",height:"11px",viewBox:"0 0 448 512"},[s("path",{fill:"currentColor",d:"M323.56 51.2c-20.8 19.3-39.58 39.59-56.22 59.97C240.08 73.62 206.28 35.53 168 0C69.74 91.17 0 209.96 0 281.6C0 408.85 100.29 512 224 512s224-103.15 224-230.4c0-53.27-51.98-163.14-124.44-230.4zm-19.47 340.65C282.43 407.01 255.72 416 226.86 416C154.71 416 96 368.26 96 290.75c0-38.61 24.31-72.63 72.79-130.75c6.93 7.98 98.83 125.34 98.83 125.34l58.63-66.88c4.14 6.85 7.91 13.55 11.27 19.97c27.35 52.19 15.81 118.97-33.43 153.42z"})],-1)),s("span",is,$(c.jikkyo_force??"--"),1)],2)])]),s("div",os,[s("span",{class:"channel__program-present-title",innerHTML:t.ProgramUtils.decorateProgramInfo(c.program_present,"title")},null,8,as),s("span",ns,$(t.ProgramUtils.getProgramTime(c.program_present)),1)]),s("div",rs,[s("div",ls,[e[4]||(e[4]=s("span",{class:"channel__program-following-title-decorate"},"NEXT",-1)),e[5]||(e[5]=s("svg",{class:"channel__program-following-title-icon iconify iconify--fluent",width:"16px",height:"16px",viewBox:"0 0 20 20"},[s("path",{fill:"currentColor",d:"M10.018 5.486a1 1 0 0 1 1.592-.806l5.88 4.311a1.25 1.25 0 0 1 0 2.017l-5.88 4.311a1 1 0 0 1-1.592-.806v-3.16L4.61 15.319a1 1 0 0 1-1.592-.806V5.486A1 1 0 0 1 4.61 4.68l5.408 3.966v-3.16Z"})],-1)),s("span",{class:"channel__program-following-title-text",innerHTML:t.ProgramUtils.decorateProgramInfo(c.program_following,"title")},null,8,cs)]),s("span",ds,$(t.ProgramUtils.getProgramTime(c.program_following)),1)]),s("div",_s,[s("div",{class:"channel__progressbar-progress",style:ye(`width:${t.ProgramUtils.getProgramProgress(c.program_present)}%;`)},null,4)])]),_:2},1032,["to"])),[[S]])),128))])]),_:2},1024))),128))]),_:1})])])}const ms=W(Kt,[["render",us],["__scopeId","data-v-6121504c"]]),ps=z({name:"Panel-CommentTab",components:{CommentMuteSettings:$t,VirtuaList:He},props:{playback_mode:{type:String,required:!0}},data(){return{Utils:Object.freeze(w),is_manual_scroll:!1,is_auto_scrolling:!1,comment_list:[],comment_list_element:null,is_comment_list_dropdown_display:!1,comment_list_dropdown_top:0,comment_list_dropdown_comment:null,comment_mute_settings_modal:!1,visibilitychange_listener:null,current_playback_position:0,target_comment_index:0,virtua_scroller:null}},computed:{...re(oe,U)},watch:{"channelsStore.channel.current.id":{handler(){this.playback_mode==="Live"&&(this.comment_list=[])}}},mounted(){this.comment_list_element===null&&(this.comment_list_element=document.querySelector(".comment-list")),this.playback_mode==="Video"&&(this.virtua_scroller=this.$refs.virtua_scroller);let t=!1;this.comment_list_element.onmousedown=l=>{if(this.comment_list_element===null)return;l.clientX-this.comment_list_element.getBoundingClientRect().left>this.comment_list_element.clientWidth&&(t=!0)},this.comment_list_element.onmouseup=l=>{if(this.comment_list_element===null)return;l.clientX-this.comment_list_element.getBoundingClientRect().left>this.comment_list_element.clientWidth&&(t=!1)};const e=()=>{t=!0,window.setTimeout(()=>t=!1,100)};let o=!1;this.comment_list_element.ontouchstart=()=>o=!0,this.comment_list_element.ontouchend=()=>o=!1,this.comment_list_element.ontouchmove=()=>o===!0?e():"",this.comment_list_element.onwheel=e,this.comment_list_element.onscroll=async()=>{this.comment_list_element!==null&&this.is_auto_scrolling===!1&&t===!0&&(this.is_manual_scroll=!0,console.log("[Comment.vue] Manual scroll is enabled."),await w.sleep(.1),this.playback_mode==="Live"&&this.comment_list_element.scrollTop+this.comment_list_element.offsetHeight>this.comment_list_element.scrollHeight-10&&(this.is_manual_scroll=!1,console.log("[Comment.vue] Manual scroll is disabled because bottom of comment list is reached.")))};const i=[],a=500;this.playerStore.event_emitter.on("CommentReceived",async l=>{if(l.is_initial_comments===!0)this.comment_list=[],this.comment_list.push(...l.comments),console.log(`[Comment.vue] Comment list updated. ${this.comment_list.length} comments.`),this.playback_mode==="Live"&&this.scrollCommentList(!1);else{if(document.visibilityState==="hidden"){i.push(...l.comments);return}this.comment_list.length>=a&&this.is_manual_scroll===!1&&this.comment_list.splice(0,Math.max(0,this.comment_list.length-a)),this.comment_list.push(...l.comments),this.scrollCommentList(!1)}}),this.playback_mode==="Live"&&(this.playerStore.event_emitter.on("CommentSendCompleted",async l=>{this.comment_list.push(l.comment),this.scrollCommentList(!1)}),this.visibilitychange_listener=()=>{if(document.visibilityState==="visible"){const l=this.comment_list.length+i.length;l>=a&&this.is_manual_scroll===!1&&this.comment_list.splice(0,Math.max(0,l-a)),this.comment_list.push(...i),i.length=0,this.scrollCommentList(!1)}},document.addEventListener("visibilitychange",this.visibilitychange_listener)),this.playback_mode==="Video"&&(console.log("[Comment.vue] Setting up PlaybackPositionChanged event listener."),this.playerStore.event_emitter.on("PlaybackPositionChanged",l=>{this.current_playback_position=l.playback_position,this.is_manual_scroll===!1&&this.scrollPlaybackComment(!1)}))},beforeUnmount(){this.playback_mode==="Live"&&this.visibilitychange_listener!==null&&(document.removeEventListener("visibilitychange",this.visibilitychange_listener),this.visibilitychange_listener=null),this.playerStore.event_emitter.off("CommentReceived"),this.playback_mode==="Live"&&this.playerStore.event_emitter.off("CommentSendCompleted"),this.playback_mode==="Video"&&this.playerStore.event_emitter.off("PlaybackPositionChanged"),this.comment_list=[]},methods:{showCommentListDropdown(t,e){const o=this.$refs.comment_list_wrapper.getBoundingClientRect(),i=106,a=t.currentTarget.getBoundingClientRect();this.comment_list_dropdown_top=a.top-o.top,this.comment_list_dropdown_top+i>o.height&&(this.comment_list_dropdown_top=this.comment_list_dropdown_top-i+a.height),this.comment_list_dropdown_comment=e,this.is_comment_list_dropdown_display=!0},hideCommentListDropdown(){this.is_comment_list_dropdown_display=!1,this.comment_list=this.comment_list.filter(t=>pe.isMutedComment(t.text,t.user_id)===!1)},copyTextToClipboard(){this.comment_list_dropdown_comment!==null&&(navigator.clipboard.writeText(this.comment_list_dropdown_comment.text),this.hideCommentListDropdown())},addMutedKeywords(){this.comment_list_dropdown_comment!==null&&(pe.addMutedKeywords(this.comment_list_dropdown_comment.text),this.hideCommentListDropdown())},addMutedNiconicoUserIds(){this.comment_list_dropdown_comment!==null&&(pe.addMutedNiconicoUserIDs(this.comment_list_dropdown_comment.user_id),this.hideCommentListDropdown())},async scrollCommentList(t=!1){if(this.comment_list_element===null||(this.is_comment_list_dropdown_display===!0&&(this.is_manual_scroll=!0,console.log("[Comment.vue] Manual scroll is enabled because dropdown menu is displayed.")),this.is_manual_scroll===!0))return;this.is_auto_scrolling=!0;const e=(o=3)=>{o<=0||window.requestAnimationFrame(()=>{var i,a;t===!0?(i=this.comment_list_element)==null||i.scrollTo({top:this.comment_list_element.scrollHeight,left:0,behavior:"smooth"}):(a=this.comment_list_element)==null||a.scrollTo(0,this.comment_list_element.scrollHeight),e(o-1)})};e(),await w.sleep(.1),this.is_auto_scrolling=!1},async scrollPlaybackComment(t=!1){if(!this.virtua_scroller){console.log("[Comment.vue] VirtuaList reference is not available.");return}if(this.is_comment_list_dropdown_display===!0&&(this.is_manual_scroll=!0,console.log("[Comment.vue] Manual scroll is enabled because dropdown menu is displayed.")),this.is_manual_scroll===!0||this.playerStore.video_panel_active_tab!=="Comment")return;let e=-1;for(let o=0;o<this.comment_list.length&&this.comment_list[o].playback_position<=this.current_playback_position;o++)e=o;e===this.target_comment_index&&t===!1||(this.is_auto_scrolling=!0,e!==-1&&(this.virtua_scroller.scrollToIndex(e,{align:"end",smooth:t,offset:-3}),this.target_comment_index=e),await w.sleep(.1),this.is_auto_scrolling=!1)},handleAutoScrollButtonClick(){this.is_manual_scroll=!1,console.log("[Comment.vue] Manual scroll is disabled because Auto-scroll button clicked."),this.playback_mode==="Live"?this.scrollCommentList(!0):this.playback_mode==="Video"&&this.scrollPlaybackComment(!0)}}}),hs={class:"comment-header"},fs={class:"comment-header__title"},ys={class:"comment-list-wrapper",ref:"comment_list_wrapper"},gs={class:"comment__text"},vs={class:"comment__time"},ws=["onMouseup","onTouchend"],bs={class:"comment__text"},ks={class:"comment__time"},Ss=["onMouseup","onTouchend"],Cs={key:2,class:"comment-announce"},$s={key:3,class:"comment-announce"},Ts={class:"comment-announce__text"},Ls={class:"mt-0 mb-0"},xs={key:4,class:"comment-announce"},Ps={key:5,class:"comment-announce"},Is={class:"comment-announce__text"},Ms={class:"mt-0 mb-0"};function Rs(t,e,o,i,a,l){const r=M("Icon"),f=M("DynamicScrollerItem"),v=M("DynamicScroller"),u=M("VirtuaList"),h=M("CommentMuteSettings");return d(),_("div",{class:T(["comment-container",{"comment-container--video":t.playback_mode==="Video"}])},[s("section",hs,[s("h2",fs,[m(r,{class:"comment-header__title-icon",icon:"bi:chat-left-text-fill",height:"18.5px"}),e[7]||(e[7]=s("span",{class:"comment-header__title-text"},"コメント",-1))]),b((d(),_("button",{class:"comment-header__button ml-auto",onClick:e[0]||(e[0]=c=>t.comment_mute_settings_modal=!t.comment_mute_settings_modal)},[m(r,{icon:"heroicons-solid:filter",height:"11px"}),e[8]||(e[8]=s("span",{class:"ml-1"},"ミュート設定",-1))])),[[S]])]),s("section",ys,[s("div",{class:T(["comment-list-dropdown",{"comment-list-dropdown--display":t.is_comment_list_dropdown_display}]),style:ye({"--comment-list-dropdown-top":`${t.comment_list_dropdown_top}px`})},[m(Tt,{style:{background:"rgb(var(--v-theme-background-lighten-1))"}},{default:E(()=>[m(Te,{density:"compact",style:{"min-height":"30px"},onClick:e[1]||(e[1]=c=>t.copyTextToClipboard())},{default:E(()=>[m(Le,{class:"d-flex align-center"},{default:E(()=>[m(r,{icon:"fluent:clipboard-paste-20-filled",width:"20px"}),e[9]||(e[9]=s("span",{class:"ml-2"},"クリップボードにコピー",-1))]),_:1})]),_:1}),m(Te,{density:"compact",style:{"min-height":"30px"},onClick:e[2]||(e[2]=c=>t.addMutedKeywords())},{default:E(()=>[m(Le,{class:"d-flex align-center"},{default:E(()=>[m(r,{icon:"fluent:comment-dismiss-20-filled",width:"20px"}),e[10]||(e[10]=s("span",{class:"ml-2"},"このコメントをミュート",-1))]),_:1})]),_:1}),m(Te,{density:"compact",style:{"min-height":"30px"},onClick:e[3]||(e[3]=c=>t.addMutedNiconicoUserIds())},{default:E(()=>[m(Le,{class:"d-flex align-center"},{default:E(()=>[m(r,{icon:"fluent:person-prohibited-20-filled",width:"20px"}),e[11]||(e[11]=s("span",{class:"ml-2"},"このコメントの投稿者をミュート",-1))]),_:1})]),_:1})]),_:1})],6),s("div",{class:T(["comment-list-cover",{"comment-list-cover--display":t.is_comment_list_dropdown_display}]),onClick:e[4]||(e[4]=c=>t.hideCommentListDropdown())},null,2),t.playback_mode==="Live"?(d(),K(v,{key:0,class:"comment-list",direction:"vertical",items:t.comment_list,"min-item-size":34},{default:E(({item:c,active:y})=>[m(f,{item:c,active:y,"size-dependencies":[c.text]},{default:E(()=>[s("div",{class:T(["comment",{"comment--my-post":c.my_post}])},[s("span",gs,$(c.text),1),s("span",vs,$(c.time),1),b((d(),_("div",{class:"comment__icon",onMouseup:n=>t.showCommentListDropdown(n,c),onTouchend:n=>t.showCommentListDropdown(n,c)},[...e[12]||(e[12]=[s("svg",{class:"iconify iconify--fluent",width:"20px",height:"20px",viewBox:"0 0 20 20"},[s("path",{fill:"currentColor",d:"M10 6.5A1.75 1.75 0 1 1 10 3a1.75 1.75 0 0 1 0 3.5ZM10 17a1.75 1.75 0 1 1 0-3.5a1.75 1.75 0 0 1 0 3.5Zm-1.75-7a1.75 1.75 0 1 0 3.5 0a1.75 1.75 0 0 0-3.5 0Z"})],-1)])],40,ws)),[[S,!t.Utils.isTouchDevice()]])],2)]),_:2},1032,["item","active","size-dependencies"])]),_:1},8,["items"])):(d(),K(u,{key:1,ref:"virtua_scroller",class:"comment-list",data:t.comment_list},{default:E(({item:c})=>[s("div",{class:T(["comment",{"comment--my-post":c.my_post}])},[s("span",bs,$(c.text),1),s("span",ks,$(c.time),1),b((d(),_("div",{class:"comment__icon",onMouseup:y=>t.showCommentListDropdown(y,c),onTouchend:y=>t.showCommentListDropdown(y,c)},[...e[13]||(e[13]=[s("svg",{class:"iconify iconify--fluent",width:"20px",height:"20px",viewBox:"0 0 20 20"},[s("path",{fill:"currentColor",d:"M10 6.5A1.75 1.75 0 1 1 10 3a1.75 1.75 0 0 1 0 3.5ZM10 17a1.75 1.75 0 1 1 0-3.5a1.75 1.75 0 0 1 0 3.5Zm-1.75-7a1.75 1.75 0 1 0 3.5 0a1.75 1.75 0 0 0-3.5 0Z"})],-1)])],40,Ss)),[[S,!t.Utils.isTouchDevice()]])],2)]),_:1},8,["data"])),t.playback_mode==="Live"&&t.playerStore.live_comment_init_failed_message===null&&t.comment_list.length===0?(d(),_("div",Cs,[...e[14]||(e[14]=[s("div",{class:"comment-announce__heading"},"まだコメントがありません。",-1),s("div",{class:"comment-announce__text"},[s("p",{class:"mt-0 mb-0"},"このチャンネルに対応するニコニコ実況のコメントが、リアルタイムで表示されます。")],-1)])])):F("",!0),t.playback_mode==="Live"&&t.playerStore.live_comment_init_failed_message!==null&&t.comment_list.length===0?(d(),_("div",$s,[e[15]||(e[15]=s("div",{class:"comment-announce__heading"},"コメントがありません。",-1)),s("div",Ts,[s("p",Ls,$(t.playerStore.live_comment_init_failed_message),1)])])):F("",!0),t.playback_mode==="Video"&&t.playerStore.video_comment_init_failed_message===null&&t.comment_list.length===0?(d(),_("div",xs,[...e[16]||(e[16]=[s("div",{class:"comment-announce__heading"},"まだコメントがありません。",-1),s("div",{class:"comment-announce__text"},[s("p",{class:"mt-0 mb-0"},"この録画番組に対応する、ニコニコ実況の過去ログコメントを取得しています...")],-1)])])):F("",!0),t.playback_mode==="Video"&&t.playerStore.video_comment_init_failed_message!==null&&t.comment_list.length===0?(d(),_("div",Ps,[e[17]||(e[17]=s("div",{class:"comment-announce__heading"},"コメントがありません。",-1)),s("div",Is,[s("p",Ms,$(t.playerStore.video_comment_init_failed_message),1)])])):F("",!0)],512),b((d(),_("div",{class:T(["comment-scroll-button elevation-5",{"comment-scroll-button--display":t.is_manual_scroll}]),onClick:e[5]||(e[5]=(...c)=>t.handleAutoScrollButtonClick&&t.handleAutoScrollButtonClick(...c))},[m(r,{icon:"fluent:arrow-down-12-filled",height:"29px"})],2)),[[S]]),m(h,{modelValue:t.comment_mute_settings_modal,"onUpdate:modelValue":e[6]||(e[6]=c=>t.comment_mute_settings_modal=c)},null,8,["modelValue"])],2)}const Vs=W(ps,[["render",Rs],["__scopeId","data-v-f9abeec5"]]),Hs=z({name:"Panel-ProgramTab",data(){return{Utils:Object.freeze(w),ChannelUtils:Object.freeze(ve),ProgramUtils:Object.freeze(ke)}},computed:{...re(oe)}}),As={class:"program-container"},Es={class:"program-broadcaster"},Bs=["src"],Ds={class:"program-broadcaster__number"},Fs={class:"program-broadcaster__name"},Us={class:"program-info"},Os=["innerHTML"],qs={class:"program-info__time"},Ns=["innerHTML"],zs={class:"program-info__genre-container"},Ws={class:"program-info__next"},js=["innerHTML"],Ys={class:"program-info__next-time"},Ks={class:"program-info__status"},Gs={class:"ml-2"},Zs={class:"program-info__status-viewers ml-5"},Js={class:"ml-1"},Xs={class:"program-detail-container"},Qs={class:"program-detail__heading"},ei=["innerHTML"];function ti(t,e,o,i,a,l){var f,v;const r=M("Icon");return d(),_("div",As,[s("section",Es,[s("img",{class:"program-broadcaster__icon",src:`${t.Utils.api_base_url}/channels/${t.channelsStore.channel.current.id}/logo`},null,8,Bs),s("div",Ds,"Ch: "+$(t.channelsStore.channel.current.channel_number),1),s("div",Fs,$(t.channelsStore.channel.current.name),1)]),s("section",Us,[s("h1",{class:"program-info__title",innerHTML:t.ProgramUtils.decorateProgramInfo(t.channelsStore.channel.current.program_present,"title")},null,8,Os),s("div",qs,$(t.ProgramUtils.getProgramTime(t.channelsStore.channel.current.program_present)),1),s("div",{class:"program-info__description",innerHTML:t.ProgramUtils.decorateProgramInfo(t.channelsStore.channel.current.program_present,"description")},null,8,Ns),s("div",zs,[(d(!0),_(J,null,ie(((f=t.channelsStore.channel.current.program_present)==null?void 0:f.genres)??[],(u,h)=>(d(),_("div",{class:"program-info__genre",key:h},$(u.major)+" / "+$(u.middle),1))),128))]),s("div",Ws,[e[0]||(e[0]=s("span",{class:"program-info__next-decorate"},"NEXT",-1)),m(r,{class:"program-info__next-icon",icon:"fluent:fast-forward-20-filled",width:"16px"})]),s("span",{class:"program-info__next-title",innerHTML:t.ProgramUtils.decorateProgramInfo(t.channelsStore.channel.current.program_following,"title")},null,8,js),s("div",Ys,$(t.ProgramUtils.getProgramTime(t.channelsStore.channel.current.program_following)),1),s("div",Ks,[s("div",{class:T(["program-info__status-force",`program-info__status-force--${t.ChannelUtils.getChannelForceType(t.channelsStore.channel.current.jikkyo_force)}`])},[m(r,{icon:"fa-solid:fire-alt",height:"14px"}),e[1]||(e[1]=s("span",{class:"ml-2"},"勢い:",-1)),s("span",Gs,$(t.channelsStore.channel.current.jikkyo_force??"--")+" コメ/分",1)],2),s("div",Zs,[m(r,{icon:"fa-solid:eye",height:"14px"}),e[2]||(e[2]=s("span",{class:"ml-2"},"視聴数:",-1)),s("span",Js,$(t.channelsStore.channel.current.viewer_count),1)])])]),s("section",Xs,[(d(!0),_(J,null,ie(((v=t.channelsStore.channel.current.program_present)==null?void 0:v.detail)??{},(u,h)=>(d(),_("div",{class:"program-detail",key:h},[s("h2",Qs,$(h),1),s("div",{class:"program-detail__text",innerHTML:t.Utils.URLtoLink(u)},null,8,ei)]))),128))])])}const si=W(Hs,[["render",ti],["__scopeId","data-v-bbeca1ae"]]),ii=z({name:"Panel-RecordedProgramTab",data(){return{Utils:Object.freeze(w),ProgramUtils:Object.freeze(ke),comment_count:null}},computed:{...re(U,Z),isInMylist(){return this.settingsStore.settings.mylist.some(t=>t.type==="RecordedProgram"&&t.id===this.playerStore.recorded_program.id)}},methods:{toggleMylist(){const t=this.playerStore.recorded_program;this.isInMylist?(this.settingsStore.settings.mylist=this.settingsStore.settings.mylist.filter(e=>!(e.type==="RecordedProgram"&&e.id===t.id)),ge.show("マイリストから削除しました。")):this.settingsStore.settings.mylist.push({type:"RecordedProgram",id:t.id,created_at:w.time()})}},created(){this.playerStore.event_emitter.on("CommentReceived",t=>{t.is_initial_comments===!0&&(this.comment_count=t.comments.length)})},beforeUnmount(){this.playerStore.event_emitter.off("CommentReceived")}}),oi={class:"program-container"},ai={class:"program-info"},ni=["innerHTML"],ri={class:"program-info__broadcaster"},li=["src"],ci={class:"program-info__broadcaster-container"},di={key:0,class:"d-flex align-center"},_i={class:"program-info__broadcaster-number"},ui={class:"program-info__broadcaster-name"},mi={key:1,class:"d-flex align-center"},pi={class:"program-info__broadcaster-time"},hi=["innerHTML"],fi={class:"program-info__genre-container"},yi={class:"mt-5"},gi={class:"program-info__status"},vi={class:"ml-2"},wi={class:"program-info__status"},bi={class:"ml-2"},ki={class:"program-detail-container"},Si={class:"program-detail__heading"},Ci=["innerHTML"];function $i(t,e,o,i,a,l){var f;const r=M("Icon");return d(),_("div",oi,[s("section",ai,[s("h1",{class:"program-info__title",innerHTML:t.ProgramUtils.decorateProgramInfo(t.playerStore.recorded_program,"title")},null,8,ni),s("div",ri,[s("img",{class:"program-info__broadcaster-icon",src:`${t.Utils.api_base_url}/channels/${((f=t.playerStore.recorded_program.channel)==null?void 0:f.id)??"NID0-SID0"}/logo`},null,8,li),s("div",ci,[t.playerStore.recorded_program.channel!==null?(d(),_("div",di,[s("div",_i,"Ch: "+$(t.playerStore.recorded_program.channel.channel_number),1),s("div",ui,$(t.playerStore.recorded_program.channel.name),1)])):(d(),_("div",mi,[...e[1]||(e[1]=[s("div",{class:"program-info__broadcaster-number"},"チャンネル情報なし",-1)])])),s("div",pi,$(t.ProgramUtils.getProgramTime(t.playerStore.recorded_program)),1)])]),s("div",{class:"program-info__description",innerHTML:t.ProgramUtils.decorateProgramInfo(t.playerStore.recorded_program,"description")},null,8,hi),s("div",fi,[(d(!0),_(J,null,ie(t.playerStore.recorded_program.genres??[],(v,u)=>(d(),_("div",{class:"program-info__genre",key:u},$(v.major)+" / "+$(v.middle),1))),128))]),s("div",yi,[s("div",gi,[m(r,{icon:"ic:round-date-range",height:"17px",style:{"margin-left":"-2px","margin-right":"-1.7px","margin-bottom":"-3px"}}),s("span",vi,"録画期間: "+$(t.playerStore.recorded_program.is_partially_recorded?"(一部のみ録画)":""),1),e[2]||(e[2]=s("br",null,null,-1)),s("span",null,$(t.ProgramUtils.getRecordingTime(t.playerStore.recorded_program)),1)]),s("div",wi,[m(r,{icon:"bi:chat-left-text-fill",height:"12.5px",style:{"margin-bottom":"-3px"}}),e[3]||(e[3]=s("span",{class:"ml-2"},"コメント数:",-1)),s("span",bi,$(t.comment_count??"--"),1)]),b((d(),_("div",{class:"program-info__button",onClick:e[0]||(e[0]=(...v)=>t.toggleMylist&&t.toggleMylist(...v))},[t.isInMylist?(d(),_(J,{key:0},[m(r,{icon:"fluent:checkmark-16-filled",width:"18px",height:"18px",style:{color:"rgb(var(--v-theme-primary))","margin-bottom":"-1px"}}),e[4]||(e[4]=s("span",{style:{"margin-left":"6px"}},"マイリストに追加済み",-1))],64)):(d(),_(J,{key:1},[m(r,{icon:"fluent:add-16-filled",width:"18px",height:"18px",style:{"margin-bottom":"-1px"}}),e[5]||(e[5]=s("span",{style:{"margin-left":"6px"}},"マイリストに追加",-1))],64))])),[[S]])])]),s("section",ki,[(d(!0),_(J,null,ie(t.playerStore.recorded_program.detail??{},(v,u)=>(d(),_("div",{class:"program-detail",key:u},[s("h2",Si,$(u),1),s("div",{class:"program-detail__text",innerHTML:t.Utils.URLtoLink(v)},null,8,Ci)]))),128))])])}const Ti=W(ii,[["render",$i],["__scopeId","data-v-cb8ca67d"]]),Li=z({name:"Panel-Remocon",props:{modelValue:{type:Boolean,required:!0}},emits:{"update:modelValue":t=>!0}}),xi={class:"remote-control-data-broadcasting remote-control-data-broadcasting--disabled"},Pi={class:"remote-control__directional-key"},Ii={class:"remote-control-button-up","data-arib-key-code":"1"},Mi={class:"remote-control-button-left","data-arib-key-code":"3"},Ri={class:"remote-control-button-select","data-arib-key-code":"18"},Vi={class:"remote-control-button-right","data-arib-key-code":"4"},Hi={class:"remote-control-button-down","data-arib-key-code":"2"},Ai={class:"remote-control__control-key"},Ei={class:"remote-control-button-data","data-arib-key-code":"20"},Bi={class:"remote-control-button-back","data-arib-key-code":"19"},Di={class:"remote-control-button-blue bg-blue-darken-3","data-arib-key-code":"21"},Fi={class:"remote-control-button-red bg-red-darken-3","data-arib-key-code":"22"},Ui={class:"remote-control-button-green bg-green-darken-3","data-arib-key-code":"23"},Oi={class:"remote-control-button-yellow bg-yellow-darken-3 text-text","data-arib-key-code":"24"},qi={class:"remote-control__number-key"},Ni={"data-remocon-id":"1","data-arib-key-code":"6"},zi={"data-remocon-id":"2","data-arib-key-code":"7"},Wi={"data-remocon-id":"3","data-arib-key-code":"8"},ji={"data-remocon-id":"4","data-arib-key-code":"9"},Yi={"data-remocon-id":"5","data-arib-key-code":"10"},Ki={"data-remocon-id":"6","data-arib-key-code":"11"},Gi={"data-remocon-id":"7","data-arib-key-code":"12"},Zi={"data-remocon-id":"8","data-arib-key-code":"13"},Ji={"data-remocon-id":"9","data-arib-key-code":"14"},Xi={"data-remocon-id":"10","data-arib-key-code":"15"},Qi={"data-remocon-id":"11","data-arib-key-code":"16"},eo={"data-remocon-id":"12","data-arib-key-code":"17"};function to(t,e,o,i,a,l){const r=M("Icon");return d(),_("div",{class:T(["remote-control-container",{"remote-control-container--showing":t.modelValue}]),onClick:e[2]||(e[2]=f=>t.$emit("update:modelValue",!1))},[s("div",{class:"remote-control elevation-6",onClick:e[1]||(e[1]=Y(()=>{},["stop"]))},[b((d(),_("div",{class:"remote-control__close d-flex align-center rounded-circle cursor-pointer px-2 py-2",onClick:e[0]||(e[0]=f=>t.$emit("update:modelValue",!1))},[m(r,{icon:"fluent:dismiss-12-filled",width:"23px",height:"23px"})])),[[S]]),s("div",xi,[m(Ke,{indeterminate:"",size:"60",width:"6",class:"remote-control__loading"}),s("div",Pi,[b((d(),_("button",Ii,[m(r,{icon:"fluent:chevron-up-12-filled",width:"26px",height:"26px"})])),[[S]]),b((d(),_("button",Mi,[m(r,{icon:"fluent:chevron-left-12-filled",width:"26px",height:"26px"})])),[[S]]),b((d(),_("button",Ri,[...e[3]||(e[3]=[B(" 決定 ",-1)])])),[[S]]),b((d(),_("button",Vi,[m(r,{icon:"fluent:chevron-right-12-filled",width:"26px",height:"26px"})])),[[S]]),b((d(),_("button",Hi,[m(r,{icon:"fluent:chevron-down-12-filled",width:"26px",height:"26px"})])),[[S]])]),s("div",Ai,[b((d(),_("button",Ei,[...e[4]||(e[4]=[s("svg",{width:"20px",height:"20px",viewBox:"0 0 512 512"},[s("path",{fill:"currentColor",d:"M248.039 381.326L355.039 67.8258C367.539 28.3257 395.039 34.3258 406.539 34.3258C431.039 34.3258 453.376 61.3258 441.039 96.8258C362.639 322.426 343.539 375.326 340.539 384.826C338.486 391.326 342.039 391.326 345.539 391.326C377.039 391.326 386.539 418.326 386.539 435.326C386.539 458.826 371.539 477.326 350.039 477.326H214.539C179.039 477.326 85.8269 431.3 88.0387 335.826C91.0387 206.326 192.039 183.326 243.539 183.326H296.539L265.539 272.326H243.539C185.539 272.326 174.113 314.826 176.039 334.326C180.039 374.826 215.039 389.814 237.039 390.326C244.539 390.5 246.039 386.826 248.039 381.326Z"})],-1),s("span",{class:"ml-1"},"データ",-1)])])),[[S]]),b((d(),_("button",Bi,[m(r,{icon:"fluent:chevron-left-12-filled",width:"20px"}),e[5]||(e[5]=s("span",{class:"ml-1"},"戻る",-1))])),[[S]]),b((d(),_("button",Di,[...e[6]||(e[6]=[B("青",-1)])])),[[S]]),b((d(),_("button",Fi,[...e[7]||(e[7]=[B("赤",-1)])])),[[S]]),b((d(),_("button",Ui,[...e[8]||(e[8]=[B("緑",-1)])])),[[S]]),b((d(),_("button",Oi,[...e[9]||(e[9]=[B("黄",-1)])])),[[S]])])]),s("div",qi,[b((d(),_("button",Ni,[...e[10]||(e[10]=[B("1",-1)])])),[[S]]),b((d(),_("button",zi,[...e[11]||(e[11]=[B("2",-1)])])),[[S]]),b((d(),_("button",Wi,[...e[12]||(e[12]=[B("3",-1)])])),[[S]]),b((d(),_("button",ji,[...e[13]||(e[13]=[B("4",-1)])])),[[S]]),b((d(),_("button",Yi,[...e[14]||(e[14]=[B("5",-1)])])),[[S]]),b((d(),_("button",Ki,[...e[15]||(e[15]=[B("6",-1)])])),[[S]]),b((d(),_("button",Gi,[...e[16]||(e[16]=[B("7",-1)])])),[[S]]),b((d(),_("button",Zi,[...e[17]||(e[17]=[B("8",-1)])])),[[S]]),b((d(),_("button",Ji,[...e[18]||(e[18]=[B("9",-1)])])),[[S]]),b((d(),_("button",Xi,[...e[19]||(e[19]=[B("10",-1)])])),[[S]]),b((d(),_("button",Qi,[...e[20]||(e[20]=[B("11",-1)])])),[[S]]),b((d(),_("button",eo,[...e[21]||(e[21]=[B("12",-1)])])),[[S]])])])],2)}const so=W(Li,[["render",to],["__scopeId","data-v-87493572"]]),io=z({name:"Panel-SeriesTab",data(){return{Utils:Object.freeze(w)}},computed:{...re(U)}}),oo={class:"series-container"};function ao(t,e,o,i,a,l){return d(),_("div",oo," 鋭意実装中… ")}const no=W(io,[["render",ao],["__scopeId","data-v-6619a14a"]]),ro={class:"tab-content tab-content--capture"},lo={class:"zoom-capture-modal"},co=["src"],_o=["href","download"],uo={class:"captures"},mo=["onClick"],po=["src"],ho={class:"capture__selected-number"},fo=["onClick"],yo={class:"capture-announce"},go=z({__name:"Captures",setup(t){const e=U();function o(i){e.twitter_selected_capture_blobs.length<4&&i.selected===!1?(i.selected=!0,e.twitter_selected_capture_blobs.push(i.blob)):(e.twitter_selected_capture_blobs=e.twitter_selected_capture_blobs.filter(a=>a!==i.blob),i.selected=!1)}return(i,a)=>{const l=M("Icon");return d(),_("div",ro,[m(Je,{"content-class":"zoom-capture-modal-container","max-width":"980",transition:"slide-y-transition",modelValue:C(e).twitter_zoom_capture_modal,"onUpdate:modelValue":a[0]||(a[0]=r=>C(e).twitter_zoom_capture_modal=r)},{default:E(()=>[s("div",lo,[s("img",{class:"zoom-capture-modal__image",src:C(e).twitter_zoom_capture?C(e).twitter_zoom_capture.image_url:""},null,8,co),b((d(),_("a",{class:"zoom-capture-modal__download",href:C(e).twitter_zoom_capture?C(e).twitter_zoom_capture.image_url:"",download:C(e).twitter_zoom_capture?C(e).twitter_zoom_capture.filename:""},[m(l,{icon:"fa6-solid:download",width:"45px"})],8,_o)),[[S]])])]),_:1},8,["modelValue"]),s("div",uo,[(d(!0),_(J,null,ie(C(e).twitter_captures,r=>(d(),_("div",{class:T(["capture",{"capture--selected":r.selected,"capture--focused":r.focused,"capture--disabled":!r.selected&&C(e).twitter_selected_capture_blobs.length>=4}]),key:r.image_url,onClick:f=>o(r)},[s("img",{class:"capture__image",src:r.image_url},null,8,po),a[3]||(a[3]=s("div",{class:"capture__disabled-cover"},null,-1)),s("div",ho,$(C(e).twitter_selected_capture_blobs.findIndex(f=>f===r.blob)+1),1),a[4]||(a[4]=s("svg",{class:"capture__selected-checkmark iconify iconify--fluent",width:"1em",height:"1em",viewBox:"0 0 16 16"},[s("path",{fill:"currentColor",d:"M8 2a6 6 0 1 1 0 12A6 6 0 0 1 8 2Zm2.12 4.164L7.25 9.042L5.854 7.646a.5.5 0 1 0-.708.708l1.75 1.75a.5.5 0 0 0 .708 0l3.224-3.234a.5.5 0 0 0-.708-.706Z"})],-1)),a[5]||(a[5]=s("div",{class:"capture__selected-border"},null,-1)),a[6]||(a[6]=s("div",{class:"capture__focused-border"},null,-1)),b((d(),_("div",{class:"capture__zoom",onClick:Y(f=>{C(e).twitter_zoom_capture_modal=!0,C(e).twitter_zoom_capture=r},["prevent","stop"]),onMousedown:a[1]||(a[1]=Y(()=>{},["prevent","stop"]))},[...a[2]||(a[2]=[s("svg",{class:"iconify iconify--fluent",width:"32px",height:"32px",viewBox:"0 0 16 16"},[s("path",{fill:"currentColor",d:"M7 4.5a.5.5 0 0 0-1 0V6H4.5a.5.5 0 0 0 0 1H6v1.5a.5.5 0 0 0 1 0V7h1.5a.5.5 0 0 0 0-1H7V4.5ZM6.5 11a4.481 4.481 0 0 0 2.809-.984l3.837 3.838a.5.5 0 0 0 .708-.708L10.016 9.31A4.5 4.5 0 1 0 6.5 11Zm0-8a3.5 3.5 0 1 1 0 7a3.5 3.5 0 0 1 0-7Z"})],-1)])],40,fo)),[[S]])],10,mo))),128))]),b(s("div",yo,[...a[7]||(a[7]=[s("div",{class:"capture-announce__heading"},"まだキャプチャがありません。",-1),s("div",{class:"capture-announce__text"},[s("p",{class:"mt-0 mb-0"},"プレイヤーのキャプチャボタンやショートカットキーでキャプチャを撮ると、ここに表示されます。"),s("p",{class:"mt-2 mb-0"},"表示されたキャプチャを選択してからツイートすると、キャプチャを付けてツイートできます。")],-1)])],512),[[_e,C(e).twitter_captures.length===0]])])}}}),vo=W(go,[["__scopeId","data-v-f01f2092"]]),wo={key:0,class:"tweet__retweet-info"},bo={xmlns:"http://www.w3.org/2000/svg",width:"16.25px",height:"13px",viewBox:"0 0 640 512",style:{color:"rgb(var(--v-theme-success-lighten-1))"}},ko={class:"ml-2"},So=["href"],Co={class:"tweet__main-content"},$o=["href"],To=["src"],Lo={class:"tweet__content"},xo={class:"tweet__user-info"},Po={class:"tweet__user-info-left"},Io=["href"],Mo={class:"tweet__user-screen-name"},Ro={class:"tweet__timestamp"},Vo=["innerHTML"],Ho={key:0,class:"tweet__images"},Ao=["href"],Eo=["src"],Bo=["src"],Do=["href"],Fo={class:"tweet__quoted-user-info"},Uo={class:"tweet__quoted-user-name"},Oo={class:"tweet__quoted-user-screen-name"},qo=["innerHTML"],No={class:"tweet__actions"},zo=z({__name:"Tweet",props:{tweet:{}},setup(t){const e=t,o=Se(),{selected_twitter_account:i}=Me(o),a=N(e.tweet),l=de(()=>a.value.retweeted_tweet||a.value),r=y=>{const n=/(https?:\/\/[^\s]+)/g,p=/@(\w+)/g,L=/[#＃]([\w\p{Script=Hiragana}\p{Script=Katakana}\p{Script=Han}ー]+)/gu,P=[];let x=y.replace(n,A=>(P.push(A),`__URL_PLACEHOLDER_${P.length-1}__`));return x=x.replace(p,'<a class="tweet-link" href="https://x.com/$1" target="_blank">@$1</a>'),x=x.replace(L,'<a class="tweet-link" href="https://x.com/hashtag/$1" target="_blank">#$1</a>'),x=x.replace(/__URL_PLACEHOLDER_(\d+)__/g,(A,q)=>{const j=P[parseInt(q)];return`<a class="tweet-link" href="${j}" target="_blank">${j}</a>`}),x},f=de(()=>r(l.value.text)),v=de(()=>l.value.quoted_tweet?r(l.value.quoted_tweet.text):""),u=y=>{var p;if((p=window.getSelection())!=null&&p.toString())return;y.target.closest("a, button, video")||window.open(`https://x.com/${l.value.user.screen_name}/status/${l.value.id}`,"_blank")},h=async()=>{if(i.value)if(l.value.retweeted){const y=await ne.cancelRetweet(i.value.screen_name,l.value.id);y&&y.is_success&&(l.value.retweeted=!1,l.value.retweet_count--)}else{const y=await ne.retweet(i.value.screen_name,l.value.id);y&&y.is_success&&(l.value.retweeted=!0,l.value.retweet_count++)}},c=async()=>{if(i.value)if(l.value.favorited){const y=await ne.cancelFavorite(i.value.screen_name,l.value.id);y&&y.is_success&&(l.value.favorited=!1,l.value.favorite_count--)}else{const y=await ne.favorite(i.value.screen_name,l.value.id);y&&y.is_success&&(l.value.favorited=!0,l.value.favorite_count++)}};return(y,n)=>(d(),_("div",{class:"tweet",onClick:u},[a.value.retweeted_tweet?(d(),_("div",wo,[(d(),_("svg",bo,[...n[6]||(n[6]=[s("path",{fill:"currentColor",d:"M629.657 343.598L528.971 444.284c-9.373 9.372-24.568 9.372-33.941 0L394.343 343.598c-9.373-9.373-9.373-24.569 0-33.941l10.823-10.823c9.562-9.562 25.133-9.34 34.419.492L480 342.118V160H292.451a24.005 24.005 0 0 1-16.971-7.029l-16-16C244.361 121.851 255.069 96 276.451 96H520c13.255 0 24 10.745 24 24v222.118l40.416-42.792c9.285-9.831 24.856-10.054 34.419-.492l10.823 10.823c9.372 9.372 9.372 24.569-.001 33.941m-265.138 15.431A23.999 23.999 0 0 0 347.548 352H160V169.881l40.416 42.792c9.286 9.831 24.856 10.054 34.419.491l10.822-10.822c9.373-9.373 9.373-24.569 0-33.941L144.971 67.716c-9.373-9.373-24.569-9.373-33.941 0L10.343 168.402c-9.373 9.373-9.373 24.569 0 33.941l10.822 10.822c9.562 9.562 25.133 9.34 34.419-.491L96 169.881V392c0 13.255 10.745 24 24 24h243.549c21.382 0 32.09-25.851 16.971-40.971z"},null,-1)])])),s("span",ko,[s("a",{class:"tweet__retweet-info-link",href:`https://x.com/${a.value.user.screen_name}`,target:"_blank",onClick:n[0]||(n[0]=Y(()=>{},["stop"]))},$(a.value.user.name),9,So),n[7]||(n[7]=B("さんがリツイートしました",-1))])])):F("",!0),s("div",Co,[s("a",{class:"tweet__user-icon",href:`https://x.com/${l.value.user.screen_name}`,target:"_blank",onClick:n[1]||(n[1]=Y(()=>{},["stop"]))},[s("img",{src:l.value.user.icon_url,alt:"User Icon",class:"tweet__user-icon",loading:"lazy",decoding:"async"},null,8,To)],8,$o),s("div",Lo,[s("div",xo,[s("div",Po,[s("a",{class:"tweet__user-name",href:`https://x.com/${l.value.user.screen_name}`,target:"_blank",onClick:n[2]||(n[2]=Y(()=>{},["stop"]))},$(l.value.user.name),9,Io),s("span",Mo,"@"+$(l.value.user.screen_name),1)]),s("span",Ro,$(C(w).apply28HourClock(C(te)(l.value.created_at).format("MM/DD HH:mm:ss"))),1)]),s("p",{class:"tweet__text",innerHTML:f.value},null,8,Vo),l.value.image_urls&&l.value.image_urls.length>0?(d(),_("div",Ho,[(d(!0),_(J,null,ie(l.value.image_urls,(p,L)=>(d(),_("a",{key:L,href:p,target:"_blank",onClick:n[3]||(n[3]=Y(()=>{},["stop"]))},[s("img",{src:p,alt:"Tweet Image",class:"tweet__image",loading:"lazy",decoding:"async"},null,8,Eo)],8,Ao))),128))])):F("",!0),l.value.movie_url?(d(),_("video",{key:1,class:"tweet__movie",src:l.value.movie_url,controls:"",onClick:n[4]||(n[4]=Y(()=>{},["stop"]))},null,8,Bo)):F("",!0),l.value.quoted_tweet?(d(),_("a",{key:2,href:`https://x.com/${l.value.quoted_tweet.user.screen_name}/status/${l.value.quoted_tweet.id}`,target:"_blank",class:"tweet__quoted-tweet",onClick:n[5]||(n[5]=Y(()=>{},["stop"]))},[s("div",Fo,[s("span",Uo,$(l.value.quoted_tweet.user.name),1),s("span",Oo,"@"+$(l.value.quoted_tweet.user.screen_name),1)]),s("p",{class:"tweet__quoted-text",innerHTML:v.value},null,8,qo)],8,Do)):F("",!0),s("div",No,[b((d(),_("button",{class:T(["tweet__action tweet__action--retweet",{"tweet__action--active":l.value.retweeted}]),onClick:Y(h,["stop"])},[n[8]||(n[8]=s("svg",{xmlns:"http://www.w3.org/2000/svg",role:"img",width:"1.25em",height:"1em",viewBox:"0 0 640 512"},[s("path",{fill:"currentColor",d:"M629.657 343.598L528.971 444.284c-9.373 9.372-24.568 9.372-33.941 0L394.343 343.598c-9.373-9.373-9.373-24.569 0-33.941l10.823-10.823c9.562-9.562 25.133-9.34 34.419.492L480 342.118V160H292.451a24.005 24.005 0 0 1-16.971-7.029l-16-16C244.361 121.851 255.069 96 276.451 96H520c13.255 0 24 10.745 24 24v222.118l40.416-42.792c9.285-9.831 24.856-10.054 34.419-.492l10.823 10.823c9.372 9.372 9.372 24.569-.001 33.941m-265.138 15.431A23.999 23.999 0 0 0 347.548 352H160V169.881l40.416 42.792c9.286 9.831 24.856 10.054 34.419.491l10.822-10.822c9.373-9.373 9.373-24.569 0-33.941L144.971 67.716c-9.373-9.373-24.569-9.373-33.941 0L10.343 168.402c-9.373 9.373-9.373 24.569 0 33.941l10.822 10.822c9.562 9.562 25.133 9.34 34.419-.491L96 169.881V392c0 13.255 10.745 24 24 24h243.549c21.382 0 32.09-25.851 16.971-40.971z"})],-1)),s("span",null,$(l.value.retweet_count),1)],2)),[[S]]),b((d(),_("button",{class:T(["tweet__action tweet__action--favorite",{"tweet__action--active":l.value.favorited}]),onClick:Y(c,["stop"])},[n[9]||(n[9]=s("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",viewBox:"0 0 512 512"},[s("path",{fill:"currentColor",d:"M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9"})],-1)),s("span",null,$(l.value.favorite_count),1)],2)),[[S]])])])])]))}}),Xe=W(zo,[["__scopeId","data-v-1dddf994"]]),Wo={class:"tab-content tab-content--search"},jo={class:"search-header"},Yo={class:"d-flex align-center ml-auto h-100"},Ko={key:0,class:"search-settings"},Go={class:"search-item"},Zo=["onClick","disabled"],Jo={class:"load-more-button__content"},Xo={class:"search-announce"},Qo=z({__name:"Search",setup(t){const e=Se(),{selected_twitter_account:o}=Me(e),i=N([]),a=N(!1),l=N(!1),r=N(!1),f=N(!1),v=N(""),u=Ge("scroller"),h=N([]),c=de(()=>{const V=[];for(const R of i.value)R.type==="tweet_block"?V.push(...R.tweets):V.push(R);return V}),y=N(!1),n=async()=>{if(u.value){y.value=!0;const V=u.value.scrollOffset,R=u.value.viewportSize;if(V<0||V>R*2){y.value=!1;return}u.value.scrollToIndex(V+R*2),await w.sleep(.02),u.value.scrollToIndex(V),y.value=!1}},p=()=>{const V=new Set;for(const R of i.value)if(R.type==="tweet_block")for(const k of R.tweets)V.add(k.id);return V},L=(V,R)=>V.filter(k=>!R.has(k.id)),P=()=>{a.value=!a.value},x=V=>{V.key==="Enter"&&V.isComposing===!1&&A()},A=async()=>{if(r.value)return;if(!v.value.trim()){ge.warning("検索キーワードを入力してください。");return}if(r.value=!0,await ce().fetchUser(),!o.value){ge.warning("ツイートを検索するには、Twitter アカウントと連携してください。"),i.value=[],r.value=!1;return}let V;h.value.length>=2&&(V=h.value[h.value.length-2]);const R=`${v.value}${l.value?"include:nativeretweets":""}`,k=await ne.searchTweets(o.value.screen_name,R,V);if(k&&k.tweets){l.value===!1&&(k.tweets=k.tweets.filter(X=>!X.retweeted_tweet));const g=p(),I=L(k.tweets,g);I.length>0&&k.next_cursor_id&&(h.value.push(k.next_cursor_id),h.value.length>10&&h.value.shift());const O={type:"tweet_block",tweets:I,id:`block_${Date.now()}`,next_cursor_id:k.next_cursor_id,previous_cursor_id:k.previous_cursor_id};i.value.length>0&&I.length===k.tweets.length?i.value=[O,{type:"load_more",cursor_id:k.previous_cursor_id,id:`load_more_${k.previous_cursor_id}`},...i.value]:i.value=[O,...i.value];const D=i.value[i.value.length-1];k.previous_cursor_id&&(!D||D.type==="tweet_block")&&i.value.push({type:"load_more",cursor_id:k.previous_cursor_id,id:`load_more_${k.previous_cursor_id}`}),n()}r.value=!1},q=async V=>{if(r.value)return;if(r.value=!0,!o.value){console.warn("selected_twitter_account is null"),r.value=!1;return}const R=`${v.value}${l.value?"include:nativeretweets":""}`,k=await ne.searchTweets(o.value.screen_name,R,V.cursor_id);if(k&&k.tweets){l.value===!1&&(k.tweets=k.tweets.filter(ee=>!ee.retweeted_tweet));const g=p(),I=L(k.tweets,g),O=i.value.findIndex(ee=>ee.type==="load_more"&&ee===V);if(O===-1){r.value=!1;return}const X=[{type:"tweet_block",tweets:I,id:`block_${Date.now()}`,next_cursor_id:k.next_cursor_id,previous_cursor_id:k.previous_cursor_id}];k.previous_cursor_id&&I.length===k.tweets.length&&X.push({type:"load_more",cursor_id:k.previous_cursor_id,id:`load_more_${k.previous_cursor_id}`}),i.value.splice(O,1,...X);const le=i.value[i.value.length-1];k.previous_cursor_id&&le.type==="tweet_block"&&i.value.push({type:"load_more",cursor_id:k.previous_cursor_id,id:`load_more_${k.previous_cursor_id}`})}r.value=!1};se(v,()=>{i.value=[],h.value=[]}),se(l,()=>{i.value=[],h.value=[],A()});const j=()=>{if(!u.value||!u.value.$el||r.value||y.value)return;const V=u.value.$el,R=V.scrollTop,k=V.scrollHeight,g=V.clientHeight;if(k-R-g<30){const I=i.value[i.value.length-1];I&&I.type==="load_more"&&q(I)}};return Ze(()=>{Pe(()=>{u.value&&u.value.$el&&u.value.$el.addEventListener("scroll",j)})}),(V,R)=>{const k=M("Icon"),g=Re("ftooltip");return d(),_("div",Wo,[s("div",jo,[s("div",{class:T(["search-input-wrapper",{"search-input-wrapper--focused":f.value}])},[m(k,{icon:"fluent:search-16-filled",height:"18px"}),b(s("input",{"onUpdate:modelValue":R[0]||(R[0]=I=>v.value=I),class:"search-input",type:"search",enterkeyhint:"search",placeholder:"検索キーワードを入力",onKeydown:R[1]||(R[1]=I=>x(I)),onFocus:R[2]||(R[2]=I=>f.value=!0),onBlur:R[3]||(R[3]=I=>f.value=!1)},null,544),[[he,v.value]])],2),s("div",Yo,[b((d(),_("button",{class:"search-header__settings",onClick:P},[m(k,{icon:"fluent:settings-16-filled",width:"20"})])),[[S]]),b((d(),_("button",{class:"search-header__refresh",style:{color:"rgb(var(--v-theme-twitter-lighten-1))"},onClick:A},[m(k,{icon:"ic:round-refresh",width:"20",class:T(r.value?"animate-spin":"")},null,8,["class"])])),[[S],[g,"検索結果を更新",void 0,{bottom:!0}]])])]),a.value?(d(),_("div",Ko,[m(be,{id:"show_retweets",color:"primary",density:"compact","hide-details":"",modelValue:l.value,"onUpdate:modelValue":R[4]||(R[4]=I=>l.value=I)},null,8,["modelValue"]),R[5]||(R[5]=s("label",{class:"ml-4 cursor-pointer",for:"show_retweets"},"リツイートを表示する",-1))])):F("",!0),b(m(C(He),{ref_key:"scroller",ref:u,class:"search-tweets",data:c.value},{default:E(({item:I})=>[s("div",Go,["text"in I?(d(),K(Xe,{key:0,tweet:I},null,8,["tweet"])):(d(),_("button",{key:1,class:"load-more-button",onClick:O=>q(I),disabled:r.value},[s("div",Jo,[m(k,{icon:"ic:round-refresh",width:"20",class:T([r.value?"animate-spin":"","mr-2"])},null,8,["class"]),R[6]||(R[6]=B(" ツイートをさらに表示 ",-1))])],8,Zo))])]),_:1},8,["data"]),[[_e,c.value.length>0]]),b(s("div",Xo,[...R[7]||(R[7]=[s("div",{class:"search-announce__heading"},"まだツイートがありません。",-1),s("div",{class:"search-announce__text"},[s("p",{class:"mt-0 mb-0"},[B("右上の更新ボタンを押すと、最新の"),s("br"),B("ツイート検索結果を時系列で表示できます。")])],-1)])],512),[[_e,c.value.length===0]])])}}}),ea=W(Qo,[["__scopeId","data-v-f5629d85"]]),ta={class:"tab-content tab-content--timeline"},sa={class:"timeline-header"},ia={class:"d-flex align-center ml-auto h-100"},oa={key:0,class:"timeline-settings"},aa={class:"timeline-settings__item"},na={class:"timeline-settings__item"},ra={class:"timeline-item"},la=["onClick","disabled"],ca={class:"load-more-button__content"},da={class:"timeline-announce"},_a={class:"timeline-announce__heading"},ua={class:"timeline-announce__text"},ma={key:0,class:"mt-0 mb-0"},pa={key:1,class:"mt-0 mb-0"},ha=z({__name:"Timeline",setup(t){const e=Se(),{selected_twitter_account:o}=Me(e),i=N([]),a=N(!1),l=N(!0),r=N(!1),f=Ge("scroller"),v=N([]),u=N(""),h=N(!1),c=N(!1),y=N(!1);se([u,c],async()=>{y.value=!0,await Pe(),y.value=!1});const n=de(()=>{if(y.value)return[];const k=[];for(const g of i.value)if(g.type==="tweet_block"){const I=u.value?g.tweets.filter(O=>{const X=(O.retweeted_tweet?O.retweeted_tweet.text:O.text).toLowerCase().includes(u.value.toLowerCase());return c.value?!X:X}):g.tweets;k.push(...I)}else k.push(g);return u.value&&!k.some(g=>"text"in g)?[]:k}),p=N(!1),L=async()=>{if(f.value){p.value=!0;const k=f.value.scrollOffset,g=f.value.viewportSize;if(k<0||k>g*2){p.value=!1;return}f.value.scrollToIndex(k+g*2),await w.sleep(.02),f.value.scrollToIndex(k),p.value=!1}},P=()=>{const k=new Set;for(const g of i.value)if(g.type==="tweet_block")for(const I of g.tweets)k.add(I.id);return k},x=(k,g)=>k.filter(I=>!g.has(I.id)),A=()=>{a.value=!a.value};let q=!1;const j=async()=>{if(r.value)return;if(r.value=!0,await ce().fetchUser(),!o.value){q&&ge.warning("タイムラインを更新するには、Twitter アカウントと連携してください。"),i.value=[],r.value=!1,q=!0;return}q=!0;let k;v.value.length>=2&&(k=v.value[v.value.length-2]);const g=await ne.getHomeTimeline(o.value.screen_name,k);if(g&&g.tweets){g.tweets=g.tweets.filter(le=>{var ae;let ee=!0;return l.value===!1&&(ee=!le.retweeted_tweet),le.retweeted_tweet!==null&&le.user.screen_name===((ae=o.value)==null?void 0:ae.screen_name)&&(ee=!1),ee});const I=P(),O=x(g.tweets,I);O.length>0&&g.next_cursor_id&&(v.value.push(g.next_cursor_id),v.value.length>10&&v.value.shift());const D={type:"tweet_block",tweets:O,id:`block_${Date.now()}`,next_cursor_id:g.next_cursor_id,previous_cursor_id:g.previous_cursor_id};i.value.length>0&&O.length===g.tweets.length?i.value=[D,{type:"load_more",cursor_id:g.previous_cursor_id,id:`load_more_${g.previous_cursor_id}`},...i.value]:i.value=[D,...i.value];const X=i.value[i.value.length-1];g.previous_cursor_id&&(!X||X.type==="tweet_block")&&i.value.push({type:"load_more",cursor_id:g.previous_cursor_id,id:`load_more_${g.previous_cursor_id}`}),L()}r.value=!1},V=async k=>{if(r.value)return;if(r.value=!0,!o.value){console.warn("selected_twitter_account is null"),r.value=!1;return}const g=await ne.getHomeTimeline(o.value.screen_name,k.cursor_id);if(g&&g.tweets){g.tweets=g.tweets.filter(ae=>{var Ae;let Ce=!0;return l.value===!1&&(Ce=!ae.retweeted_tweet),ae.retweeted_tweet!==null&&ae.user.screen_name===((Ae=o.value)==null?void 0:Ae.screen_name)&&(Ce=!1),Ce});const I=P(),O=x(g.tweets,I),D=i.value.findIndex(ae=>ae.type==="load_more"&&ae===k);if(D===-1){r.value=!1;return}const le=[{type:"tweet_block",tweets:O,id:`block_${Date.now()}`,next_cursor_id:g.next_cursor_id,previous_cursor_id:g.previous_cursor_id}];g.previous_cursor_id&&O.length===g.tweets.length&&le.push({type:"load_more",cursor_id:g.previous_cursor_id,id:`load_more_${g.previous_cursor_id}`}),i.value.splice(D,1,...le);const ee=i.value[i.value.length-1];g.previous_cursor_id&&ee.type==="tweet_block"&&i.value.push({type:"load_more",cursor_id:g.previous_cursor_id,id:`load_more_${g.previous_cursor_id}`})}r.value=!1};se(o,()=>{i.value=[],v.value=[],j()}),se(l,()=>{i.value=[],v.value=[],j()});const R=()=>{if(!f.value||!f.value.$el||r.value||p.value)return;const k=f.value.$el,g=k.scrollTop,I=k.scrollHeight,O=k.clientHeight;if(I-g-O<30){const D=i.value[i.value.length-1];D&&D.type==="load_more"&&V(D)}};return Ze(()=>{j(),Pe(()=>{f.value&&f.value.$el&&f.value.$el.addEventListener("scroll",R)})}),(k,g)=>{const I=M("Icon"),O=Re("ftooltip");return d(),_("div",ta,[s("div",sa,[s("div",{class:T(["search-input-wrapper",{"search-input-wrapper--focused":h.value}])},[m(I,{icon:"fluent:filter-16-filled",height:"18px"}),b(s("input",{"onUpdate:modelValue":g[0]||(g[0]=D=>u.value=D),class:"search-input",type:"search",enterkeyhint:"search",placeholder:"タイムラインを絞り込む",onFocus:g[1]||(g[1]=D=>h.value=!0),onBlur:g[2]||(g[2]=D=>h.value=!1)},null,544),[[he,u.value]])],2),s("div",ia,[b((d(),_("button",{class:"timeline-header__settings",onClick:A},[m(I,{icon:"fluent:settings-16-filled",width:"20"})])),[[S]]),b((d(),_("button",{class:"timeline-header__refresh",style:{color:"rgb(var(--v-theme-twitter-lighten-1))"},onClick:j},[m(I,{icon:"ic:round-refresh",width:"20",class:T(r.value?"animate-spin":"")},null,8,["class"])])),[[S],[O,"タイムラインを更新",void 0,{bottom:!0}]])])]),a.value?(d(),_("div",oa,[s("div",aa,[m(be,{id:"show_retweets",color:"primary",density:"compact","hide-details":"",modelValue:l.value,"onUpdate:modelValue":g[3]||(g[3]=D=>l.value=D)},null,8,["modelValue"]),g[5]||(g[5]=s("label",{class:"ml-4 cursor-pointer",for:"show_retweets"},"リツイートを表示する",-1))]),s("div",na,[m(be,{id:"is_not_filter",color:"primary",density:"compact","hide-details":"",modelValue:c.value,"onUpdate:modelValue":g[4]||(g[4]=D=>c.value=D)},null,8,["modelValue"]),g[6]||(g[6]=s("label",{class:"ml-4 cursor-pointer",for:"is_not_filter"},"指定文字列を含まないツイートを表示",-1))])])):F("",!0),b(m(C(He),{ref_key:"scroller",ref:f,class:"timeline-tweets",data:n.value},{default:E(({item:D})=>[s("div",ra,["text"in D?(d(),K(Xe,{key:0,tweet:D},null,8,["tweet"])):(d(),_("button",{key:1,class:"load-more-button",onClick:X=>V(D),disabled:r.value},[s("div",ca,[m(I,{icon:"ic:round-refresh",width:"20",class:T([r.value?"animate-spin":"","mr-2"])},null,8,["class"]),g[7]||(g[7]=B(" ツイートをさらに表示 ",-1))])],8,la))])]),_:1},8,["data"]),[[_e,n.value.length>0]]),b(s("div",da,[s("div",_a,$(u.value?"絞り込み条件に一致するツイートがありません。":"まだツイートがありません。"),1),s("div",ua,[u.value?(d(),_("p",ma,[...g[8]||(g[8]=[B(" 絞り込み条件を変更するか、右上の更新ボタンを",-1),s("br",null,null,-1),B("押して、タイムラインを更新してください。 ",-1)])])):(d(),_("p",pa,[...g[9]||(g[9]=[B(" 右上の更新ボタンを押すと、最新の",-1),s("br",null,null,-1),B("ホームタイムラインを時系列で表示できます。 ",-1)])]))])],512),[[_e,n.value.length===0]])])}}}),fa=W(ha,[["__scopeId","data-v-8b25a0d4"]]),ya=z({name:"Panel-TwitterTab",components:{draggable:Lt,TwitterCaptures:vo,TwitterSearch:ea,TwitterTimeline:fa},props:{playback_mode:{type:String,required:!0}},data(){return{Utils:Object.freeze(w),is_twitter_account_list_display:!1,saved_twitter_hashtags:Z().settings.saved_twitter_hashtags.map((t,e)=>({id:w.time()+e,text:t,editing:!1})),is_hashtag_list_display:!1,captures_element:null,is_tweet_hashtag_form_focused:!1,is_tweet_text_form_focused:!1,tweet_hashtag:"",tweet_text:"",tweet_letter_remain_count:140,is_tweet_sending:!1}},computed:{...re(oe,U,Z,ce,Se),is_tweet_button_disabled(){return this.twitterStore.is_logged_in_twitter===!1||this.tweet_letter_remain_count<0||(this.tweet_text.trim()===""||this.tweet_letter_remain_count===140)&&this.playerStore.twitter_selected_capture_blobs.length===0}},watch:{"channelsStore.channel.current.name":{handler(t,e){if(this.playback_mode==="Live"){const o=ve.getChannelHashtag(e)??"";this.tweet_hashtag=this.formatHashtag(this.tweet_hashtag.replaceAll(o,"")),this.updateTweetLetterCount(),this.settingsStore.settings.reset_hashtag_when_program_switches===!0&&(this.tweet_hashtag=this.formatHashtag(""),this.updateTweetLetterCount())}}},"channelsStore.channel.current.program_present":{deep:!0,handler(t,e){this.playback_mode==="Live"&&(t==null?void 0:t.id)!==(e==null?void 0:e.id)&&this.settingsStore.settings.reset_hashtag_when_program_switches===!0&&(this.tweet_hashtag=this.formatHashtag(""),this.updateTweetLetterCount())}},saved_twitter_hashtags:{deep:!0,handler(){this.settingsStore.settings.saved_twitter_hashtags=this.saved_twitter_hashtags.map(t=>t.text)}}},async created(){await this.userStore.fetchUser(),await this.twitterStore.update(),this.tweet_hashtag=this.formatHashtag(this.tweet_hashtag),this.updateTweetLetterCount(),this.playerStore.event_emitter.on("CaptureCompleted",async t=>{this.addCaptureList(t.capture,t.filename)})},beforeUnmount(){for(const t of this.playerStore.twitter_captures)URL.revokeObjectURL(t.image_url);this.playerStore.event_emitter.off("CaptureCompleted")},methods:{updateTweetLetterCount(){this.tweet_letter_remain_count=140-[...this.tweet_hashtag].length-[...this.tweet_text].length},pasteClipboardData(t){if(t.clipboardData!==null){for(const e of t.clipboardData.items)if(e.type.startsWith("image/")){const o=e.getAsFile();o&&this.addCaptureList(o,o.name)}}},clickHashtagListButton(){this.is_hashtag_list_display=!this.is_hashtag_list_display;for(const t of this.saved_twitter_hashtags)t.editing=!1},clickHashtag(t){this.tweet_hashtag=t.text,this.tweet_hashtag=this.formatHashtag(this.tweet_hashtag),this.updateTweetLetterCount(),window.setTimeout(()=>this.is_hashtag_list_display=!1,150)},clickAccountButton(){if(!this.twitterStore.is_logged_in_twitter){document.fullscreenElement&&document.exitFullscreen(),this.$router.push({path:"/settings/twitter"});return}this.is_twitter_account_list_display=!this.is_twitter_account_list_display,this.is_twitter_account_list_display===!0&&(this.is_hashtag_list_display=!1)},updateSelectedTwitterAccount(t){this.settingsStore.settings.selected_twitter_account_id=t.id,this.twitterStore.selected_twitter_account=t,this.twitterStore.initChallengeSolverIframe(t.screen_name),window.setTimeout(()=>this.is_twitter_account_list_display=!1,150)},addCaptureList(t,e){this.captures_element===null&&(this.captures_element=document.querySelector(".tab-content--capture")),this.playerStore.twitter_captures.length>100&&(URL.revokeObjectURL(this.playerStore.twitter_captures[0].image_url),this.playerStore.twitter_selected_capture_blobs=this.playerStore.twitter_selected_capture_blobs.filter(i=>i!==this.playerStore.twitter_captures[0].blob),this.playerStore.twitter_captures.shift());const o=URL.createObjectURL(t);this.playerStore.twitter_captures.push({blob:t,filename:e,image_url:o,selected:!1,focused:!1}),this.$nextTick(()=>{this.captures_element!==null&&this.captures_element.scrollTo({top:this.captures_element.scrollHeight,behavior:"smooth"})})},async drawProgramTitleOnCapture(t){var l;const e=await createImageBitmap(t),o="OffscreenCanvas"in window?new OffscreenCanvas(e.width,e.height):document.createElement("canvas"),i=o.getContext("2d",{alpha:!1,desynchronized:!0,willReadFrequently:!1});i.drawImage(e,0,0),e.close(),i.font='bold 22px "Open Sans", "YakuHanJPs", "Twemoji", "Hiragino Sans", "Noto Sans JP", sans-serif',i.fillStyle="rgba(255, 255, 255, 70%)",i.shadowColor="rgba(0, 0, 0, 100%)",i.shadowBlur=4,i.shadowOffsetX=0,i.shadowOffsetY=0;let a;switch(this.playback_mode==="Live"?a=((l=this.channelsStore.channel.current.program_present)==null?void 0:l.title)??"放送休止":a=this.playerStore.recorded_program.title,this.settingsStore.settings.tweet_capture_watermark_position){case"TopLeft":{i.textAlign="left",i.textBaseline="top",i.fillText(a,16,12);break}case"TopRight":{i.textAlign="right",i.textBaseline="top",i.fillText(a,o.width-16,12);break}case"BottomLeft":{i.textAlign="left",i.textBaseline="bottom",i.fillText(a,16,o.height-12);break}case"BottomRight":{i.textAlign="right",i.textBaseline="bottom",i.fillText(a,o.width-16,o.height-12);break}}return o instanceof OffscreenCanvas?await o.convertToBlob({type:"image/jpeg",quality:1}):new Promise((r,f)=>o.toBlob(v=>{v===null?f():r(v)},"image/jpeg",1))},formatHashtag(t,e=!1){const o=t.trim().replaceAll("♯","#").replaceAll("＃","#").replace(/#{2,}/g,"#").replaceAll("　"," ").replaceAll(/ +/g," ").split(" ").filter(i=>i!=="");for(let i in o)o[i].startsWith("#")||(o[i]=`#${o[i]}`);if(this.playback_mode==="Live"&&this.settingsStore.settings.auto_add_watching_channel_hashtag===!0&&e===!1){const i=ve.getChannelHashtag(this.channelsStore.channel.current.name);i!==null&&o.includes(i)===!1&&o.push(i)}return o.join(" ")},async sendTweet(){if(this.is_tweet_button_disabled===!0||this.twitterStore.selected_twitter_account===null||this.is_tweet_sending===!0)return;this.is_tweet_sending=!0,this.tweet_hashtag=this.formatHashtag(this.tweet_hashtag);const t=this.tweet_hashtag;this.updateTweetLetterCount();let e=this.tweet_text;if(t!=="")switch(this.settingsStore.settings.tweet_hashtag_position){case"Prepend":{e=`${t} ${this.tweet_text}`;break}case"Append":{e=`${this.tweet_text} ${t}`;break}case"PrependWithLineBreak":{e=`${t}
${this.tweet_text}`;break}case"AppendWithLineBreak":{e=`${this.tweet_text}
${t}`;break}}const o=[];for(let i of this.playerStore.twitter_selected_capture_blobs)this.settingsStore.settings.tweet_capture_watermark_position!=="None"&&(i=await this.drawProgramTitleOnCapture(i)),o.push(i);this.tweet_text="",this.updateTweetLetterCount();for(const i of this.playerStore.twitter_captures)i.selected=!1,i.focused=!1;this.playerStore.twitter_selected_capture_blobs=[],ne.sendTweet(this.twitterStore.selected_twitter_account.screen_name,e,o).then(i=>{this.playerStore.event_emitter.emit("SendNotification",{message:i.message,color:i.is_error?"#FF6F6A":void 0})}),this.is_tweet_sending=!1,this.settingsStore.settings.fold_panel_after_sending_tweet===!0&&(this.playerStore.is_panel_display=!1,this.$refs.tweet_text.blur())}}}),ga={class:"twitter-container"},va={class:"tab-container"},wa={class:"tab-button-container"},ba={class:"tweet-form__hashtag"},ka={class:"tweet-form__control"},Sa=["src"],Ca={class:"account-button__screen-name"},$a={class:"limit-meter"},Ta={class:"limit-meter__content"},La=["disabled"],xa={class:"hashtag-heading"},Pa={class:"hashtag-heading__text"},Ia=["onClick"],Ma=["onUpdate:modelValue","disabled"],Ra=["onClick"],Va={key:0,class:"iconify iconify--fluent",width:"17px",height:"17px",viewBox:"0 0 16 16"},Ha={key:1,class:"iconify iconify--fluent",width:"17px",height:"17px",viewBox:"0 0 16 16"},Aa=["onClick"],Ea=["onClick"],Ba=["src"],Da={class:"twitter-account__info"},Fa={class:"twitter-account__name"},Ua={class:"twitter-account__screen-name"},Oa={class:"twitter-account__check iconify iconify--fluent",width:"24px",height:"24px",viewBox:"0 0 16 16"};function qa(t,e,o,i,a,l){var c,y;const r=M("TwitterSearch"),f=M("TwitterTimeline"),v=M("TwitterCaptures"),u=M("Icon"),h=M("draggable");return d(),_("div",ga,[s("div",va,[m(r,{class:T({"tab-content--active":t.playerStore.twitter_active_tab==="Search"})},null,8,["class"]),m(f,{class:T({"tab-content--active":t.playerStore.twitter_active_tab==="Timeline"})},null,8,["class"]),m(v,{class:T({"tab-content--active":t.playerStore.twitter_active_tab==="Capture"})},null,8,["class"])]),s("div",wa,[b((d(),_("div",{class:T(["tab-button",{"tab-button--active":t.playerStore.twitter_active_tab==="Search"}]),onClick:e[0]||(e[0]=n=>t.playerStore.twitter_active_tab="Search")},[m(u,{icon:"fluent:search-16-filled",height:"18px"}),e[20]||(e[20]=s("span",{class:"tab-button__text"},"ツイート検索",-1))],2)),[[S]]),b((d(),_("div",{class:T(["tab-button",{"tab-button--active":t.playerStore.twitter_active_tab==="Timeline"}]),onClick:e[1]||(e[1]=n=>t.playerStore.twitter_active_tab="Timeline")},[m(u,{icon:"fluent:home-16-regular",height:"18px"}),e[21]||(e[21]=s("span",{class:"tab-button__text"},"タイムライン",-1))],2)),[[S]]),b((d(),_("div",{class:T(["tab-button",{"tab-button--active":t.playerStore.twitter_active_tab==="Capture"}]),onClick:e[2]||(e[2]=n=>t.playerStore.twitter_active_tab="Capture")},[m(u,{icon:"fluent:image-copy-20-regular",height:"18px"}),e[22]||(e[22]=s("span",{class:"tab-button__text"},"キャプチャ",-1))],2)),[[S]])]),s("div",{class:T(["tweet-form",{"tweet-form--focused":t.is_tweet_hashtag_form_focused||t.is_tweet_text_form_focused,"tweet-form--virtual-keyboard-display":t.playerStore.is_virtual_keyboard_display&&(t.Utils.hasActiveElementClass("tweet-form__hashtag-form")||t.Utils.hasActiveElementClass("tweet-form__textarea"))&&(t.is_hashtag_list_display=!1,!0)}])},[s("div",ba,[b(s("input",{class:"tweet-form__hashtag-form",type:"search",enterkeyhint:"done",placeholder:"#ハッシュタグ",spellcheck:"false","onUpdate:modelValue":e[3]||(e[3]=n=>t.tweet_hashtag=n),onInput:e[4]||(e[4]=n=>t.updateTweetLetterCount()),onFocus:e[5]||(e[5]=n=>t.is_tweet_hashtag_form_focused=!0),onBlur:e[6]||(e[6]=n=>t.is_tweet_hashtag_form_focused=!1),onChange:e[7]||(e[7]=n=>{t.tweet_hashtag=t.formatHashtag(t.tweet_hashtag),t.updateTweetLetterCount()})},null,544),[[he,t.tweet_hashtag]]),b((d(),_("div",{class:"tweet-form__hashtag-list-button",onClick:e[8]||(e[8]=n=>t.clickHashtagListButton())},[m(u,{icon:"fluent:clipboard-text-ltr-32-regular",height:"22px"})])),[[S]])]),b(s("textarea",{class:"tweet-form__textarea",enterkeyhint:"enter",placeholder:"ツイート",spellcheck:"false","onUpdate:modelValue":e[9]||(e[9]=n=>t.tweet_text=n),ref:"tweet_text",onInput:e[10]||(e[10]=n=>t.updateTweetLetterCount()),onPaste:e[11]||(e[11]=n=>t.pasteClipboardData(n)),onFocus:e[12]||(e[12]=n=>t.is_tweet_text_form_focused=!0),onBlur:e[13]||(e[13]=n=>t.is_tweet_text_form_focused=!1)},"            ",544),[[he,t.tweet_text]]),s("div",ka,[b((d(),_("div",{class:T(["account-button",{"account-button--no-login":!t.twitterStore.is_logged_in_twitter}]),onClick:e[14]||(e[14]=n=>t.clickAccountButton())},[s("img",{class:"account-button__icon",src:t.twitterStore.is_logged_in_twitter?(c=t.twitterStore.selected_twitter_account)==null?void 0:c.icon_url:"/assets/images/account-icon-default.png"},null,8,Sa),s("span",Ca,$(t.twitterStore.is_logged_in_twitter?`@${(y=t.twitterStore.selected_twitter_account)==null?void 0:y.screen_name}`:"連携されていません"),1),m(u,{class:"account-button__menu",icon:"fluent:more-circle-20-regular",width:"22px"})],2)),[[S]]),s("div",$a,[s("div",{class:T(["limit-meter__content",{"limit-meter__content--yellow":t.tweet_letter_remain_count<=20,"limit-meter__content--red":t.tweet_letter_remain_count<=0}])},[m(u,{icon:"fa-brands:twitter",width:"12px",style:{"margin-right":"-2px"}}),s("span",null,$(t.tweet_letter_remain_count),1)],2),s("div",Ta,[m(u,{icon:"fluent:image-16-filled",width:"14px"}),s("span",null,$(t.playerStore.twitter_selected_capture_blobs.length)+"/4",1)])]),b((d(),_("button",{class:"tweet-button",disabled:t.is_tweet_button_disabled,onClick:e[15]||(e[15]=n=>t.sendTweet()),onTouchstart:e[16]||(e[16]=n=>t.sendTweet())},[m(u,{icon:"fa-brands:twitter",height:"16px"}),e[23]||(e[23]=s("span",{class:"ml-1"},"ツイート",-1))],40,La)),[[S,t.Utils.isTouchDevice()===!1]])])],2),s("div",{class:T(["hashtag-list",{"hashtag-list--display":t.is_hashtag_list_display,"hashtag-list--virtual-keyboard-display":t.playerStore.is_virtual_keyboard_display&&t.Utils.hasActiveElementClass("hashtag__input")}])},[s("div",xa,[s("div",Pa,[m(u,{icon:"charm:hash",width:"17px"}),e[24]||(e[24]=s("span",{class:"ml-1"},"ハッシュタグリスト",-1))]),b((d(),_("button",{class:"hashtag-heading__add-button",onClick:e[17]||(e[17]=n=>t.saved_twitter_hashtags.push({id:t.Utils.time(),text:"#ここにハッシュタグを入力",editing:!1}))},[m(u,{icon:"fluent:add-12-filled",width:"17px"}),e[25]||(e[25]=s("span",{class:"ml-1"},"追加",-1))])),[[S]])]),m(h,{class:"hashtag-container",handle:".hashtag__sort-handle","item-key":"id",modelValue:t.saved_twitter_hashtags,"onUpdate:modelValue":e[19]||(e[19]=n=>t.saved_twitter_hashtags=n)},{item:E(({element:n})=>[b((d(),_("div",{class:T(["hashtag",{"hashtag--editing":n.editing}]),onClick:p=>t.clickHashtag(n)},[b(s("input",{type:"search",enterkeyhint:"done",class:"hashtag__input",spellcheck:"false","onUpdate:modelValue":p=>n.text=p,disabled:!n.editing,onClick:e[18]||(e[18]=Y(()=>{},["stop"]))},null,8,Ma),[[he,n.text]]),b((d(),_("button",{class:"hashtag__edit-button",onClick:Y(p=>{n.editing=!n.editing,n.text=t.formatHashtag(n.text,!0),t.updateTweetLetterCount()},["prevent","stop"])},[n.editing===!1?(d(),_("svg",Va,[...e[26]||(e[26]=[s("path",{fill:"currentColor",d:"M10.529 1.764a2.621 2.621 0 1 1 3.707 3.707l-.779.779L9.75 2.543l.779-.779ZM9.043 3.25L2.657 9.636a2.955 2.955 0 0 0-.772 1.354l-.87 3.386a.5.5 0 0 0 .61.608l3.385-.869a2.95 2.95 0 0 0 1.354-.772l6.386-6.386L9.043 3.25Z"},null,-1)])])):F("",!0),n.editing===!0?(d(),_("svg",Ha,[...e[27]||(e[27]=[s("path",{fill:"currentColor",d:"M14.046 3.486a.75.75 0 0 1-.032 1.06l-7.93 7.474a.85.85 0 0 1-1.188-.022l-2.68-2.72a.75.75 0 1 1 1.068-1.053l2.234 2.267l7.468-7.038a.75.75 0 0 1 1.06.032Z"},null,-1)])])):F("",!0)],8,Ra)),[[S]]),b((d(),_("button",{class:"hashtag__delete-button",onClick:Y(p=>t.saved_twitter_hashtags.splice(t.saved_twitter_hashtags.indexOf(n),1),["prevent","stop"])},[...e[28]||(e[28]=[s("svg",{class:"iconify iconify--fluent",width:"17px",height:"17px",viewBox:"0 0 16 16"},[s("path",{fill:"currentColor",d:"M7 3h2a1 1 0 0 0-2 0ZM6 3a2 2 0 1 1 4 0h4a.5.5 0 0 1 0 1h-.564l-1.205 8.838A2.5 2.5 0 0 1 9.754 15H6.246a2.5 2.5 0 0 1-2.477-2.162L2.564 4H2a.5.5 0 0 1 0-1h4Zm1 3.5a.5.5 0 0 0-1 0v5a.5.5 0 0 0 1 0v-5ZM9.5 6a.5.5 0 0 0-.5.5v5a.5.5 0 0 0 1 0v-5a.5.5 0 0 0-.5-.5Z"})],-1)])],8,Aa)),[[S]]),e[29]||(e[29]=s("div",{class:"hashtag__sort-handle"},[s("svg",{class:"iconify iconify--material-symbols",width:"17px",height:"17px",viewBox:"0 0 24 24"},[s("path",{fill:"currentColor",d:"M5 15q-.425 0-.713-.288T4 14q0-.425.288-.713T5 13h14q.425 0 .713.288T20 14q0 .425-.288.713T19 15H5Zm0-4q-.425 0-.713-.288T4 10q0-.425.288-.713T5 9h14q.425 0 .713.288T20 10q0 .425-.288.713T19 11H5Z"})])],-1))],10,Ia)),[[S,!n.editing]])]),_:1},8,["modelValue"])],2),s("div",{class:T(["twitter-account-list",{"twitter-account-list--display":t.is_twitter_account_list_display}])},[(d(!0),_(J,null,ie(t.userStore.user?t.userStore.user.twitter_accounts:[],n=>b((d(),_("div",{class:"twitter-account",key:n.id,onClick:p=>t.updateSelectedTwitterAccount(n)},[s("img",{class:"twitter-account__icon",src:n.icon_url},null,8,Ba),s("div",Da,[s("div",Fa,$(n.name),1),s("div",Ua,"@"+$(n.screen_name),1)]),b((d(),_("svg",Oa,[...e[30]||(e[30]=[s("path",{fill:"currentColor",d:"M14.046 3.486a.75.75 0 0 1-.032 1.06l-7.93 7.474a.85.85 0 0 1-1.188-.022l-2.68-2.72a.75.75 0 1 1 1.068-1.053l2.234 2.267l7.468-7.038a.75.75 0 0 1 1.06.032Z"},null,-1)])],512)),[[_e,n.id===t.settingsStore.settings.selected_twitter_account_id]])],8,Ea)),[[S]])),128))],2)])}const Na=W(ya,[["render",qa],["__scopeId","data-v-f441ba35"]]),za=z({name:"Watch-Panel",components:{Channel:ms,Comment:Vs,Program:si,RecordedProgram:Ti,Remocon:so,Series:no,Twitter:Na},props:{playback_mode:{type:String,required:!0}},data(){return{Utils:Object.freeze(w)}},computed:{...re(oe,U),panel_active_tab(){return this.playback_mode==="Live"?this.playerStore.tv_panel_active_tab:this.playerStore.video_panel_active_tab}}}),Wa={class:"watch-panel__header"},ja={key:0,class:"panel-broadcaster"},Ya=["src"],Ka={class:"panel-broadcaster__number"},Ga={class:"panel-broadcaster__name"},Za={class:"watch-panel__content-container"},Ja={class:"watch-panel__navigation"};function Xa(t,e,o,i,a,l){const r=M("Icon"),f=M("Program"),v=M("RecordedProgram"),u=M("Channel"),h=M("Series"),c=M("Comment"),y=M("Twitter"),n=M("Remocon");return d(),_("div",{class:"watch-panel",onMousemove:e[9]||(e[9]=p=>t.playerStore.event_emitter.emit("SetControlDisplayTimer",{event:p}))},[s("div",Wa,[b((d(),_("div",{class:"panel-close-button",onClick:e[0]||(e[0]=p=>t.playerStore.is_panel_display=!1)},[m(r,{class:"panel-close-button__icon",icon:"akar-icons:chevron-right",width:"25px"}),e[10]||(e[10]=s("span",{class:"panel-close-button__text"},"閉じる",-1))])),[[S]]),m(Ve),t.playback_mode==="Live"?(d(),_("div",ja,[s("img",{class:"panel-broadcaster__icon",src:`${t.Utils.api_base_url}/channels/${t.channelsStore.channel.current.id}/logo`},null,8,Ya),s("div",Ka,$(t.channelsStore.channel.current.channel_number),1),s("div",Ga,$(t.channelsStore.channel.current.name),1)])):F("",!0)]),s("div",Za,[t.playback_mode==="Live"?(d(),K(f,{key:0,class:T(["watch-panel__content",{"watch-panel__content--active":t.panel_active_tab==="Program"}])},null,8,["class"])):F("",!0),t.playback_mode==="Video"?(d(),K(v,{key:1,class:T(["watch-panel__content",{"watch-panel__content--active":t.panel_active_tab==="RecordedProgram"}])},null,8,["class"])):F("",!0),t.playback_mode==="Live"?(d(),K(u,{key:2,class:T(["watch-panel__content",{"watch-panel__content--active":t.panel_active_tab==="Channel"}])},null,8,["class"])):F("",!0),t.playback_mode==="Video"?(d(),K(h,{key:3,class:T(["watch-panel__content",{"watch-panel__content--active":t.panel_active_tab==="Series"}])},null,8,["class"])):F("",!0),m(c,{class:T(["watch-panel__content",{"watch-panel__content--active":t.panel_active_tab==="Comment"}]),playback_mode:t.playback_mode},null,8,["playback_mode","class"]),m(y,{class:T(["watch-panel__content",{"watch-panel__content--active":t.panel_active_tab==="Twitter"}]),playback_mode:t.playback_mode},null,8,["playback_mode","class"]),t.playback_mode==="Live"?b((d(),_("button",{key:4,class:T(["watch-panel__content-remocon-button elevation-8",{"watch-panel__content-remocon-button--active":t.panel_active_tab==="Program"||t.panel_active_tab==="Channel"}]),onClick:e[1]||(e[1]=p=>t.playerStore.is_remocon_display=!t.playerStore.is_remocon_display)},[m(r,{class:"panel-close-button__icon",icon:"material-symbols:remote-gen",width:"25px"})],2)),[[S]]):F("",!0),t.playback_mode==="Live"?(d(),K(n,{key:5,class:"watch-panel__remocon",modelValue:(t.panel_active_tab==="Program"||t.panel_active_tab==="Channel")&&t.playerStore.is_remocon_display===!0,"onUpdate:modelValue":e[2]||(e[2]=p=>t.playerStore.is_remocon_display=p)},null,8,["modelValue"])):F("",!0)]),s("div",Ja,[t.playback_mode==="Live"?b((d(),_("div",{key:0,class:T(["panel-navigation-button",{"panel-navigation-button--active":t.panel_active_tab==="Program"}]),onClick:e[3]||(e[3]=p=>t.playerStore.tv_panel_active_tab="Program")},[m(r,{class:"panel-navigation-button__icon",icon:"fa-solid:info-circle",width:"33px"}),e[11]||(e[11]=s("span",{class:"panel-navigation-button__text"},"番組情報",-1))],2)),[[S]]):F("",!0),t.playback_mode==="Video"?b((d(),_("div",{key:1,class:T(["panel-navigation-button",{"panel-navigation-button--active":t.panel_active_tab==="RecordedProgram"}]),onClick:e[4]||(e[4]=p=>t.playerStore.video_panel_active_tab="RecordedProgram")},[m(r,{class:"panel-navigation-button__icon",icon:"fa-solid:info-circle",width:"33px"}),e[12]||(e[12]=s("span",{class:"panel-navigation-button__text"},"番組情報",-1))],2)),[[S]]):F("",!0),t.playback_mode==="Live"?b((d(),_("div",{key:2,class:T(["panel-navigation-button",{"panel-navigation-button--active":t.panel_active_tab==="Channel"}]),onClick:e[5]||(e[5]=p=>t.playerStore.tv_panel_active_tab="Channel")},[m(r,{class:"panel-navigation-button__icon",icon:"fa-solid:broadcast-tower",width:"34px"}),e[13]||(e[13]=s("span",{class:"panel-navigation-button__text"},"チャンネル",-1))],2)),[[S]]):F("",!0),t.playback_mode==="Video"?b((d(),_("div",{key:3,class:T(["panel-navigation-button",{"panel-navigation-button--active":t.panel_active_tab==="Series"}]),onClick:e[6]||(e[6]=p=>t.playerStore.video_panel_active_tab="Series")},[m(r,{class:"panel-navigation-button__icon",icon:"fluent:video-clip-multiple-16-filled",width:"34px",style:{width:"39px",height:"39px","margin-top":"-4px","margin-bottom":"-4px"}}),e[14]||(e[14]=s("span",{class:"panel-navigation-button__text"},"シリーズ",-1))],2)),[[S]]):F("",!0),b((d(),_("div",{class:T(["panel-navigation-button",{"panel-navigation-button--active":t.panel_active_tab==="Comment"}]),onClick:e[7]||(e[7]=p=>t.playback_mode==="Live"?t.playerStore.tv_panel_active_tab="Comment":t.playerStore.video_panel_active_tab="Comment")},[m(r,{class:"panel-navigation-button__icon",icon:"bi:chat-left-text-fill",width:"29px"}),e[15]||(e[15]=s("span",{class:"panel-navigation-button__text"},"コメント",-1))],2)),[[S]]),b((d(),_("div",{class:T(["panel-navigation-button",{"panel-navigation-button--active":t.panel_active_tab==="Twitter"}]),onClick:e[8]||(e[8]=p=>t.playback_mode==="Live"?t.playerStore.tv_panel_active_tab="Twitter":t.playerStore.video_panel_active_tab="Twitter")},[m(r,{class:"panel-navigation-button__icon",icon:"fa-brands:twitter",width:"34px"}),e[16]||(e[16]=s("span",{class:"panel-navigation-button__text"},"Twitter",-1))],2)),[[S]])])],32)}const Qa=W(za,[["render",Xa],["__scopeId","data-v-598a6b71"]]),en={class:"watch-player__background-wrapper"},tn=z({__name:"Player",props:{playback_mode:{type:String,required:!0}},setup(t){const e=oe(),o=U(),i=Z(),a=()=>{const l=document.querySelector(".dplayer-mask");l&&l.click()};return(l,r)=>{const f=M("Icon"),v=Re("ftooltip");return d(),_("div",{class:T(["watch-player",{"watch-player--loading":C(o).is_loading,"watch-player--virtual-keyboard-display":C(o).is_virtual_keyboard_display&&C(w).hasActiveElementClass("dplayer-comment-input"),"watch-player--video":t.playback_mode==="Video","watch-player--pure-black":C(i).settings.use_pure_black_player_background}])},[s("div",en,[s("div",{class:T(["watch-player__background",{"watch-player__background--display":C(o).is_background_display,"watch-player__background--background-hide":C(i).settings.show_player_background_image===!1}]),style:ye({backgroundImage:`url(${C(o).background_url})`})},[...r[6]||(r[6]=[s("img",{class:"watch-player__background-logo",src:ct},null,-1)])],6)]),m(Ke,{indeterminate:"",size:"60",width:"6",class:T(["watch-player__buffering",{"watch-player__buffering--display":C(o).is_video_buffering}])},null,8,["class"]),r[7]||(r[7]=s("div",{class:"watch-player__dplayer"},null,-1)),s("div",{class:T(["watch-player__dplayer-setting-cover",{"watch-player__dplayer-setting-cover--display":C(o).is_player_setting_panel_open}]),onClick:a},null,2),s("div",{class:"watch-player__button",onMousemove:r[3]||(r[3]=u=>C(o).event_emitter.emit("SetControlDisplayTimer",{event:u})),onTouchmove:r[4]||(r[4]=u=>C(o).event_emitter.emit("SetControlDisplayTimer",{event:u})),onClick:r[5]||(r[5]=u=>C(o).event_emitter.emit("SetControlDisplayTimer",{event:u}))},[t.playback_mode==="Live"?b((d(),_("div",{key:0,class:"switch-button switch-button-up",onClick:r[0]||(r[0]=u=>{C(o).is_zapping=!0,l.$router.push({path:`/tv/watch/${C(e).channel.previous.display_channel_id}`})})},[m(f,{class:"switch-button-icon",icon:"fluent:ios-arrow-left-24-filled",width:"32px",style:{transform:"rotate(90deg)"}})])),[[S],[v,"前のチャンネル",void 0,{top:!0}]]):F("",!0),b((d(),_("div",{class:T(["switch-button switch-button-panel",{"switch-button-panel--open":C(o).is_panel_display}]),onClick:r[1]||(r[1]=u=>C(o).is_panel_display=!C(o).is_panel_display)},[m(f,{class:"switch-button-icon",icon:"fluent:navigation-16-filled",width:"32px"})],2)),[[S]]),t.playback_mode==="Live"?b((d(),_("div",{key:1,class:"switch-button switch-button-down",onClick:r[2]||(r[2]=u=>{C(o).is_zapping=!0,l.$router.push({path:`/tv/watch/${C(e).channel.next.display_channel_id}`})})},[m(f,{class:"switch-button-icon",icon:"fluent:ios-arrow-right-24-filled",width:"33px",style:{transform:"rotate(90deg)"}})])),[[S],[v,"次のチャンネル",void 0,{bottom:!0}]]):F("",!0)],32)],2)}}}),sn=W(tn,[["__scopeId","data-v-fa4f3f48"]]),on=z({name:"Watch",components:{KeyboardShortcutList:_t,LShapedScreenCropSettings:Yt,WatchHeader:At,WatchNavigation:dt,WatchPanel:Qa,WatchPlayer:sn},props:{playback_mode:{type:String,required:!0}},data(){return{Utils:Object.freeze(w)}},computed:{...re(U,Z)},watch:{"playerStore.is_panel_display":{handler(){this.settingsStore.settings.showed_panel_last_time=this.playerStore.is_panel_display}}},created(){"virtualKeyboard"in navigator&&(navigator.virtualKeyboard.overlaysContent=!0,navigator.virtualKeyboard.ongeometrychange=t=>{t.target.boundingRect.width===0&&t.target.boundingRect.height===0?this.playerStore.is_virtual_keyboard_display=!1:this.playerStore.is_virtual_keyboard_display=!0}),this.playerStore.startWatching()},beforeUnmount(){this.playerStore.stopWatching(),"virtualKeyboard"in navigator&&(navigator.virtualKeyboard.overlaysContent=!1)}}),an={class:"route-container"};function nn(t,e,o,i,a,l){const r=M("WatchNavigation"),f=M("WatchHeader"),v=M("WatchPlayer"),u=M("WatchPanel"),h=M("KeyboardShortcutList"),c=M("LShapedScreenCropSettings");return d(),_("div",an,[s("main",{class:T(["watch-container",{"watch-container--control-display":t.playerStore.is_control_display,"watch-container--panel-display":t.Utils.isSmartphoneVertical()||t.Utils.isTabletVertical()?!0:t.playerStore.is_panel_display,"watch-container--fullscreen":t.playerStore.is_fullscreen,"watch-container--document-pip":t.playerStore.is_document_pip,"watch-container--video":t.playback_mode==="Video"}])},[m(r),s("div",{class:"watch-content",onMousemove:e[0]||(e[0]=y=>t.playerStore.event_emitter.emit("SetControlDisplayTimer",{event:y,is_player_region_event:!0})),onTouchmove:e[1]||(e[1]=y=>t.playerStore.event_emitter.emit("SetControlDisplayTimer",{event:y,is_player_region_event:!0})),onClick:e[2]||(e[2]=y=>t.playerStore.event_emitter.emit("SetControlDisplayTimer",{event:y,is_player_region_event:!0}))},[m(f,{playback_mode:t.playback_mode},null,8,["playback_mode"]),m(v,{playback_mode:t.playback_mode},null,8,["playback_mode"])],32),m(u,{playback_mode:t.playback_mode},null,8,["playback_mode"])],2),m(h,{playback_mode:t.playback_mode},null,8,["playback_mode"]),m(c)])}const In=W(on,[["render",nn],["__scopeId","data-v-c9d62209"]]);class rn extends ut{constructor(o,i){super(o,i);H(this,"onCustomBufferFlushingHandler");H(this,"dontFlush",!1);H(this,"sse",null);H(this,"serverBufferingRange",null);this.onCustomBufferFlushingHandler=this.onCustomBufferFlushing.bind(this),this.dontFlush=!1}onBufferReset(){if(this.dontFlush){this.dontFlush=!1;return}super.onBufferReset()}onMediaAttaching(o,i){super.onMediaAttaching(o,i);const a=this.hls;this.media.addEventListener("seeking",this.onCustomBufferFlushingHandler),this.sse=new EventSource(a.url.replace("playlist","buffer")),this.sse.addEventListener("buffer_range_update",r=>{this.serverBufferingRange=JSON.parse(r.data),console.log("[CustomBufferController] Updated Server Buffering Range:",this.serverBufferingRange)})}onMediaDetaching(){this.media.removeEventListener("seeking",this.onCustomBufferFlushingHandler),this.sse&&(this.sse.close(),this.sse=null),super.onMediaDetaching()}onCustomBufferFlushing(){const o=this.hls,i=this.media;if(!i)return;let a=!1,l=!1;const r=i.duration;for(let f=0;f<i.buffered.length;f++)if(i.currentTime>=i.buffered.start(f)&&i.currentTime<=i.buffered.end(f)){a=!0;break}if(this.serverBufferingRange&&i.currentTime>=this.serverBufferingRange.begin&&i.currentTime<=this.serverBufferingRange.end&&(a=!0),i.currentTime>=r-.5&&(l=!0),console.log("[CustomBufferController] Server Buffering Range:",this.serverBufferingRange,"Current Time:",i.currentTime),!a&&!l){console.log("[CustomBufferController] Flushing Buffer..."),o.trigger(we.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.dontFlush=!0;const f=new URL(o.url);f.searchParams.set("cache_key",crypto.randomUUID().split("-")[0]),o.trigger(we.Events.MANIFEST_LOADING,{url:f.toString()})}}}function ln(t,e=0,{start:o=!0,middle:i=!0,once:a=!1}={}){let l=o,r=0,f,v=!1;function u(...h){if(v)return;const c=Date.now()-r;r=Date.now(),o&&i&&c>=e&&(l=!0),l?(l=!1,t.apply(this,h),a&&u.cancel()):(i&&c<e||!i)&&(clearTimeout(f),f=setTimeout(()=>{r=Date.now(),t.apply(this,h),a&&u.cancel()},i?e-c:e))}return u.cancel=()=>{clearTimeout(f),v=!0},u}class Ne{constructor(e){H(this,"restart_required_when_quality_switched",!1);H(this,"player");H(this,"watch_session",null);H(this,"comment_session",null);H(this,"vpos_base_timestamp",0);H(this,"keep_seat_interval_id",null);H(this,"abort_controller",new AbortController);H(this,"reconnecting",!1);H(this,"destroyed",!1);this.player=e}get watch_session_type(){var e;return((e=this.watch_session)==null?void 0:e.url.includes("nicovideo.jp"))===!0?"ニコニコ実況":"NX-Jikkyo "}async init(){const e=U(),o=ce();this.destroyed=!1,await o.fetchUser();const i=await this.initWatchSession();if(i.is_success===!1){e.live_comment_init_failed_message=i.detail,console.error(`[LiveCommentManager][WatchSession] Error: ${i.detail}`),i.detail!=="このチャンネルはニコニコ実況に対応していません。"&&this.player.template.notice.textContent.includes("再起動しています…")===!1&&this.player.notice(i.detail,void 0,void 0,"#FF6F6A");return}this.initCommentSession(i),console.log("[LiveCommentManager] Initialized.")}async initWatchSession(){var v;const e=oe(),o=Z(),i=ce();let a=!1;const l=await lt.fetchWebSocketInfo(e.channel.current.id);if(l===null)return{is_success:!1,detail:"コメント受信用 WebSocket API の情報を取得できませんでした。"};if(l.watch_session_url===null)return{is_success:!1,detail:"このチャンネルはニコニコ実況に対応していません。"};let r=l.watch_session_url;o.settings.prefer_posting_to_nicolive===!0&&(l.nicolive_watch_session_url!==null?(console.log("[LiveCommentManager][WatchSession] Post comments to Nicolive."),r=l.nicolive_watch_session_url):l.is_nxjikkyo_exclusive===!0?console.warn("[LiveCommentManager][WatchSession] Failed to get Nicolive watch session URL. (This channel is exclusive to NX-Jikkyo.)"):i.user===null?console.warn("[LiveCommentManager][WatchSession] Failed to get Nicolive watch session URL. (Not logged in to KonomiTV)"):((v=i.user)==null?void 0:v.niconico_user_id)===null?console.warn("[LiveCommentManager][WatchSession] Failed to get Nicolive watch session URL. (Not linked with Niconico account)"):l.nicolive_watch_session_error!==null&&(console.warn(`[LiveCommentManager][WatchSession] Failed to get Nicolive watch session URL. (${l.nicolive_watch_session_error})`),this.player.notice(`${l.nicolive_watch_session_error}代わりに NX-Jikkyo にコメントします。`,void 0,void 0,"#FFA86A"))),console.log(`[LiveCommentManager][WatchSession] Connected to ${r}`),this.watch_session=new WebSocket(r),this.watch_session.addEventListener("open",()=>{var u;(u=this.watch_session)==null||u.send(JSON.stringify({type:"startWatching",data:{reconnect:!1}}))},{signal:this.abort_controller.signal});const f=async u=>{if(a===!0)return;const h=u instanceof CloseEvent?u.code:"Error";this.player.template.notice.textContent.includes("再起動しています…")===!1&&this.player.notice(`${this.watch_session_type}との接続が切断されました。(Code: ${h})`,void 0,void 0,"#FF6F6A"),console.error(`[LiveCommentManager][WatchSession] Connection closed. (Code: ${h})`),await w.sleep(3),await this.reconnect()};return this.watch_session.addEventListener("close",f,{signal:this.abort_controller.signal}),this.watch_session.addEventListener("error",f,{signal:this.abort_controller.signal}),this.watch_session.addEventListener("message",async u=>{if(this.watch_session===null)return;const h=JSON.parse(u.data);switch(h.type){case"seat":{if(this.keep_seat_interval_id!==null)break;this.keep_seat_interval_id=window.setInterval(()=>{this.watch_session&&this.watch_session.readyState===WebSocket.OPEN?this.watch_session.send(JSON.stringify({type:"keepSeat"})):window.clearInterval(this.keep_seat_interval_id??0)},h.data.keepIntervalSec*1e3);break}case"ping":{this.watch_session.send(JSON.stringify({type:"pong"}));break}case"error":{if(h.data.code==="COMMENT_POST_NOT_ALLOWED"||h.data.code==="INVALID_MESSAGE")break;let c=`${this.watch_session_type}でエラーが発生しています。(Code: ${h.data.code})`;switch(h.data.code){case"CONNECT_ERROR":c=`${this.watch_session_type}のコメントサーバーに接続できません。`;break;case"CONTENT_NOT_READY":c=`${this.watch_session_type}が配信できない状態です。`;break;case"NO_THREAD_AVAILABLE":c=`${this.watch_session_type}のコメントスレッドを取得できません。`;break;case"NO_ROOM_AVAILABLE":c=`${this.watch_session_type}のコメント部屋を取得できません。`;break;case"NO_PERMISSION":c=`${this.watch_session_type}の API にアクセスする権限がありません。`;break;case"NOT_ON_AIR":c=`${this.watch_session_type}が放送中ではありません。`;break;case"BROADCAST_NOT_FOUND":c=`${this.watch_session_type}の配信情報を取得できません。`;break;case"INTERNAL_SERVERERROR":c=`${this.watch_session_type}でサーバーエラーが発生しています。`;break}this.player.template.notice.textContent.includes("再起動しています…")===!1&&this.player.notice(c,void 0,void 0,"#FF6F6A"),console.error(`[LiveCommentManager][WatchSession] Error occurred. (Code: ${h.data.code})`),await w.sleep(3),await this.reconnect();break}case"reconnect":{await this.reconnect();break}case"disconnect":{a=!0;let c=`${this.watch_session_type}との接続が切断されました。(${h.data.reason})`;switch(h.data.reason){case"TAKEOVER":c=`${this.watch_session_type}の番組から追い出されました。`;break;case"NO_PERMISSION":c=`${this.watch_session_type}の番組の座席を取得できませんでした。`;break;case"END_PROGRAM":c=`${this.watch_session_type}がリセットされたか、コミュニティの番組が終了しました。`;break;case"PING_TIMEOUT":c="コメントサーバーとの接続生存確認に失敗しました。";break;case"TOO_MANY_CONNECTIONS":c=`${this.watch_session_type}の同一ユーザからの接続数上限を越えています。`;break;case"TOO_MANY_WATCHINGS":c=`${this.watch_session_type}の同一ユーザからの視聴番組数上限を越えています。`;break;case"CROWDED":c=`${this.watch_session_type}の番組が満席です。`;break;case"MAINTENANCE_IN":c=`${this.watch_session_type}はメンテナンス中です。`;break;case"SERVICE_TEMPORARILY_UNAVAILABLE":c=`${this.watch_session_type}で一時的にサーバーエラーが発生しています。`;break}this.player.template.notice.textContent.includes("再起動しています…")===!1&&this.player.notice(c,void 0,void 0,"#FF6F6A"),console.error(`[LiveCommentManager][WatchSession] Disconnected. (Reason: ${h.data.reason})`),await w.sleep(3),await this.reconnect();break}}},{signal:this.abort_controller.signal}),new Promise(u=>{this.watch_session.addEventListener("message",async h=>{const c=JSON.parse(h.data);if(c.type==="room")return this.vpos_base_timestamp=te(c.data.vposBaseTime).valueOf(),console.log(`[LiveCommentManager][WatchSession] Connected.
Thread ID: ${c.data.threadId}`),u({is_success:!0,detail:"視聴セッションを取得しました。",message_server_url:c.data.messageServer.uri,thread_id:c.data.threadId,your_post_key:c.data.yourPostKey?c.data.yourPostKey:null});if(c.type==="messageServer"){this.vpos_base_timestamp=te(c.data.vposBaseTime).valueOf();const y=c.data.hashedUserId;return console.log("[LiveCommentManager][WatchSession] Connected."),u({is_success:!0,detail:"視聴セッションを取得しました。",message_server_url:l.comment_session_url,thread_id:"",your_post_key:`nicolive:${y}`})}},{signal:this.abort_controller.signal})})}initCommentSession(e){const o=U(),i=ce(),a=[];let l=!1;const r=[];this.comment_session=new WebSocket(e.message_server_url),this.comment_session.addEventListener("open",()=>{this.comment_session!==null&&this.comment_session.send(JSON.stringify([{ping:{content:"rs:0"}},{ping:{content:"ps:0"}},{thread:{version:"20061206",thread:e.thread_id,threadkey:e.your_post_key,user_id:"",res_from:-100}},{ping:{content:"pf:0"}},{ping:{content:"rf:0"}}]))},{signal:this.abort_controller.signal});const f=async u=>{const h=u instanceof CloseEvent?u.code:"Error";this.player.template.notice.textContent.includes("再起動しています…")===!1&&this.player.notice(`NX-Jikkyo との接続が切断されました。(Code: ${h})`,void 0,void 0,"#FF6F6A"),console.error(`[LiveCommentManager][CommentSession] Connection closed. (Code: ${h})`),await w.sleep(3),await this.reconnect()};this.comment_session.addEventListener("close",f,{signal:this.abort_controller.signal}),this.comment_session.addEventListener("error",f,{signal:this.abort_controller.signal});const v=ln(()=>{w.isSafari()===!1&&console.debug("[LiveCommentManager][CommentSession] Comments buffer length:",r.length),this.destroyed===!1&&o.event_emitter.emit("CommentReceived",{is_initial_comments:!1,comments:r}),r.length=0},333);this.comment_session.addEventListener("message",async u=>{var A,q;const h=JSON.parse(u.data);if(h.thread!==void 0&&h.thread.resultcode!==0){console.error(`[LiveCommentManager][CommentSession] Connection failed. (Code: ${h.thread.resultcode})`);return}if(h.ping!==void 0&&h.ping.content==="rf:0"){l=!0,this.destroyed===!1&&o.event_emitter.emit("CommentReceived",{is_initial_comments:!0,comments:a});return}const c=h.chat;if(c===void 0||c.content===void 0||c.content===""||c.yourpost&&c.yourpost===1&&l===!0||((q=(A=i.user)==null?void 0:A.niconico_user_id)==null?void 0:q.toString())===c.user_id.replace("nicolive:",""))return;const{color:y,position:n,size:p}=pe.parseCommentCommand(c.mail);if(pe.isMutedComment(c.content,c.user_id,y,n,p))return;const L={id:c.no,text:c.content,time:w.apply28HourClock(te(c.date*1e3).format("HH:mm:ss")),playback_position:this.player.video.currentTime,user_id:c.user_id,my_post:!1};if(l===!1){a.push(L);return}let P=0;this.player.video.buffered.length>=1&&(P=this.player.video.buffered.end(0));const x=Math.max(P-this.player.video.currentTime,0);w.isSafari()===!1&&console.debug(`[LiveCommentManager][CommentSession] Delay: ${x} sec.`),await w.sleep(x),r.push(L),v(),this.player.video.paused===!1&&this.player.danmaku.draw({text:c.content,color:y,type:n,size:p})},{signal:this.abort_controller.signal})}sendComment(e){var u,h;const o=U(),i=Z(),a=ce();if(o.live_comment_init_failed_message!==null){e.error(o.live_comment_init_failed_message);return}if(i.settings.prefer_posting_to_nicolive===!0&&(a.user===null?this.player.notice("ニコニコ実況にコメントするには、KonomiTV アカウントにログインしてください。代わりに NX-Jikkyo にコメントします。",void 0,void 0,"#FFA86A"):a.user.niconico_user_id===null&&this.player.notice("ニコニコ実況にコメントするには、ニコニコアカウントと連携してください。代わりに NX-Jikkyo にコメントします。",void 0,void 0,"#FFA86A")),this.watch_session_type==="ニコニコ実況"){if(((u=a.user)==null?void 0:u.niconico_user_premium)===!1&&(e.data.type==="top"||e.data.type==="bottom")){e.error("ニコニコ実況でコメントを上下に固定するには、ニコニコアカウントのプレミアム会員登録が必要です。");return}if(((h=a.user)==null?void 0:h.niconico_user_premium)===!1&&e.data.size==="big"){e.error("ニコニコ実況でコメントサイズを大きめに設定するには、ニコニコアカウントのプレミアム会員登録が必要です。");return}}if(this.watch_session===null||this.watch_session.readyState!==WebSocket.OPEN){console.error("[LiveCommentManager][WatchSession] Comment sending failed. (Connection is not established.)"),e.error("コメントの送信に失敗しました。WebSocket 接続が確立されていません。");return}const l={"#FFEAEA":"white","#F02840":"red","#FD7E80":"pink","#FDA708":"orange","#FFE133":"yellow","#64DD17":"green","#00D4F5":"cyan","#4763FF":"blue"},r={top:"ue",right:"naka",bottom:"shita"},f=Math.round((te().valueOf()-this.vpos_base_timestamp)/10);this.watch_session.send(JSON.stringify({type:"postComment",data:{text:e.data.text,color:l[e.data.color.toUpperCase()],position:r[e.data.type],size:e.data.size,vpos:f,isAnonymous:!0}}));const v=new AbortController;this.watch_session.addEventListener("message",c=>{var n;const y=JSON.parse(c.data);switch(y.type){case"postCommentResult":{e.success(),o.event_emitter.emit("CommentSendCompleted",{comment:{id:w.time(),text:e.data.text,time:w.apply28HourClock(te().format("HH:mm:ss")),playback_position:this.player.video.currentTime,user_id:`${((n=a.user)==null?void 0:n.niconico_user_id)??"Unknown"}`,my_post:!0}}),v.abort();break}case"error":{let p=`コメントの送信に失敗しました。(${y.data.code})`;switch(y.data.code){case"COMMENT_POST_NOT_ALLOWED":p="コメントが許可されていません。";break;case"INVALID_MESSAGE":p="コメント内容が無効です。";break}console.error(`[LiveCommentManager][WatchSession] Comment sending failed. (Code: ${y.data.code})`),e.error(p),v.abort();break}}},{signal:v.signal})}async reconnect(){const e=U(),o=this.watch_session!==null&&(this.watch_session.readyState===WebSocket.CLOSING||this.watch_session.readyState===WebSocket.CLOSED),i=this.comment_session!==null&&(this.comment_session.readyState===WebSocket.CLOSING||this.comment_session.readyState===WebSocket.CLOSED);if(this.reconnecting===!0&&o===!1&&i===!1)return;this.reconnecting=!0,console.warn("[LiveCommentManager] Reconnecting..."),this.player.template.notice.textContent.includes("再起動しています…")===!1&&this.player.notice(`${this.watch_session_type}に再接続しています…`),await this.destroy();const a=await this.initWatchSession();if(a.is_success===!1){e.live_comment_init_failed_message=a.detail,console.error("[LiveCommentManager] Reconnection failed."),this.player.template.notice.textContent.includes("再起動しています…")===!1&&this.player.notice(a.detail,void 0,void 0,"#FF6F6A"),this.reconnecting=!1;return}this.initCommentSession(a),this.destroyed=!1,this.reconnecting=!1,console.warn("[LiveCommentManager] Reconnected.")}async destroy(){const e=U();this.abort_controller.abort(),this.abort_controller=new AbortController,this.watch_session!==null&&(this.watch_session.close(),this.watch_session=null),this.comment_session!==null&&(this.comment_session.close(),this.comment_session=null),this.keep_seat_interval_id!==null&&(window.clearInterval(this.keep_seat_interval_id),this.keep_seat_interval_id=null),this.vpos_base_timestamp=0,e.live_comment_init_failed_message=null,this.destroyed=!0,console.log("[LiveCommentManager] Destroyed.")}}const Q=class Q{constructor(e){H(this,"player",null);H(this,"player_managers",[]);H(this,"playback_mode");H(this,"quality_profile_type");H(this,"live_force_seek_interval_timer_cancel",null);H(this,"video_keep_alive_interval_timer_cancel",null);H(this,"player_container_resize_observer",null);H(this,"player_control_ui_hide_timer_id",0);H(this,"watched_history_threshold_timer_id",0);H(this,"screen_wake_lock",null);H(this,"romsounds_context",new AudioContext);H(this,"romsounds_buffers",[]);H(this,"lshaped_screen_crop_watchers",[]);H(this,"destroying",!1);H(this,"destroyed",!1);this.playback_mode=e,me.getNetworkCircuitType()==="Cellular"?this.quality_profile_type="Cellular":this.quality_profile_type="Wi-Fi",(async()=>{for(let i=1;i<=14;i++){const a=`/assets/romsounds/${i.toString().padStart(2,"0")}.wav`,l=await Be.get(a,{baseURL:"",responseType:"arraybuffer"});l.type==="success"&&this.romsounds_buffers.push(await this.romsounds_context.decodeAudioData(l.data))}})()}get quality_profile(){const e=Z();return this.quality_profile_type==="Cellular"?{tv_streaming_quality:e.settings.tv_streaming_quality_cellular,tv_data_saver_mode:e.settings.tv_data_saver_mode_cellular,tv_low_latency_mode:e.settings.tv_low_latency_mode_cellular,video_streaming_quality:e.settings.video_streaming_quality_cellular,video_data_saver_mode:e.settings.video_data_saver_mode_cellular}:{tv_streaming_quality:e.settings.tv_streaming_quality,tv_data_saver_mode:e.settings.tv_data_saver_mode,tv_low_latency_mode:e.settings.tv_low_latency_mode,video_streaming_quality:e.settings.video_streaming_quality,video_data_saver_mode:e.settings.video_data_saver_mode}}get live_playback_buffer_seconds(){let e=this.quality_profile.tv_low_latency_mode?Q.LIVE_PLAYBACK_BUFFER_SECONDS_LOW_LATENCY:Q.LIVE_PLAYBACK_BUFFER_SECONDS;return w.isSafari()===!0&&(e+=.3),e}async init(e={default_quality:null,playback_rate:null,seek_seconds:null}){var c,y;const o=oe(),i=U(),a=Z();console.log("\x1B[31m[PlayerController] Initializing..."),this.destroyed=!1,i.is_player_initialized=!0,window.mpegts=ue,window.Hls=we;let l=!1;me.isHEVCVideoSupported()&&(this.playback_mode==="Live"&&this.quality_profile.tv_data_saver_mode===!0||this.playback_mode==="Video"&&this.quality_profile.video_data_saver_mode===!0)&&(l=!0);const r=await ue.supportWorkerForMSEH265Playback(),f=this.playback_mode==="Live"?a.settings.tv_show_superimpose:a.settings.video_show_superimpose;let v=e.seek_seconds;if(v===null){const n=a.settings.watched_history.find(p=>p.video_id===i.recorded_program.id);n?(v=n.last_playback_position,console.log(`\x1B[31m[PlayerController] Seeking to ${v} seconds. (Watched History)`)):(v=i.recorded_program.recording_start_margin+2,console.log(`\x1B[31m[PlayerController] Seeking to ${v} seconds. (Recording Start Margin + 2)`))}localStorage.getItem("dplayer-danmaku-opacity")===null&&localStorage.setItem("dplayer-danmaku-opacity","0.5");const u=[];if(this.playback_mode==="Video"&&((y=(c=i.recorded_program)==null?void 0:c.recorded_video)!=null&&y.cm_sections)){const n=i.recorded_program.recorded_video.cm_sections,L=i.recorded_program.recorded_video.duration-2;for(const P of n)P.start_time<=L&&u.push({text:"CM",time:P.start_time}),P.end_time<=L&&u.push({text:"本編",time:P.end_time});console.log("\x1B[31m[PlayerController] Added CM section markers:",u)}this.player=new mt({container:document.querySelector(".watch-player__dplayer"),theme:"#E64F97",lang:"ja-jp",live:this.playback_mode==="Live",liveSyncMinBufferSize:this.live_playback_buffer_seconds-.1,loop:this.playback_mode!=="Live",autoplay:!0,airplay:!1,hotkey:!1,screenshot:!1,crossOrigin:"anonymous",volume:1,playbackSpeed:[.25,.5,.75,1,1.1,1.25,1.5,1.75,2],highlight:u.length>0?u:void 0,video:(()=>{const n=[],p=l===!0?"-hevc":"";if(this.playback_mode==="Live"){const L=`${w.api_base_url}/streams/live/${o.channel.current.display_channel_id}`;if(o.channel.current.is_radiochannel===!0)n.push({name:"48kHz/192kbps",type:"mpegts",url:`${L}/1080p/mpegts`});else for(const x of nt)n.push({name:x==="1080p-60fps"?"1080p (60fps)":x,type:"mpegts",url:`${L}/${x}${p}/mpegts`});let P=this.quality_profile.tv_streaming_quality;return e.default_quality!==null&&(P=e.default_quality),o.channel.current.is_radiochannel&&(P="48kHz/192kbps"),{quality:n,defaultQuality:P}}else{const L=`${w.api_base_url}/streams/video/${i.recorded_program.id}`;for(const x of rt){const A=crypto.randomUUID().split("-")[0];n.push({name:x==="1080p-60fps"?"1080p (60fps)":x,type:"hls",url:`${L}/${x}${p}/playlist?session_id=${A}`})}let P=this.quality_profile.video_streaming_quality;return e.default_quality!==null&&(P=e.default_quality),{quality:n,defaultQuality:P,thumbnails:{url:`${w.api_base_url}/videos/${i.recorded_program.id}/thumbnail/tiled`,interval:(()=>{const x=Math.floor(i.recorded_program.recorded_video.duration/60),A=30,q=5,j=30;if(x<=A)return q;const V=x/A;return Math.min(j,q*V/Math.log2(1+V/2))})(),width:480,height:270,columnCount:34}}}})(),danmaku:{user:"KonomiTV",speedRate:a.settings.comment_speed_rate,fontSize:a.settings.comment_font_size,closeCommentFormAfterSend:a.settings.close_comment_form_after_sending},apiBackend:{read:async n=>{if(this.playback_mode==="Live")n.success([]);else{const p=await xt.fetchVideoJikkyoComments(i.recorded_program.id);if(p.is_success===!1)i.video_comment_init_failed_message=p.detail,p.detail!=="この録画番組の過去ログコメントは存在しないか、現在取得中です。"?n.error(p.detail):n.success([]);else{const P=i.recorded_program.recorded_video.recording_start_time;let x=0;i.event_emitter.emit("CommentReceived",{is_initial_comments:!0,comments:p.comments.map(A=>({id:x++,text:A.text,time:w.apply28HourClock(te(P).add(A.time,"seconds").format("MM/DD HH:mm:ss")),playback_position:A.time,user_id:A.author,my_post:!1}))}),n.success(p.comments)}this.player.danmaku.seek();let L=this.player.video.currentTime;(L===0||isNaN(L))&&(L=v),await w.sleep(.1),i.event_emitter.emit("PlaybackPositionChanged",{playback_position:L}),console.log(`\x1B[31m[PlayerController] Comment list seeking to ${L} seconds.`)}},send:async n=>{if(this.playback_mode==="Live"){for(const p of this.player_managers)if(p instanceof Ne){p.sendComment(n);return}}else n.error("録画番組にはコメントできません。")}},subtitle:{type:"aribb24"},pluginOptions:{mpegts:{config:{enableWorker:!0,enableWorkerForMSE:!(l===!0&&r===!1),enableStashBuffer:!0,stashInitialSize:Math.floor(2048*1024),liveSync:this.quality_profile.tv_low_latency_mode,liveSyncMaxLatency:3,liveSyncTargetLatency:this.live_playback_buffer_seconds,liveSyncPlaybackRate:1.1}},hls:{...we.DefaultConfig,enableWorker:!0,preferManagedMediaSource:!1,bufferController:rn,manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e6,maxLoadTimeMs:1e6,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e6,maxLoadTimeMs:1e6,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e6,maxLoadTimeMs:1e6,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}}},aribb24:{disableSuperimposeRenderer:f===!1,normalFont:(()=>{let n=a.settings.caption_font;return n==="sans-serif"?"sans-serif":(n==="Yu Gothic"&&(n='Yu Gothic Medium","Yu Gothic","YuGothic'),`"${n}", "Rounded M+ 1m for ARIB", sans-serif`)})(),forceStrokeColor:a.settings.always_border_caption_text,forceBackgroundColor:(()=>{if(a.settings.specify_caption_opacity===!0)return`rgba(0, 0, 0, ${a.settings.caption_opacity})`})(),drcsReplacement:!0,enableRawCanvas:!0,useStroke:!0,usePUA:(()=>{const n=a.settings.caption_font,p=document.createElement("canvas").getContext("2d");return p.font='10px "Rounded M+ 1m for ARIB"',p.fillText("Test",0,0),p.font=`10px "${n}"`,p.fillText("Test",0,0),!!n.startsWith("Windows TV")})(),PRACallback:async n=>{if(f===!1)return;this.romsounds_context.state==="suspended"&&await this.romsounds_context.resume();const p=this.romsounds_context.createBufferSource();p.buffer=this.romsounds_buffers[n];const L=this.romsounds_context.createGain();p.connect(L),L.connect(this.romsounds_context.destination),L.gain.value=3,p.start(0)}}}}),window.player=this.player,this.player.container.classList.contains("dplayer-mobile")===!0&&this.player.volume(1,void 0,!0),this.player.controller.setAutoHide=n=>{},this.setupVideoPlaybackHandler(),this.setupFullscreenHandler(),this.setupSettingPanelHandler(),this.setupLShapedScreenCropHandler(),this.setupPlayerContainerResizeHandler(),this.setControlDisplayTimer(),this.playback_mode==="Video"&&(e.playback_rate!==null&&this.player.speed(e.playback_rate),this.player.seek(v),this.player.bar.set("played",v/i.recorded_program.recorded_video.duration,"width"),v>i.recorded_program.recording_start_margin+2?this.player.notice("前回視聴した続きから再生します"):this.player.hideNotice(),this.player.play(),console.log(`\x1B[31m[PlayerController] Seeking to ${v} seconds.`)),i.event_emitter.off("SendNotification"),i.event_emitter.on("SendNotification",n=>{this.destroyed===!0||this.player===null||this.player.notice(n.message,n.duration,n.opacity,n.color)});let h=!1;i.event_emitter.off("PlayerRestartRequired"),i.event_emitter.on("PlayerRestartRequired",async n=>{var x,A,q,j;if(this.destroyed===!0||this.player===null)return;if(console.warn("\x1B[31m[PlayerController] PlayerRestartRequired event received. Message: ",n.message),this.playback_mode==="Live"&&ue.isSupported()!==!0){console.warn("\x1B[31m[PlayerController] PlayerRestartRequired event received, but mpegts.js is not supported. Ignored."),(x=this.player)==null||x.notice("iOS (Safari) 17.0 以下での視聴には対応していません。速やかに iOS を 17.1 以降に更新してください。",-1,void 0,"#FF6F6A");return}if(h===!0){console.warn("\x1B[31m[PlayerController] PlayerRestartRequired event received, but already restarting. Ignored.");return}h=!0;const p=(A=this.player)!=null&&A.qualityIndex?this.player.options.video.quality[this.player.qualityIndex]:null,L=((q=this.player)==null?void 0:q.video.playbackRate)??null,P=((j=this.player)==null?void 0:j.video.currentTime)??null;if(await this.destroy(),this.playback_mode==="Live"&&await w.sleep(.5),await this.init({default_quality:p?p.name:null,playback_rate:this.playback_mode==="Video"?L:null,seek_seconds:this.playback_mode==="Video"?P:null}),h=!1,G(this.player!==null),n.message){await w.sleep(n.message_delay_seconds??0);const V=n.is_error_message===!1?void 0:"#FF6F6A";this.player.notice(n.message,void 0,void 0,V)}}),i.event_emitter.off("SetControlDisplayTimer"),i.event_emitter.on("SetControlDisplayTimer",n=>{this.setControlDisplayTimer(n.event,n.is_player_region_event,n.timeout_seconds)}),this.player.container.querySelector(".dplayer-icons.dplayer-icons-right").insertAdjacentHTML("afterbegin",`
            <div class="dplayer-icon dplayer-player-restart-icon" aria-label="プレイヤーを再起動"
                data-balloon-nofocus="" data-balloon-pos="up">
                <span class="dplayer-icon-content">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 5V3.21c0-.45-.54-.67-.85-.35l-2.8 2.79c-.2.2-.2.51 0 .71l2.79 2.79c.32.31.86.09.86-.36V7c3.31 0 6 2.69 6 6c0 2.72-1.83 5.02-4.31 5.75c-.42.12-.69.52-.69.95c0 .65.62 1.16 1.25.97A7.991 7.991 0 0 0 20 13c0-4.42-3.58-8-8-8zm-6 8c0-1.34.44-2.58 1.19-3.59c.3-.4.26-.95-.09-1.31c-.42-.42-1.14-.38-1.5.1a7.991 7.991 0 0 0 4.15 12.47c.63.19 1.25-.32 1.25-.97c0-.43-.27-.83-.69-.95C7.83 18.02 6 15.72 6 13z"/></svg>
                </span>
            </div>
        `),this.player.container.querySelector(".dplayer-player-restart-icon").addEventListener("click",async()=>{var P,x,A,q;const n=(P=this.player)!=null&&P.qualityIndex?this.player.options.video.quality[this.player.qualityIndex]:null,p=((x=this.player)==null?void 0:x.video.playbackRate)??null,L=((A=this.player)==null?void 0:A.video.currentTime)??null;await this.destroy(),await this.init({default_quality:n?n.name:null,playback_rate:this.playback_mode==="Video"?p:null,seek_seconds:this.playback_mode==="Video"?L:null}),(q=this.player)==null||q.notice("プレイヤーを再起動しました。",void 0,void 0,void 0)}),"wakeLock"in navigator&&navigator.wakeLock.request("screen").then(n=>{this.screen_wake_lock=n,console.log("\x1B[31m[PlayerController] Screen Wake Lock API: Screen Wake Lock acquired.")}),this.playback_mode==="Live"?this.player_managers=[new pt(this.player),new Ne(this.player),new ht(this.player),new qe(this.player,this.playback_mode),new De(this.player,this.playback_mode),new Fe(this.player,this.playback_mode),new Ue(this.player,this.playback_mode)]:this.player_managers=[new qe(this.player,this.playback_mode),new De(this.player,this.playback_mode),new Fe(this.player,this.playback_mode),new Ue(this.player,this.playback_mode)],await Promise.all(this.player_managers.map(n=>n.init())),console.log("\x1B[31m[PlayerController] Initialized.")}getPlaybackBufferSeconds(){if(this.player===null)return 0;if(this.playback_mode==="Live")try{const e=this.player.video.buffered.length,o=this.player.video.buffered.end(e-1)-this.player.video.currentTime;return w.mathFloor(o,3)}catch{return 0}else return 0}async recoverPlayback(){var o,i,a,l;G(this.player!==null);const e=U();if(await w.sleep(1),e.is_video_buffering===!0&&((i=(o=this.player)==null?void 0:o.video)==null?void 0:i.readyState)<3){console.warn("\x1B[31m[PlayerController] Video still buffering. (HTMLVideoElement.readyState < HAVE_FUTURE_DATA) Trying to recover."),this.player.video.pause(),await w.sleep(.25);try{await this.player.video.play()}catch{G(this.player!==null),console.warn("\x1B[31m[PlayerController] HTMLVideoElement.play() rejected. paused."),this.player.pause();return}if(await w.sleep(.5),e.is_video_buffering===!0&&((l=(a=this.player)==null?void 0:a.video)==null?void 0:l.readyState)<3){console.warn("\x1B[31m[PlayerController] Video still buffering. (HTMLVideoElement.readyState < HAVE_FUTURE_DATA) Trying to recover."),this.player.video.pause(),await w.sleep(.25);try{await this.player.video.play()}catch{G(this.player!==null),console.warn("\x1B[31m[PlayerController] (retry) HTMLVideoElement.play() rejected. paused."),this.player.pause()}}}}setupVideoPlaybackHandler(){G(this.player!==null);const e=oe(),o=U(),i=Z();this.playback_mode==="Live"&&(this.live_force_seek_interval_timer_cancel=w.setIntervalInWorker(()=>{this.player!==null&&this.player.video.paused&&this.player.video.buffered.length>=1&&this.player.video.buffered.end(0)-this.player.video.currentTime>30&&this.player.sync()},60*1e3)),this.playback_mode==="Video"&&(this.video_keep_alive_interval_timer_cancel=w.setIntervalInWorker(async()=>{if(this.player===null)return;const u=me.extractVideoAPIQualityFromDPlayer(this.player),h=me.extractSessionIdFromDPlayer(this.player);await Be.put(`${w.api_base_url}/streams/video/${o.recorded_program.id}/${u}/keep-alive?session_id=${h}`)},5*1e3));const a=()=>{this.player!==null&&(o.is_video_paused=this.player.video.paused,this.player.video.paused===!0&&o.is_loading===!1&&(o.is_video_buffering=!1),this.player.setting.hide(),this.setControlDisplayTimer())};this.player.on("play",a),this.player.on("pause",a),this.player.on("waiting",()=>{o.is_video_buffering=!0}),this.player.on("playing",()=>{o.is_loading===!1&&(o.is_video_buffering=!1),this.playback_mode==="Live"&&this.recoverPlayback()});const l=async()=>{var u,h;G(this.player!==null),o.background_url=me.generatePlayerBackgroundURL();for(const c of this.player_managers)c.restart_required_when_quality_switched===!0&&c.destroy().then(()=>c.init());if(this.playback_mode==="Live"){if((u=this.player.plugins.mpegts)==null||u.on(ue.Events.ERROR,async(n,p)=>{this.player!==null&&(await w.sleep(1),navigator.onLine===!1&&(this.player.notice("現在ネットワーク接続がありません。オンラインになるまで待機しています…",void 0,void 0,"#FF6F6A"),console.warn("\x1B[31m[PlayerController] mpegts.js error event: Network error. Waiting for online..."),await w.waitUntilOnline()),console.error("\x1B[31m[PlayerController] mpegts.js error event:",n,p),o.event_emitter.emit("PlayerRestartRequired",{message:`再生中にエラーが発生しました。(${n}: ${p}) プレイヤーを再起動しています…`}))}),this.player.on("error",async n=>{this.player===null||o.live_stream_status==="Offline"||(await w.sleep(1),this.player.video.error?(console.error("\x1B[31m[PlayerController] HTMLVideoElement error event:",this.player.video.error),o.event_emitter.emit("PlayerRestartRequired",{message:`再生中にエラーが発生しました。(Native: ${this.player.video.error.code}: ${this.player.video.error.message}) プレイヤーを再起動しています…`})):o.event_emitter.emit("PlayerRestartRequired",{message:"再生中にエラーが発生しました。(Native: unknown error) プレイヤーを再起動しています…"}))}),o.is_loading=!0,this.player.video.muted=!0,this.player.video.paused===!0){let n=0;const p=5,L=.05,P=async()=>{var x;if(n>=p){console.warn(`\x1B[31m[PlayerController] Failed to start playback after ${p} attempts.`);return}try{await((x=this.player)==null?void 0:x.video.play()),console.log("\x1B[31m[PlayerController] Playback started successfully.")}catch(A){console.warn(`\x1B[31m[PlayerController] Attempt ${n+1} to start playback failed:`,A),n++,await w.sleep(L),await P()}};await P()}let c=!1;const y=async()=>{if(this.player===null||c===!0)return;this.player.video.oncanplay=null,this.player.video.oncanplaythrough=null,c=!0,console.log("\x1B[31m[PlayerController] Buffering..."),this.player.video.playbackRate=0;const n=this.live_playback_buffer_seconds;let p=this.getPlaybackBufferSeconds();for(;p<n;)await w.sleep(.1),p=this.getPlaybackBufferSeconds();this.player.video.playbackRate=1,console.log("\x1B[31m[PlayerController] Buffering completed."),o.is_loading=!1,o.is_video_buffering=!1,this.recoverPlayback(),e.channel.current.is_radiochannel===!0?o.is_background_display=!0:o.is_background_display=!1,this.player.video.muted=!1,this.player.video.volume=0;const L=this.player.user.get("volume"),P=L/10;for(let x=0;x<10;x++)await w.sleep(.5/10),this.player.video.volume=Math.min(w.mathFloor(this.player.video.volume+P,3),L);this.player.video.volume=L};if(this.player.video.oncanplay=y,this.player.video.oncanplaythrough=y,(h=this.player.plugins.mpegts)==null||h.on(ue.Events.MEDIA_INFO,async n=>{console.log("\x1B[31m[PlayerController] mpegts.js media info:",n),await w.sleep(.25),c===!1&&(console.warn("\x1B[31m[PlayerController] mpegts.js media info fired, but canplay(through) event not fired. Trying to manually start playback."),y())}),(async()=>{let n=0;for(;this.player!==null&&this.player.video.readyState<4;){if(this.player.video.readyState<3)n=0;else if(++n>100)break;await w.sleep(.05)}await w.sleep(.1),c===!1&&(console.warn("\x1B[31m[PlayerController] canplay(through) event not fired. Trying to manually start playback."),y())})(),await w.sleep(15),this.destroyed===!0||this.player===null)return;o.live_stream_status==="ONAir"&&o.is_video_buffering===!0&&c===!1&&o.event_emitter.emit("PlayerRestartRequired",{message:"再生開始までに時間が掛かっています。プレイヤーを再起動しています…"})}else{o.is_loading=!0,o.is_background_display=!0;let c=!1;const y=async()=>{this.player!==null&&c!==!0&&(this.player.video.oncanplaythrough=null,c=!0,o.is_loading=!1,o.is_video_buffering=!1,o.is_background_display=!1)};this.player.video.oncanplaythrough=y,this.player.on("error",async n=>{this.player!==null&&(this.player.video.error?(console.error("\x1B[31m[PlayerController] HTMLVideoElement error event:",this.player.video.error),o.event_emitter.emit("PlayerRestartRequired",{message:`再生中にエラーが発生しました。(Native: ${this.player.video.error.code}: ${this.player.video.error.message}) プレイヤーを再起動しています…`})):o.event_emitter.emit("PlayerRestartRequired",{message:"再生中にエラーが発生しました。(Native: unknown error) プレイヤーを再起動しています…"}))})}};l(),this.player.on("quality_start",l);let r=0,f=0;const v=document.querySelector(".program-info__next");if(v!==null&&(v.ontouchstart=()=>{if(this.player===null)return;const u=new Date().getTime(),h=u-f;h<500&&h>0&&(r++,r===3&&(this.player.infoPanel.toggle(),r=0)),f=u}),this.playback_mode==="Video"){this.player.on("timeupdate",()=>{!this.player||!this.player.video||o.event_emitter.emit("PlaybackPositionChanged",{playback_position:this.player.video.currentTime})});let u=0;this.player.on("timeupdate",()=>{if(!this.player||!this.player.video)return;const h=new Date().getTime();if(h-u<Q.WATCHED_HISTORY_UPDATE_INTERVAL*1e3)return;u=h;const c=this.player.video.currentTime,y=o.recorded_program.id,n=i.settings.watched_history.findIndex(p=>p.video_id===y);n!==-1&&(i.settings.watched_history[n].last_playback_position=c,i.settings.watched_history[n].updated_at=w.time(),console.log(`\x1B[31m[PlayerController] Last playback position updated. (Video ID: ${y}, last_playback_position: ${c})`))}),this.watched_history_threshold_timer_id=window.setTimeout(()=>{if(!this.player||!this.player.video)return;const h=o.recorded_program.id;if(i.settings.watched_history.findIndex(y=>y.video_id===h)===-1){if(i.settings.watched_history.length>=Q.WATCHED_HISTORY_MAX_COUNT){const y=i.settings.watched_history.reduce((n,p,L,P)=>p.created_at<P[n].created_at?L:n,0);i.settings.watched_history.splice(y,1)}i.settings.watched_history.push({video_id:h,last_playback_position:this.player.video.currentTime,created_at:w.time(),updated_at:w.time()}),console.log(`\x1B[31m[PlayerController] Watched history added. (Video ID: ${h}, last_playback_position: ${this.player.video.currentTime})`)}},Q.WATCHED_HISTORY_THRESHOLD_SECONDS*1e3)}}setupFullscreenHandler(){G(this.player!==null);const e=U(),o=document.body;this.player.fullScreen.isFullScreen=a=>!!(document.fullscreenElement||document.webkitFullscreenElement),this.player.fullScreen.request=a=>{if(G(this.player!==null),this.player.fullScreen.isFullScreen()){this.player.fullScreen.cancel();return}if(o.requestFullscreen=o.requestFullscreen||o.webkitRequestFullscreen,o.requestFullscreen)o.requestFullscreen();else{this.player.notice("iPhone Safari は動画のフルスクリーン表示に対応していません。",void 0,void 0,"#FF6F6A");return}screen.orientation&&screen.orientation.lock("landscape").catch(()=>{})},this.player.fullScreen.cancel=a=>{document.exitFullscreen=document.exitFullscreen||document.webkitExitFullscreen,document.exitFullscreen&&document.exitFullscreen(),screen.orientation&&screen.orientation.unlock()};const i=()=>{G(this.player!==null),e.is_fullscreen=this.player.fullScreen.isFullScreen()===!0};o.onfullscreenchange!==void 0?o.onfullscreenchange=i:o.onwebkitfullscreenchange!==void 0&&(o.onwebkitfullscreenchange=i)}setupSettingPanelHandler(){G(this.player!==null);const e=U(),o=this.player.setting.hide,i=this.player.setting.show;this.player.setting.hide=()=>{this.player!==null&&(o.call(this.player.setting),e.is_player_setting_panel_open=!1)},this.player.setting.show=()=>{this.player!==null&&(i.call(this.player.setting),e.is_player_setting_panel_open=!0)},this.player.template.audio.insertAdjacentHTML("afterend",`
            <div class="dplayer-setting-item dplayer-setting-mobile-profile">
                <span class="dplayer-label">モバイル回線向け画質</span>
                <div class="dplayer-toggle">
                    <input class="dplayer-mobile-profile-setting-input" type="checkbox" name="dplayer-toggle-mobile-profile">
                    <label for="dplayer-toggle-mobile-profile" style="--theme-color:#E64F97"></label>
                </div>
            </div>
        `);const a=this.player.container.querySelector(".dplayer-mobile-profile-setting-input");a.checked=this.quality_profile_type==="Cellular",this.player.container.querySelector(".dplayer-setting-mobile-profile").addEventListener("click",()=>{a.checked=!a.checked,a.checked?(this.quality_profile_type="Cellular",e.event_emitter.emit("PlayerRestartRequired",{message:"モバイル回線向けの画質プロファイルに切り替えました。",message_delay_seconds:this.quality_profile.tv_low_latency_mode||this.playback_mode==="Video"?2:4.5,is_error_message:!1})):(this.quality_profile_type="Wi-Fi",e.event_emitter.emit("PlayerRestartRequired",{message:"Wi-Fi 回線向けの画質プロファイルに切り替えました。",message_delay_seconds:this.quality_profile.tv_low_latency_mode||this.playback_mode==="Video"?2:4.5,is_error_message:!1}))}),this.player.template.settingOriginPanel.insertAdjacentHTML("beforeend",`
            <div class="dplayer-setting-item dplayer-setting-lshaped-screen-crop">
                <span class="dplayer-label">Ｌ字画面のクロップ</span>
                <div class="dplayer-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 32 32">
                        <path d="M22 16l-10.105-10.6-1.895 1.987 8.211 8.613-8.211 8.612 1.895 1.988 8.211-8.613z"></path>
                    </svg>
                </div>
            </div>
        `),this.player.template.settingOriginPanel.querySelector(".dplayer-setting-lshaped-screen-crop").addEventListener("click",()=>{G(this.player!==null),this.player.setting.hide(),e.lshaped_screen_crop_settings_modal=!0}),w.isTouchDevice()===!1&&(this.player.template.settingOriginPanel.insertAdjacentHTML("beforeend",`
                <div class="dplayer-setting-item dplayer-setting-keyboard-shortcut">
                    <span class="dplayer-label">キーボードショートカット</span>
                    <div class="dplayer-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 32 32">
                            <path d="M22 16l-10.105-10.6-1.895 1.987 8.211 8.613-8.211 8.612 1.895 1.988 8.211-8.613z"></path>
                        </svg>
                    </div>
                </div>
            `),this.player.template.settingOriginPanel.querySelector(".dplayer-setting-keyboard-shortcut").addEventListener("click",()=>{G(this.player!==null),this.player.setting.hide(),e.shortcut_key_modal=!0}))}setupLShapedScreenCropHandler(){G(this.player!==null);const e=Z();let o=this.player.video;this.player.on("quality_end",()=>{!this.player||!this.player.video||(o=this.player.video,i())});const i=()=>{if(e.settings.lshaped_screen_crop_enabled===!1){o.style.position="",o.style.transform="",o.style.transformOrigin="";return}const a=e.settings.lshaped_screen_crop_zoom_level,l=e.settings.lshaped_screen_crop_x_position,r=e.settings.lshaped_screen_crop_y_position,f=e.settings.lshaped_screen_crop_zoom_origin;if(a===100&&l===0&&r===0)o.style.position="",o.style.transform="",o.style.transformOrigin="";else{switch(o.style.position="relative",o.style.transform="",f){case"TopRight":{o.style.transformOrigin="right top",o.style.transform+=`translateX(${(a-100)*(l/100)}%) `,o.style.transform+=`translateY(-${(a-100)*(r/100)}%) `;break}case"BottomRight":{o.style.transformOrigin="right bottom",o.style.transform+=`translateX(${(a-100)*(l/100)}%) `,o.style.transform+=`translateY(${(a-100)*(r/100)}%) `;break}case"TopLeft":{o.style.transformOrigin="left top",o.style.transform+=`translateX(-${(a-100)*(l/100)}%) `,o.style.transform+=`translateY(-${(a-100)*(r/100)}%) `;break}case"BottomLeft":{o.style.transformOrigin="left bottom",o.style.transform+=`translateX(-${(a-100)*(l/100)}%) `,o.style.transform+=`translateY(${(a-100)*(r/100)}%) `;break}}o.style.transform+=`scale(${a/100})`}};i(),this.lshaped_screen_crop_watchers=[se(()=>e.settings.lshaped_screen_crop_enabled,i,{immediate:!0}),se(()=>e.settings.lshaped_screen_crop_zoom_level,i,{immediate:!0}),se(()=>e.settings.lshaped_screen_crop_x_position,i,{immediate:!0}),se(()=>e.settings.lshaped_screen_crop_y_position,i,{immediate:!0}),se(()=>e.settings.lshaped_screen_crop_zoom_origin,i,{immediate:!0})]}setupPlayerContainerResizeHandler(){const e=document.querySelector(".watch-player"),o=()=>{if(this.player===null)return;const i=this.player.danmaku.container,a=i.clientWidth,l=i.clientWidth*(9/16);if(e===null||e.clientHeight===null)return;const r=(e.clientHeight-l)/2,f=w.isSmartphoneVertical()?0:w.isSmartphoneHorizontal()?50:66;if(r<f){const v=(f-r)*2,u=a,h=l-v,c=(p,L)=>L===0?p:c(L,p%L),y=c(u,h),n=`${u/y} / ${h/y}`;i.style.transition="none",i.style.setProperty("--comment-area-aspect-ratio",n),i.style.setProperty("--comment-area-vertical-margin",`${v}px`),window.setTimeout(()=>i.style.transition="",.2*1e3)}else i.style.removeProperty("--comment-area-aspect-ratio"),i.style.removeProperty("--comment-area-vertical-margin")};o(),this.player_container_resize_observer=new ResizeObserver(o),this.player_container_resize_observer.observe(e)}setControlDisplayTimer(e=null,o=!1,i=3){const a=U();if(w.isTouchDevice()===!0&&e!==null&&e.type==="mousemove"||w.isTouchDevice()===!1&&e!==null&&(e.type==="touchmove"||e.type==="click"))return;window.clearTimeout(this.player_control_ui_hide_timer_id);const l=()=>{if(this.player!==null){if(this.player.template.controller.classList.contains("dplayer-controller-comment")){this.player_control_ui_hide_timer_id=window.setTimeout(l,i*1e3);return}a.is_control_display=!1,this.player.controller.hide(),this.player.setting.hide()}};this.player!==null&&(w.isTouchDevice()===!0&&o===!0?this.player.controller.isShow()?(a.is_control_display=!0,this.player.controller.show(),this.player_control_ui_hide_timer_id=window.setTimeout(l,i*1e3)):(a.is_control_display=!1,this.player.controller.hide(),this.player.setting.hide()):(a.is_control_display=!0,this.player.controller.show(),this.player_control_ui_hide_timer_id=window.setTimeout(l,i*1e3)))}async destroy(){const e=Z(),o=U();if(this.destroyed!==!0&&this.destroying!==!0){if(this.destroying=!0,this.playback_mode==="Video"&&this.player&&this.player.video){const i=e.settings.watched_history.findIndex(a=>a.video_id===o.recorded_program.id);if(i!==-1){const a=this.player.video.currentTime-10;e.settings.watched_history[i].last_playback_position=a,e.settings.watched_history[i].updated_at=w.time(),console.log(`\x1B[31m[PlayerController] Last playback position updated. (Video ID: ${o.recorded_program.id}, last_playback_position: ${a})`)}}if(console.log("\x1B[31m[PlayerController] Destroying..."),await Promise.all(this.player_managers.map(async i=>i.destroy())),this.player_managers=[],this.screen_wake_lock!==null&&(this.screen_wake_lock.release(),this.screen_wake_lock=null,console.log("\x1B[31m[PlayerController] Screen Wake Lock API: Screen Wake Lock released.")),o.is_background_display=!1,o.is_loading=!0,o.live_comment_init_failed_message=null,o.video_comment_init_failed_message=null,this.player!==null){const a=this.player.user.get("volume")/10;for(let l=0;l<10;l++)await w.sleep(.2/10),this.player&&this.player.video&&(this.player.video.volume=Math.max(w.mathFloor(this.player.video.volume-a,3),0));this.player.video.volume=0}if(this.live_force_seek_interval_timer_cancel!==null&&(this.live_force_seek_interval_timer_cancel(),this.live_force_seek_interval_timer_cancel=null),this.video_keep_alive_interval_timer_cancel!==null&&(this.video_keep_alive_interval_timer_cancel(),this.video_keep_alive_interval_timer_cancel=null),window.clearTimeout(this.watched_history_threshold_timer_id),window.clearTimeout(this.player_control_ui_hide_timer_id),this.player_container_resize_observer!==null&&(this.player_container_resize_observer.disconnect(),this.player_container_resize_observer=null),this.lshaped_screen_crop_watchers.length>0&&(this.lshaped_screen_crop_watchers.forEach(i=>i()),this.lshaped_screen_crop_watchers=[]),this.player!==null){if(this.player.events.events.error&&(this.player.events.events.error=[]),this.player.plugins.mpegts)try{this.player.plugins.mpegts.unload(),this.player.plugins.mpegts.detachMediaElement(),this.player.plugins.mpegts.destroy()}catch{}this.player.danmaku.clear();try{this.player.destroy(!0)}catch{}this.player=null}this.destroying=!1,this.destroyed=!0,o.is_player_initialized=!1,console.log("\x1B[31m[PlayerController] Destroyed.")}}};H(Q,"LIVE_PLAYBACK_BUFFER_SECONDS_LOW_LATENCY",.9),H(Q,"LIVE_PLAYBACK_BUFFER_SECONDS",4),H(Q,"WATCHED_HISTORY_MAX_COUNT",50),H(Q,"WATCHED_HISTORY_THRESHOLD_SECONDS",30),H(Q,"WATCHED_HISTORY_UPDATE_INTERVAL",10);let ze=Q;export{ze as P,In as W};

import{d as S,aQ as _,M as o,ak as h,d2 as f,u as D,_ as V,k as w,h as l,b as t,w as k,a as r,c as m,r as v,l as i,aj as p,n as a,V as B,o as g,R as I}from"./index-CAOTUcHN.js";import{S as N}from"./Base-pBiNMU11.js";import{V as u}from"./VSwitch-CB2EKF8v.js";import{b}from"./VTextField-DIbiQ9M7.js";import"./Navigation-BP6Qs9qF.js";import"./VSpacer-DeXG8oCu.js";import"./ssrBoot-D7daYucn.js";import"./index-Bh0QndNQ.js";import"./VSelectionControl-DMaDu-fq.js";import"./transition-BlS6SM8u.js";import"./forwardRefs-DboJVnh3.js";const C=S({name:"Settings-Discord",components:{SettingsBase:N},setup(){return{settingsStore:D()}},data(){return{discord_connected:!1,show_token:!1,server_settings:JSON.parse(JSON.stringify(f)),original_server_settings:JSON.parse(JSON.stringify(f)),is_admin:!1,saving:!1}},computed:{hasChanges(){return JSON.stringify(this.server_settings)!==JSON.stringify(this.original_server_settings)},channelIdRules(){return[e=>{if(!e||e==="")return!0;if(!/^\d+$/.test(e))return"チャンネルIDは数字のみで入力してください";if(e.length<17||e.length>19)return"チャンネルIDは17～19桁で入力してください";try{if(BigInt(e)<0)return"チャンネルIDは正の数値である必要があります"}catch{return"無効なチャンネルIDです"}return!0}]}},async mounted(){await this.loadSettings()},async activated(){await this.loadSettings()},methods:{async loadSettings(){const s=await h().fetchUser();this.is_admin=(s==null?void 0:s.is_admin)||!1;const d=await _.fetchServerSettings();d?(d.discord.channel_id!==null&&(d.discord.channel_id=String(d.discord.channel_id)),this.server_settings=d,this.original_server_settings=JSON.parse(JSON.stringify(d)),this.settingsStore.settings.discord.enabled=d.discord.enabled,this.settingsStore.settings.discord.notify_server=d.discord.notify_server,this.settingsStore.settings.discord.notify_recording=d.discord.notify_recording):o.error("サーバー設定を取得できませんでした。"),await this.checkConnection()},async checkConnection(){try{const e=await _.fetchDiscordStatus();this.discord_connected=e.connected}catch{this.discord_connected=!1}},async updateDiscordSettings(){this.saving=!0;try{this.server_settings.discord.channel_id!==null&&this.server_settings.discord.channel_id!==""&&(this.server_settings.discord.channel_id=String(this.server_settings.discord.channel_id)),await _.updateServerSettings(this.server_settings)===!0?(await this.loadSettings(),o.success(`Discord設定を更新しました。
変更を反映するためには、KonomiTV サーバーを再起動してください。`)):o.error("Discord設定の更新に失敗しました。")}catch(e){console.error("Discord settings update failed:",e),o.error("Discord設定の更新に失敗しました。")}finally{this.saving=!1}}}}),$={class:"settings__heading"},J={class:"settings__content"},O={class:"settings__item settings__item--switch"},T={class:"settings__item"},U={class:"settings__item-label"},R={key:0,class:"d-flex align-center"},K={key:1,class:"d-flex align-center"};function M(e,s,d,j,z,E){const c=v("Icon"),y=v("SettingsBase");return g(),w(y,null,{default:l(()=>[t("h2",$,[k((g(),m("a",{class:"settings__back-button",onClick:s[0]||(s[0]=n=>e.$router.back())},[r(c,{icon:"fluent:chevron-left-12-filled",width:"27px"})])),[[I]]),r(c,{icon:"fa-brands:discord",width:"19px",style:{margin:"0 4px"}}),s[8]||(s[8]=t("span",{class:"ml-3"},"Discord連携",-1))]),t("div",J,[t("div",O,[s[9]||(s[9]=t("label",{class:"settings__item-heading",for:"discord_enabled"},"Discord連携機能を有効にする",-1)),s[10]||(s[10]=t("label",{class:"settings__item-label",for:"discord_enabled"},[i(" KonomiTVとDiscordを連携すると、各種通知をDiscordに送信できるようになります。"),t("br"),i(" 使用するにはDiscord Botのトークンの設定が必要です。"),t("br")],-1)),r(u,{class:"settings__item-switch",color:"primary",id:"discord_enabled","hide-details":"",disabled:!e.is_admin,modelValue:e.server_settings.discord.enabled,"onUpdate:modelValue":s[1]||(s[1]=n=>e.server_settings.discord.enabled=n)},null,8,["disabled","modelValue"])]),t("div",T,[s[15]||(s[15]=t("div",{class:"settings__item-heading"},"Discord接続状態",-1)),t("div",U,[e.discord_connected?(g(),m("div",R,[r(p,{color:"success",class:"mr-2"},{default:l(()=>[...s[11]||(s[11]=[i("mdi-check-circle",-1)])]),_:1}),s[12]||(s[12]=t("span",null,"Botが正常に接続されています",-1))])):(g(),m("div",K,[r(p,{color:"error",class:"mr-2"},{default:l(()=>[...s[13]||(s[13]=[i("mdi-alert-circle",-1)])]),_:1}),s[14]||(s[14]=t("span",null,"Botが接続されていません。Bot Tokenを確認してください。",-1))]))])]),t("div",{class:a(["settings__item",{"settings__content--disabled":!e.is_admin||!e.server_settings.discord.enabled}])},[s[16]||(s[16]=t("div",{class:"settings__item-heading"},"Discord Bot Token",-1)),s[17]||(s[17]=t("div",{class:"settings__item-label"},[i(" Discord Botのトークンを入力してください。"),t("br"),i(" トークンはDiscordの開発者ポータルで取得できます。"),t("br")],-1)),r(b,{class:"settings__item-form",color:"primary",variant:"outlined","hide-details":"",modelValue:e.server_settings.discord.token,"onUpdate:modelValue":s[2]||(s[2]=n=>e.server_settings.discord.token=n),disabled:!e.is_admin||!e.server_settings.discord.enabled,"append-icon":e.show_token?"mdi-eye":"mdi-eye-off",type:e.show_token?"text":"password",placeholder:"Discord Bot Token","onClick:append":s[3]||(s[3]=n=>e.show_token=!e.show_token)},null,8,["modelValue","disabled","append-icon","type"])],2),t("div",{class:a(["settings__item",{"settings__content--disabled":!e.is_admin||!e.server_settings.discord.enabled}])},[s[18]||(s[18]=t("div",{class:"settings__item-heading"},"通知チャンネルID",-1)),s[19]||(s[19]=t("div",{class:"settings__item-label"},[i(" 通知を送信するDiscordチャンネルのIDを入力してください。"),t("br"),i(" チャンネルIDはDiscordのチャンネルを右クリック→IDをコピーで取得できます。"),t("br")],-1)),r(b,{class:"settings__item-form",color:"primary",variant:"outlined",modelValue:e.server_settings.discord.channel_id,"onUpdate:modelValue":s[4]||(s[4]=n=>e.server_settings.discord.channel_id=n),disabled:!e.is_admin||!e.server_settings.discord.enabled,placeholder:"例: 123456789012345678",type:"text",rules:e.channelIdRules,"hide-details":"auto"},null,8,["modelValue","disabled","rules"])],2),t("div",{class:a(["settings__item settings__item--switch",{"settings__content--disabled":!e.server_settings.discord.enabled}])},[s[20]||(s[20]=t("label",{class:"settings__item-heading",for:"discord_notify_server"},"起動/終了の通知",-1)),s[21]||(s[21]=t("label",{class:"settings__item-label",for:"discord_notify_server"},[i(" サーバーの起動時と終了時に通知を送信します。"),t("br"),i(" 通知が不要な場合は、この設定をオフにできます。"),t("br")],-1)),r(u,{class:"settings__item-switch",color:"primary",id:"discord_notify_server","hide-details":"",disabled:!e.server_settings.discord.enabled,modelValue:e.server_settings.discord.notify_server,"onUpdate:modelValue":s[5]||(s[5]=n=>e.server_settings.discord.notify_server=n)},null,8,["disabled","modelValue"])],2),t("div",{class:a(["settings__item settings__item--switch",{"settings__content--disabled":!e.server_settings.discord.enabled}])},[s[22]||(s[22]=t("label",{class:"settings__item-heading",for:"discord_notify_recording"},"録画予約/完了の通知",-1)),s[23]||(s[23]=t("label",{class:"settings__item-label",for:"discord_notify_recording"},[i(" 録画予約の開始時と完了時に通知を送信します。"),t("br"),i(" 通知が不要な場合は、この設定をオフにできます。"),t("br")],-1)),r(u,{class:"settings__item-switch",color:"primary",id:"discord_notify_recording","hide-details":"",disabled:!e.server_settings.discord.enabled,modelValue:e.server_settings.discord.notify_recording,"onUpdate:modelValue":s[6]||(s[6]=n=>e.server_settings.discord.notify_recording=n)},null,8,["disabled","modelValue"])],2),s[25]||(s[25]=t("div",{class:"settings__description mt-3"},[i(" 設定を変更した場合は、[Discord設定を更新] ボタンを押して保存してください。"),t("br"),i(" 変更を反映するには KonomiTV サーバーの再起動が必要です。"),t("br")],-1)),r(B,{class:"settings__save-button bg-secondary mt-6",variant:"flat",onClick:s[7]||(s[7]=n=>e.updateDiscordSettings())},{default:l(()=>[r(c,{icon:"fluent:save-16-filled",class:"mr-2",height:"23px"}),s[24]||(s[24]=i("Discord設定を更新 ",-1))]),_:1})])]),_:1})}const Z=V(C,[["render",M]]);export{Z as default};

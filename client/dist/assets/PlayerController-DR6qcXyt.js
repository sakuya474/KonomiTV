var Te=Object.defineProperty;var Le=(t,e,s)=>e in t?Te(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var T=(t,e,s)=>Le(t,typeof e!="symbol"?e+"":e,s);import{d as E,m as z,ao as W,U as y,P as oe,_ as B,c as _,w as g,e as V,b as a,a as p,k as F,h as M,r as L,t as k,n as S,o as c,R as b,G as ke,H as Se,a0 as Ce,a9 as de,ap as Pe,q as Re,W as Me,aq as Ie,ar as pe,as as Ae,F as N,u as D,af as $,f as se,g as j,l as x,V as Ve,at as X,M as xe,ag as $e,p as te,ai as J,au as ne,v as Ee,j as Be,av as ue,aw as He,ax as De,z as Y}from"./index-Cat5FXVK.js";import{u as q,C as ie,a as Oe}from"./ChannelsStore-BumYbPLu.js";import{u as I,a as H}from"./symbol-UvB5_Hcr.js";import{V as me,_ as Fe}from"./VSpacer-BUU6498a.js";import{W as Ue,K as Ne,B as qe,H as ae,m as G,D as We,L as ze,a as je,b as he,c as ye,M as fe}from"./MediaSessionManager-D3HKLsSy.js";import{V as Ye}from"./VDialog-BYCiQgZW.js";import{V as Ge,d as Ke}from"./VCard-DMfFDPZS.js";import{V as Je}from"./VSwitch-S79dae-w.js";import{V as re}from"./VSlider-Di0UgsMm.js";import{V as ge,m as Xe,a as Ze}from"./VTextField-CKgx3ZWR.js";import{V as _e,m as Qe,a as et,b as tt}from"./VSelectionControl-TheHVKhX.js";import{S as st,a as it}from"./swiper-CQeOJ4uO.js";import{F as at}from"./index-B7Sm2Rmf.js";import{C as ot}from"./CommentMuteSettings-By1Z3PNG.js";import{b as le,c as ce,a as nt}from"./VMenu-BdgALB6N.js";import{d as rt}from"./vuedraggable.umd-CgGR_JaB.js";import{T as lt,u as ct}from"./Twitter-Bacq8HsU.js";import{C as ve}from"./CaptureManager--2cadF73.js";import{V as dt}from"./Videos-BsQ1YiC4.js";import{P as K}from"./PlayerUtils-D6ABkBVB.js";const _t=E({name:"Watch-Header",props:{playback_mode:{type:String,required:!0}},data(){return{Utils:Object.freeze(y),ProgramUtils:Object.freeze(oe),time:W().format(y.isSmartphoneHorizontal()?"HH:mm:ss":"YYYY/MM/DD HH:mm:ss")}},computed:{...z(q,I)},methods:{formatTime(t){const e=y.isSmartphoneHorizontal(),s=t.format(e?"HH:mm:ss":"YYYY/MM/DD HH:mm:ss");return y.apply28HourClock(s)},updateTimeCore(){const t=W();this.time=this.formatTime(t);const e=t.millisecond();return e>800?500:1e3-e},uptimeTime(){setTimeout(()=>{this.uptimeTime()},this.updateTimeCore())}},created(){this.time=this.formatTime(W()),setTimeout(()=>{this.uptimeTime()},1e3)},beforeUnmount(){this.uptimeTime=()=>{}}}),mt=["src"],pt=["innerHTML"],ut={class:"watch-header__program-time"},ht={class:"watch-header__now"};function yt(t,e,s,i,o,d){const l=L("Icon"),f=L("router-link");return c(),_("header",{class:S(["watch-header",{"watch-header--video":t.playback_mode==="Video"}])},[g((c(),F(f,{class:"watch-header__back-icon",to:t.playback_mode==="Live"?"/tv/":"/videos/"},{default:M(()=>[p(l,{icon:"fluent:chevron-left-12-filled",width:"21px"})]),_:1},8,["to"])),[[b]]),t.playback_mode==="Live"?(c(),_("img",{key:0,class:"watch-header__broadcaster",src:`${t.Utils.api_base_url}/channels/${t.channelsStore.channel.current.id}/logo`},null,8,mt)):V("",!0),a("span",{class:"watch-header__program-title",innerHTML:t.ProgramUtils.decorateProgramInfo(t.playback_mode==="Live"?t.channelsStore.channel.current.program_present:t.playerStore.recorded_program,"title")},null,8,pt),a("span",ut,k(t.ProgramUtils.getProgramTime(t.playback_mode==="Live"?t.channelsStore.channel.current.program_present:t.playerStore.recorded_program,!0)),1),p(me),a("span",ht,k(t.time),1)],2)}const ft=B(_t,[["render",yt],["__scopeId","data-v-b8c95e7e"]]),gt=Se({...Qe({falseIcon:"$radioOff",trueIcon:"$radioOn"})},"VRadio"),ee=ke()({name:"VRadio",props:gt(),setup(t,e){let{slots:s}=e;return Ce(()=>{const i=_e.filterProps(t);return p(_e,de(i,{class:["v-radio",t.class],style:t.style,type:"radio"}),s)}),{}}}),vt=Se({height:{type:[Number,String],default:"auto"},...Xe(),...Ae(et(),["multiple"]),trueIcon:{type:pe,default:"$radioOn"},falseIcon:{type:pe,default:"$radioOff"},type:{type:String,default:"radio"}},"VRadioGroup"),bt=ke()({name:"VRadioGroup",inheritAttrs:!1,props:vt(),emits:{"update:modelValue":t=>!0},setup(t,e){let{attrs:s,slots:i}=e;const o=Pe(),d=Re(()=>t.id||`radio-group-${o}`),l=Me(t,"modelValue");return Ce(()=>{const[f,v]=Ie(s),m=ge.filterProps(t),u=_e.filterProps(t),r=i.label?i.label({label:t.label,props:{for:d.value}}):t.label;return p(ge,de({class:["v-radio-group",t.class],style:t.style},f,m,{modelValue:l.value,"onUpdate:modelValue":w=>l.value=w,id:d.value}),{...i,default:w=>{let{id:n,messagesId:h,isDisabled:C,isReadonly:P}=w;return p(N,null,[r&&p(Ze,{id:n.value},{default:()=>[r]}),p(tt,de(u,{id:n.value,"aria-describedby":h.value,defaultsTarget:"VRadio",trueIcon:t.trueIcon,falseIcon:t.falseIcon,type:t.type,disabled:C.value,readonly:P.value,"aria-labelledby":r?n.value:void 0,multiple:!1},v,{modelValue:l.value,"onUpdate:modelValue":R=>l.value=R}),i)])}})}),{}}}),wt={class:"px-5 pb-6"},kt={class:"d-flex align-center",style:{width:"85px"}},St={class:"text-right",style:{width:"42px"}},Ct={class:"d-flex align-center",style:{width:"85px"}},$t={class:"text-right",style:{width:"42px"}},Tt={class:"d-flex align-center",style:{width:"85px"}},Lt={class:"text-right",style:{width:"42px"}},Pt=E({__name:"LShapedScreenCropSettings",setup(t){const e=D(),s=I();return(i,o)=>{const d=L("Icon");return c(),F(Ye,{"max-width":"700",transition:"slide-y-transition",modelValue:$(s).lshaped_screen_crop_settings_modal,"onUpdate:modelValue":o[6]||(o[6]=l=>$(s).lshaped_screen_crop_settings_modal=l)},{default:M(()=>[p(Ke,{class:"lshaped-screen-crop-settings-modal"},{default:M(()=>[p(Ge,{class:"px-5 pt-3 pb-3 d-flex align-center font-weight-bold"},{default:M(()=>[p(d,{icon:"fluent:crop-20-filled",height:"28px"}),o[7]||(o[7]=a("span",{class:"ml-3"},"Ｌ字画面のクロップ",-1)),p(me),p(Je,{class:"mr-4",color:"primary","hide-details":"",modelValue:$(e).settings.lshaped_screen_crop_enabled,"onUpdate:modelValue":o[0]||(o[0]=l=>$(e).settings.lshaped_screen_crop_enabled=l)},null,8,["modelValue"]),g((c(),_("div",{class:"d-flex align-center rounded-circle cursor-pointer px-2 py-2",onClick:o[1]||(o[1]=l=>$(s).lshaped_screen_crop_settings_modal=!1)},[p(d,{icon:"fluent:dismiss-12-filled",width:"23px",height:"23px"})])),[[b]])]),_:1}),a("div",wt,[p(re,{color:"primary",modelValue:$(e).settings.lshaped_screen_crop_zoom_level,"onUpdate:modelValue":o[2]||(o[2]=l=>$(e).settings.lshaped_screen_crop_zoom_level=l),min:100,max:200,step:1,"show-ticks":"always","hide-details":"",class:"ml-0 mr-0 mb-4"},{prepend:M(()=>[a("div",kt,[p(d,{icon:"mdi:magnify",width:"20px"}),o[8]||(o[8]=a("span",{class:"ml-2"},"拡大率",-1))])]),append:M(()=>[a("div",St,k($(e).settings.lshaped_screen_crop_zoom_level)+"%",1)]),_:1},8,["modelValue"]),p(re,{color:"primary",modelValue:$(e).settings.lshaped_screen_crop_x_position,"onUpdate:modelValue":o[3]||(o[3]=l=>$(e).settings.lshaped_screen_crop_x_position=l),min:0,max:100,step:1,"show-ticks":"always","hide-details":"",class:"ml-0 mr-0 mb-4"},{prepend:M(()=>[a("div",Ct,[p(d,{icon:"mdi:arrow-left-right",width:"20px"}),o[9]||(o[9]=a("span",{class:"ml-2"},"Ｘ座標",-1))])]),append:M(()=>[a("div",$t,k($(e).settings.lshaped_screen_crop_x_position)+"%",1)]),_:1},8,["modelValue"]),p(re,{color:"primary",modelValue:$(e).settings.lshaped_screen_crop_y_position,"onUpdate:modelValue":o[4]||(o[4]=l=>$(e).settings.lshaped_screen_crop_y_position=l),min:0,max:100,step:1,"show-ticks":"always","hide-details":"",class:"ml-0 mr-0 mb-4"},{prepend:M(()=>[a("div",Tt,[p(d,{icon:"mdi:arrow-up-down",width:"20px"}),o[10]||(o[10]=a("span",{class:"ml-2"},"Ｙ座標",-1))])]),append:M(()=>[a("div",Lt,k($(e).settings.lshaped_screen_crop_y_position)+"%",1)]),_:1},8,["modelValue"]),o[11]||(o[11]=a("div",{class:"mt-5 ml-0"},[a("div",{class:"d-flex align-center"},[a("span",null,"拡大起点")]),a("div",{class:"text-text-darken-1 mt-2",style:{"font-size":"13.5px"}}," 拡大率を変更したときに、どの位置を基準に拡大するかを設定します。 ")],-1)),p(bt,{class:"zoom-origin-radio-group mt-3 ml-0",color:"primary",inline:"","hide-details":"",modelValue:$(e).settings.lshaped_screen_crop_zoom_origin,"onUpdate:modelValue":o[5]||(o[5]=l=>$(e).settings.lshaped_screen_crop_zoom_origin=l)},{default:M(()=>[p(ee,{label:"左上",value:"TopLeft"}),p(ee,{label:"左下",value:"BottomLeft"}),p(ee,{label:"右上",value:"TopRight"}),p(ee,{label:"右下",value:"BottomRight"})]),_:1},8,["modelValue"])])]),_:1})]),_:1},8,["modelValue"])}}}),Rt=B(Pt,[["__scopeId","data-v-d082ffe0"]]),Mt=E({name:"Panel-ChannelTab",components:{Swiper:it,SwiperSlide:st},data(){return{Utils:Object.freeze(y),ChannelUtils:Object.freeze(ie),ProgramUtils:Object.freeze(oe),active_tab_index:0,swiper_instance:null}},computed:{...z(q,I)},watch:{active_tab_index(){var t,e;(t=this.swiper_instance)==null||t.updateAutoHeight(),(e=this.swiper_instance)==null||e.slideTo(this.active_tab_index)},async"playerStore.tv_panel_active_tab"(){var t;await y.sleep(.05),(t=this.swiper_instance)==null||t.updateAutoHeight()},async"playerStore.video_panel_active_tab"(){var t;await y.sleep(.05),(t=this.swiper_instance)==null||t.updateAutoHeight()}},async mounted(){var t,e,s;if(await y.sleep(.05),(t=this.swiper_instance)==null||t.updateAutoHeight(),(e=document.querySelector(".channels-list-container"))==null||e.addEventListener("scroll",()=>{var i;(i=this.swiper_instance)==null||i.updateAutoHeight()},{passive:!0}),this.playerStore.tv_panel_active_tab==="Channel")for(let i=0;i<20;i++)await y.sleep(.1),(s=this.swiper_instance)==null||s.updateAutoHeight()}}),It={class:"channels-container channels-container--watch"},At={class:"channels-tab"},Vt={class:"channels-list-container"},xt={class:"channels"},Et={class:"channel__broadcaster"},Bt=["src"],Ht={class:"channel__broadcaster-content"},Dt={class:"channel__broadcaster-name"},Ot={class:"ml-1"},Ft={class:"channel__program-present"},Ut=["innerHTML"],Nt={class:"channel__program-present-time"},qt={class:"channel__program-following"},Wt={class:"channel__program-following-title"},zt=["innerHTML"],jt={class:"channel__program-following-time"},Yt={class:"channel__progressbar"};function Gt(t,e,s,i,o,d){const l=L("router-link"),f=L("SwiperSlide"),v=L("Swiper");return c(),_("div",It,[a("div",At,[a("div",{class:"channels-tab__buttons",style:se({"--tab-length":Array.from(t.channelsStore.channels_list_with_pinned_for_watch).length,"--active-tab-index":t.active_tab_index})},[(c(!0),_(N,null,j(Array.from(t.channelsStore.channels_list_with_pinned_for_watch),([m],u)=>(c(),F(Ve,{variant:"flat",class:"channels-tab__button",key:m,onClick:r=>t.active_tab_index=u},{default:M(()=>[x(k(m),1)]),_:2},1032,["onClick"]))),128)),e[2]||(e[2]=a("div",{class:"channels-tab__highlight"},null,-1))],4)]),a("div",Vt,[p(v,{class:"channels-list","space-between":32,"auto-height":!0,"touch-start-prevent-default":!1,observer:!0,"observe-parents":!0,onSwiper:e[0]||(e[0]=m=>t.swiper_instance=m),onSlideChange:e[1]||(e[1]=m=>t.active_tab_index=m.activeIndex)},{default:M(()=>[(c(!0),_(N,null,j(Array.from(t.channelsStore.channels_list_with_pinned_for_watch),([m,u])=>(c(),F(f,{key:m},{default:M(()=>[a("div",xt,[(c(!0),_(N,null,j(u,r=>g((c(),F(l,{class:"channel",draggable:"false",key:r.id,to:`/tv/watch/${r.display_channel_id}`},{default:M(()=>[a("div",Et,[a("img",{class:"channel__broadcaster-icon",loading:"lazy",decoding:"async",src:`${t.Utils.api_base_url}/channels/${r.id}/logo`},null,8,Bt),a("div",Ht,[a("span",Dt,"Ch: "+k(r.channel_number)+" "+k(r.name),1),a("div",{class:S(["channel__broadcaster-force",`channel__broadcaster-force--${t.ChannelUtils.getChannelForceType(r.jikkyo_force)}`])},[e[3]||(e[3]=a("svg",{class:"iconify iconify--fa-solid",width:"9.63px",height:"11px",viewBox:"0 0 448 512"},[a("path",{fill:"currentColor",d:"M323.56 51.2c-20.8 19.3-39.58 39.59-56.22 59.97C240.08 73.62 206.28 35.53 168 0C69.74 91.17 0 209.96 0 281.6C0 408.85 100.29 512 224 512s224-103.15 224-230.4c0-53.27-51.98-163.14-124.44-230.4zm-19.47 340.65C282.43 407.01 255.72 416 226.86 416C154.71 416 96 368.26 96 290.75c0-38.61 24.31-72.63 72.79-130.75c6.93 7.98 98.83 125.34 98.83 125.34l58.63-66.88c4.14 6.85 7.91 13.55 11.27 19.97c27.35 52.19 15.81 118.97-33.43 153.42z"})],-1)),a("span",Ot,k(r.jikkyo_force??"--"),1)],2)])]),a("div",Ft,[a("span",{class:"channel__program-present-title",innerHTML:t.ProgramUtils.decorateProgramInfo(r.program_present,"title")},null,8,Ut),a("span",Nt,k(t.ProgramUtils.getProgramTime(r.program_present)),1)]),a("div",qt,[a("div",Wt,[e[4]||(e[4]=a("span",{class:"channel__program-following-title-decorate"},"NEXT",-1)),e[5]||(e[5]=a("svg",{class:"channel__program-following-title-icon iconify iconify--fluent",width:"16px",height:"16px",viewBox:"0 0 20 20"},[a("path",{fill:"currentColor",d:"M10.018 5.486a1 1 0 0 1 1.592-.806l5.88 4.311a1.25 1.25 0 0 1 0 2.017l-5.88 4.311a1 1 0 0 1-1.592-.806v-3.16L4.61 15.319a1 1 0 0 1-1.592-.806V5.486A1 1 0 0 1 4.61 4.68l5.408 3.966v-3.16Z"})],-1)),a("span",{class:"channel__program-following-title-text",innerHTML:t.ProgramUtils.decorateProgramInfo(r.program_following,"title")},null,8,zt)]),a("span",jt,k(t.ProgramUtils.getProgramTime(r.program_following)),1)]),a("div",Yt,[a("div",{class:"channel__progressbar-progress",style:se(`width:${t.ProgramUtils.getProgramProgress(r.program_present)}%;`)},null,4)])]),_:2},1032,["to"])),[[b]])),128))])]),_:2},1024))),128))]),_:1})])])}const Kt=B(Mt,[["render",Gt],["__scopeId","data-v-6121504c"]]),Jt=E({name:"Panel-CommentTab",components:{CommentMuteSettings:ot,VirtuaList:at},props:{playback_mode:{type:String,required:!0}},data(){return{Utils:Object.freeze(y),is_manual_scroll:!1,is_auto_scrolling:!1,comment_list:[],comment_list_element:null,is_comment_list_dropdown_display:!1,comment_list_dropdown_top:0,comment_list_dropdown_comment:null,comment_mute_settings_modal:!1,visibilitychange_listener:null,current_playback_position:0,target_comment_index:0,virtua_scroller:null}},computed:{...z(q,I)},watch:{"channelsStore.channel.current.id":{handler(){this.playback_mode==="Live"&&(this.comment_list=[])}}},mounted(){this.comment_list_element===null&&(this.comment_list_element=document.querySelector(".comment-list")),this.playback_mode==="Video"&&(this.virtua_scroller=this.$refs.virtua_scroller);let t=!1;this.comment_list_element.onmousedown=d=>{if(this.comment_list_element===null)return;d.clientX-this.comment_list_element.getBoundingClientRect().left>this.comment_list_element.clientWidth&&(t=!0)},this.comment_list_element.onmouseup=d=>{if(this.comment_list_element===null)return;d.clientX-this.comment_list_element.getBoundingClientRect().left>this.comment_list_element.clientWidth&&(t=!1)};const e=()=>{t=!0,window.setTimeout(()=>t=!1,100)};let s=!1;this.comment_list_element.ontouchstart=()=>s=!0,this.comment_list_element.ontouchend=()=>s=!1,this.comment_list_element.ontouchmove=()=>s===!0?e():"",this.comment_list_element.onwheel=e,this.comment_list_element.onscroll=async()=>{this.comment_list_element!==null&&this.is_auto_scrolling===!1&&t===!0&&(this.is_manual_scroll=!0,console.log("[Comment.vue] Manual scroll is enabled."),await y.sleep(.1),this.playback_mode==="Live"&&this.comment_list_element.scrollTop+this.comment_list_element.offsetHeight>this.comment_list_element.scrollHeight-10&&(this.is_manual_scroll=!1,console.log("[Comment.vue] Manual scroll is disabled because bottom of comment list is reached.")))};const i=[],o=500;this.playerStore.event_emitter.on("CommentReceived",async d=>{if(d.is_initial_comments===!0)this.comment_list=[],this.comment_list.push(...d.comments),console.log(`[Comment.vue] Comment list updated. ${this.comment_list.length} comments.`),this.playback_mode==="Live"&&this.scrollCommentList(!1);else{if(document.visibilityState==="hidden"){i.push(...d.comments);return}this.comment_list.length>=o&&this.is_manual_scroll===!1&&this.comment_list.splice(0,Math.max(0,this.comment_list.length-o)),this.comment_list.push(...d.comments),this.scrollCommentList(!1)}}),this.playback_mode==="Live"&&(this.playerStore.event_emitter.on("CommentSendCompleted",async d=>{this.comment_list.push(d.comment),this.scrollCommentList(!1)}),this.visibilitychange_listener=()=>{if(document.visibilityState==="visible"){const d=this.comment_list.length+i.length;d>=o&&this.is_manual_scroll===!1&&this.comment_list.splice(0,Math.max(0,d-o)),this.comment_list.push(...i),i.length=0,this.scrollCommentList(!1)}},document.addEventListener("visibilitychange",this.visibilitychange_listener)),this.playback_mode==="Video"&&(console.log("[Comment.vue] Setting up PlaybackPositionChanged event listener."),this.playerStore.event_emitter.on("PlaybackPositionChanged",d=>{this.current_playback_position=d.playback_position,this.is_manual_scroll===!1&&this.scrollPlaybackComment(!1)}))},beforeUnmount(){this.playback_mode==="Live"&&this.visibilitychange_listener!==null&&(document.removeEventListener("visibilitychange",this.visibilitychange_listener),this.visibilitychange_listener=null),this.playerStore.event_emitter.off("CommentReceived"),this.playback_mode==="Live"&&this.playerStore.event_emitter.off("CommentSendCompleted"),this.playback_mode==="Video"&&this.playerStore.event_emitter.off("PlaybackPositionChanged"),this.comment_list=[]},methods:{showCommentListDropdown(t,e){const s=this.$refs.comment_list_wrapper.getBoundingClientRect(),i=106,o=t.currentTarget.getBoundingClientRect();this.comment_list_dropdown_top=o.top-s.top,this.comment_list_dropdown_top+i>s.height&&(this.comment_list_dropdown_top=this.comment_list_dropdown_top-i+o.height),this.comment_list_dropdown_comment=e,this.is_comment_list_dropdown_display=!0},hideCommentListDropdown(){this.is_comment_list_dropdown_display=!1,this.comment_list=this.comment_list.filter(t=>X.isMutedComment(t.text,t.user_id)===!1)},copyTextToClipboard(){this.comment_list_dropdown_comment!==null&&(navigator.clipboard.writeText(this.comment_list_dropdown_comment.text),this.hideCommentListDropdown())},addMutedKeywords(){this.comment_list_dropdown_comment!==null&&(X.addMutedKeywords(this.comment_list_dropdown_comment.text),this.hideCommentListDropdown())},addMutedNiconicoUserIds(){this.comment_list_dropdown_comment!==null&&(X.addMutedNiconicoUserIDs(this.comment_list_dropdown_comment.user_id),this.hideCommentListDropdown())},async scrollCommentList(t=!1){if(this.comment_list_element===null||(this.is_comment_list_dropdown_display===!0&&(this.is_manual_scroll=!0,console.log("[Comment.vue] Manual scroll is enabled because dropdown menu is displayed.")),this.is_manual_scroll===!0))return;this.is_auto_scrolling=!0;const e=(s=3)=>{s<=0||window.requestAnimationFrame(()=>{var i,o;t===!0?(i=this.comment_list_element)==null||i.scrollTo({top:this.comment_list_element.scrollHeight,left:0,behavior:"smooth"}):(o=this.comment_list_element)==null||o.scrollTo(0,this.comment_list_element.scrollHeight),e(s-1)})};e(),await y.sleep(.1),this.is_auto_scrolling=!1},async scrollPlaybackComment(t=!1){if(!this.virtua_scroller){console.log("[Comment.vue] VirtuaList reference is not available.");return}if(this.is_comment_list_dropdown_display===!0&&(this.is_manual_scroll=!0,console.log("[Comment.vue] Manual scroll is enabled because dropdown menu is displayed.")),this.is_manual_scroll===!0||this.playerStore.video_panel_active_tab!=="Comment")return;let e=-1;for(let s=0;s<this.comment_list.length&&this.comment_list[s].playback_position<=this.current_playback_position;s++)e=s;e===this.target_comment_index&&t===!1||(this.is_auto_scrolling=!0,e!==-1&&(this.virtua_scroller.scrollToIndex(e,{align:"end",smooth:t,offset:-3}),this.target_comment_index=e),await y.sleep(.1),this.is_auto_scrolling=!1)},handleAutoScrollButtonClick(){this.is_manual_scroll=!1,console.log("[Comment.vue] Manual scroll is disabled because Auto-scroll button clicked."),this.playback_mode==="Live"?this.scrollCommentList(!0):this.playback_mode==="Video"&&this.scrollPlaybackComment(!0)}}}),Xt={class:"comment-header"},Zt={class:"comment-header__title"},Qt={class:"comment-list-wrapper",ref:"comment_list_wrapper"},es={class:"comment__text"},ts={class:"comment__time"},ss=["onMouseup","onTouchend"],is={class:"comment__text"},as={class:"comment__time"},os=["onMouseup","onTouchend"],ns={key:2,class:"comment-announce"},rs={key:3,class:"comment-announce"},ls={class:"comment-announce__text"},cs={class:"mt-0 mb-0"},ds={key:4,class:"comment-announce"},_s={key:5,class:"comment-announce"},ms={class:"comment-announce__text"},ps={class:"mt-0 mb-0"};function us(t,e,s,i,o,d){const l=L("Icon"),f=L("DynamicScrollerItem"),v=L("DynamicScroller"),m=L("VirtuaList"),u=L("CommentMuteSettings");return c(),_("div",{class:S(["comment-container",{"comment-container--video":t.playback_mode==="Video"}])},[a("section",Xt,[a("h2",Zt,[p(l,{class:"comment-header__title-icon",icon:"bi:chat-left-text-fill",height:"18.5px"}),e[7]||(e[7]=a("span",{class:"comment-header__title-text"},"コメント",-1))]),g((c(),_("button",{class:"comment-header__button ml-auto",onClick:e[0]||(e[0]=r=>t.comment_mute_settings_modal=!t.comment_mute_settings_modal)},[p(l,{icon:"heroicons-solid:filter",height:"11px"}),e[8]||(e[8]=a("span",{class:"ml-1"},"ミュート設定",-1))])),[[b]])]),a("section",Qt,[a("div",{class:S(["comment-list-dropdown",{"comment-list-dropdown--display":t.is_comment_list_dropdown_display}]),style:se({"--comment-list-dropdown-top":`${t.comment_list_dropdown_top}px`})},[p(nt,{style:{background:"rgb(var(--v-theme-background-lighten-1))"}},{default:M(()=>[p(le,{density:"compact",style:{"min-height":"30px"},onClick:e[1]||(e[1]=r=>t.copyTextToClipboard())},{default:M(()=>[p(ce,{class:"d-flex align-center"},{default:M(()=>[p(l,{icon:"fluent:clipboard-paste-20-filled",width:"20px"}),e[9]||(e[9]=a("span",{class:"ml-2"},"クリップボードにコピー",-1))]),_:1})]),_:1}),p(le,{density:"compact",style:{"min-height":"30px"},onClick:e[2]||(e[2]=r=>t.addMutedKeywords())},{default:M(()=>[p(ce,{class:"d-flex align-center"},{default:M(()=>[p(l,{icon:"fluent:comment-dismiss-20-filled",width:"20px"}),e[10]||(e[10]=a("span",{class:"ml-2"},"このコメントをミュート",-1))]),_:1})]),_:1}),p(le,{density:"compact",style:{"min-height":"30px"},onClick:e[3]||(e[3]=r=>t.addMutedNiconicoUserIds())},{default:M(()=>[p(ce,{class:"d-flex align-center"},{default:M(()=>[p(l,{icon:"fluent:person-prohibited-20-filled",width:"20px"}),e[11]||(e[11]=a("span",{class:"ml-2"},"このコメントの投稿者をミュート",-1))]),_:1})]),_:1})]),_:1})],6),a("div",{class:S(["comment-list-cover",{"comment-list-cover--display":t.is_comment_list_dropdown_display}]),onClick:e[4]||(e[4]=r=>t.hideCommentListDropdown())},null,2),t.playback_mode==="Live"?(c(),F(v,{key:0,class:"comment-list",direction:"vertical",items:t.comment_list,"min-item-size":34},{default:M(({item:r,active:w})=>[p(f,{item:r,active:w,"size-dependencies":[r.text]},{default:M(()=>[a("div",{class:S(["comment",{"comment--my-post":r.my_post}])},[a("span",es,k(r.text),1),a("span",ts,k(r.time),1),g((c(),_("div",{class:"comment__icon",onMouseup:n=>t.showCommentListDropdown(n,r),onTouchend:n=>t.showCommentListDropdown(n,r)},[...e[12]||(e[12]=[a("svg",{class:"iconify iconify--fluent",width:"20px",height:"20px",viewBox:"0 0 20 20"},[a("path",{fill:"currentColor",d:"M10 6.5A1.75 1.75 0 1 1 10 3a1.75 1.75 0 0 1 0 3.5ZM10 17a1.75 1.75 0 1 1 0-3.5a1.75 1.75 0 0 1 0 3.5Zm-1.75-7a1.75 1.75 0 1 0 3.5 0a1.75 1.75 0 0 0-3.5 0Z"})],-1)])],40,ss)),[[b,!t.Utils.isTouchDevice()]])],2)]),_:2},1032,["item","active","size-dependencies"])]),_:1},8,["items"])):(c(),F(m,{key:1,ref:"virtua_scroller",class:"comment-list",data:t.comment_list},{default:M(({item:r})=>[a("div",{class:S(["comment",{"comment--my-post":r.my_post}])},[a("span",is,k(r.text),1),a("span",as,k(r.time),1),g((c(),_("div",{class:"comment__icon",onMouseup:w=>t.showCommentListDropdown(w,r),onTouchend:w=>t.showCommentListDropdown(w,r)},[...e[13]||(e[13]=[a("svg",{class:"iconify iconify--fluent",width:"20px",height:"20px",viewBox:"0 0 20 20"},[a("path",{fill:"currentColor",d:"M10 6.5A1.75 1.75 0 1 1 10 3a1.75 1.75 0 0 1 0 3.5ZM10 17a1.75 1.75 0 1 1 0-3.5a1.75 1.75 0 0 1 0 3.5Zm-1.75-7a1.75 1.75 0 1 0 3.5 0a1.75 1.75 0 0 0-3.5 0Z"})],-1)])],40,os)),[[b,!t.Utils.isTouchDevice()]])],2)]),_:1},8,["data"])),t.playback_mode==="Live"&&t.playerStore.live_comment_init_failed_message===null&&t.comment_list.length===0?(c(),_("div",ns,[...e[14]||(e[14]=[a("div",{class:"comment-announce__heading"},"まだコメントがありません。",-1),a("div",{class:"comment-announce__text"},[a("p",{class:"mt-0 mb-0"},"このチャンネルに対応するニコニコ実況のコメントが、リアルタイムで表示されます。")],-1)])])):V("",!0),t.playback_mode==="Live"&&t.playerStore.live_comment_init_failed_message!==null&&t.comment_list.length===0?(c(),_("div",rs,[e[15]||(e[15]=a("div",{class:"comment-announce__heading"},"コメントがありません。",-1)),a("div",ls,[a("p",cs,k(t.playerStore.live_comment_init_failed_message),1)])])):V("",!0),t.playback_mode==="Video"&&t.playerStore.video_comment_init_failed_message===null&&t.comment_list.length===0?(c(),_("div",ds,[...e[16]||(e[16]=[a("div",{class:"comment-announce__heading"},"まだコメントがありません。",-1),a("div",{class:"comment-announce__text"},[a("p",{class:"mt-0 mb-0"},"この録画番組に対応する、ニコニコ実況の過去ログコメントを取得しています...")],-1)])])):V("",!0),t.playback_mode==="Video"&&t.playerStore.video_comment_init_failed_message!==null&&t.comment_list.length===0?(c(),_("div",_s,[e[17]||(e[17]=a("div",{class:"comment-announce__heading"},"コメントがありません。",-1)),a("div",ms,[a("p",ps,k(t.playerStore.video_comment_init_failed_message),1)])])):V("",!0)],512),g((c(),_("div",{class:S(["comment-scroll-button elevation-5",{"comment-scroll-button--display":t.is_manual_scroll}]),onClick:e[5]||(e[5]=(...r)=>t.handleAutoScrollButtonClick&&t.handleAutoScrollButtonClick(...r))},[p(l,{icon:"fluent:arrow-down-12-filled",height:"29px"})],2)),[[b]]),p(u,{modelValue:t.comment_mute_settings_modal,"onUpdate:modelValue":e[6]||(e[6]=r=>t.comment_mute_settings_modal=r)},null,8,["modelValue"])],2)}const hs=B(Jt,[["render",us],["__scopeId","data-v-f9abeec5"]]),ys=E({name:"Panel-ProgramTab",data(){return{Utils:Object.freeze(y),ChannelUtils:Object.freeze(ie),ProgramUtils:Object.freeze(oe)}},computed:{...z(q)}}),fs={class:"program-container"},gs={class:"program-broadcaster"},vs=["src"],bs={class:"program-broadcaster__number"},ws={class:"program-broadcaster__name"},ks={class:"program-info"},Ss=["innerHTML"],Cs={class:"program-info__time"},$s=["innerHTML"],Ts={class:"program-info__genre-container"},Ls={class:"program-info__next"},Ps=["innerHTML"],Rs={class:"program-info__next-time"},Ms={class:"program-info__status"},Is={class:"ml-2"},As={class:"program-info__status-viewers ml-5"},Vs={class:"ml-1"},xs={class:"program-detail-container"},Es={class:"program-detail__heading"},Bs=["innerHTML"];function Hs(t,e,s,i,o,d){var f,v;const l=L("Icon");return c(),_("div",fs,[a("section",gs,[a("img",{class:"program-broadcaster__icon",src:`${t.Utils.api_base_url}/channels/${t.channelsStore.channel.current.id}/logo`},null,8,vs),a("div",bs,"Ch: "+k(t.channelsStore.channel.current.channel_number),1),a("div",ws,k(t.channelsStore.channel.current.name),1)]),a("section",ks,[a("h1",{class:"program-info__title",innerHTML:t.ProgramUtils.decorateProgramInfo(t.channelsStore.channel.current.program_present,"title")},null,8,Ss),a("div",Cs,k(t.ProgramUtils.getProgramTime(t.channelsStore.channel.current.program_present)),1),a("div",{class:"program-info__description",innerHTML:t.ProgramUtils.decorateProgramInfo(t.channelsStore.channel.current.program_present,"description")},null,8,$s),a("div",Ts,[(c(!0),_(N,null,j(((f=t.channelsStore.channel.current.program_present)==null?void 0:f.genres)??[],(m,u)=>(c(),_("div",{class:"program-info__genre",key:u},k(m.major)+" / "+k(m.middle),1))),128))]),a("div",Ls,[e[0]||(e[0]=a("span",{class:"program-info__next-decorate"},"NEXT",-1)),p(l,{class:"program-info__next-icon",icon:"fluent:fast-forward-20-filled",width:"16px"})]),a("span",{class:"program-info__next-title",innerHTML:t.ProgramUtils.decorateProgramInfo(t.channelsStore.channel.current.program_following,"title")},null,8,Ps),a("div",Rs,k(t.ProgramUtils.getProgramTime(t.channelsStore.channel.current.program_following)),1),a("div",Ms,[a("div",{class:S(["program-info__status-force",`program-info__status-force--${t.ChannelUtils.getChannelForceType(t.channelsStore.channel.current.jikkyo_force)}`])},[p(l,{icon:"fa-solid:fire-alt",height:"14px"}),e[1]||(e[1]=a("span",{class:"ml-2"},"勢い:",-1)),a("span",Is,k(t.channelsStore.channel.current.jikkyo_force??"--")+" コメ/分",1)],2),a("div",As,[p(l,{icon:"fa-solid:eye",height:"14px"}),e[2]||(e[2]=a("span",{class:"ml-2"},"視聴数:",-1)),a("span",Vs,k(t.channelsStore.channel.current.viewer_count),1)])])]),a("section",xs,[(c(!0),_(N,null,j(((v=t.channelsStore.channel.current.program_present)==null?void 0:v.detail)??{},(m,u)=>(c(),_("div",{class:"program-detail",key:u},[a("h2",Es,k(u),1),a("div",{class:"program-detail__text",innerHTML:t.Utils.URLtoLink(m)},null,8,Bs)]))),128))])])}const Ds=B(ys,[["render",Hs],["__scopeId","data-v-bbeca1ae"]]),Os=E({name:"Panel-RecordedProgramTab",data(){return{Utils:Object.freeze(y),ProgramUtils:Object.freeze(oe),comment_count:null}},computed:{...z(I,D),isInMylist(){return this.settingsStore.settings.mylist.some(t=>t.type==="RecordedProgram"&&t.id===this.playerStore.recorded_program.id)}},methods:{toggleMylist(){const t=this.playerStore.recorded_program;this.isInMylist?(this.settingsStore.settings.mylist=this.settingsStore.settings.mylist.filter(e=>!(e.type==="RecordedProgram"&&e.id===t.id)),xe.show("マイリストから削除しました。")):this.settingsStore.settings.mylist.push({type:"RecordedProgram",id:t.id,created_at:y.time()})}},created(){this.playerStore.event_emitter.on("CommentReceived",t=>{t.is_initial_comments===!0&&(this.comment_count=t.comments.length)})},beforeUnmount(){this.playerStore.event_emitter.off("CommentReceived")}}),Fs={class:"program-container"},Us={class:"program-info"},Ns=["innerHTML"],qs={class:"program-info__broadcaster"},Ws=["src"],zs={class:"program-info__broadcaster-container"},js={key:0,class:"d-flex align-center"},Ys={class:"program-info__broadcaster-number"},Gs={class:"program-info__broadcaster-name"},Ks={key:1,class:"d-flex align-center"},Js={class:"program-info__broadcaster-time"},Xs=["innerHTML"],Zs={class:"program-info__genre-container"},Qs={class:"mt-5"},ei={class:"program-info__status"},ti={class:"ml-2"},si={class:"program-info__status"},ii={class:"ml-2"},ai={class:"program-detail-container"},oi={class:"program-detail__heading"},ni=["innerHTML"];function ri(t,e,s,i,o,d){var f;const l=L("Icon");return c(),_("div",Fs,[a("section",Us,[a("h1",{class:"program-info__title",innerHTML:t.ProgramUtils.decorateProgramInfo(t.playerStore.recorded_program,"title")},null,8,Ns),a("div",qs,[a("img",{class:"program-info__broadcaster-icon",src:`${t.Utils.api_base_url}/channels/${((f=t.playerStore.recorded_program.channel)==null?void 0:f.id)??"NID0-SID0"}/logo`},null,8,Ws),a("div",zs,[t.playerStore.recorded_program.channel!==null?(c(),_("div",js,[a("div",Ys,"Ch: "+k(t.playerStore.recorded_program.channel.channel_number),1),a("div",Gs,k(t.playerStore.recorded_program.channel.name),1)])):(c(),_("div",Ks,[...e[1]||(e[1]=[a("div",{class:"program-info__broadcaster-number"},"チャンネル情報なし",-1)])])),a("div",Js,k(t.ProgramUtils.getProgramTime(t.playerStore.recorded_program)),1)])]),a("div",{class:"program-info__description",innerHTML:t.ProgramUtils.decorateProgramInfo(t.playerStore.recorded_program,"description")},null,8,Xs),a("div",Zs,[(c(!0),_(N,null,j(t.playerStore.recorded_program.genres??[],(v,m)=>(c(),_("div",{class:"program-info__genre",key:m},k(v.major)+" / "+k(v.middle),1))),128))]),a("div",Qs,[a("div",ei,[p(l,{icon:"ic:round-date-range",height:"17px",style:{"margin-left":"-2px","margin-right":"-1.7px","margin-bottom":"-3px"}}),a("span",ti,"録画期間: "+k(t.playerStore.recorded_program.is_partially_recorded?"(一部のみ録画)":""),1),e[2]||(e[2]=a("br",null,null,-1)),a("span",null,k(t.ProgramUtils.getRecordingTime(t.playerStore.recorded_program)),1)]),a("div",si,[p(l,{icon:"bi:chat-left-text-fill",height:"12.5px",style:{"margin-bottom":"-3px"}}),e[3]||(e[3]=a("span",{class:"ml-2"},"コメント数:",-1)),a("span",ii,k(t.comment_count??"--"),1)]),g((c(),_("div",{class:"program-info__button",onClick:e[0]||(e[0]=(...v)=>t.toggleMylist&&t.toggleMylist(...v))},[t.isInMylist?(c(),_(N,{key:0},[p(l,{icon:"fluent:checkmark-16-filled",width:"18px",height:"18px",style:{color:"rgb(var(--v-theme-primary))","margin-bottom":"-1px"}}),e[4]||(e[4]=a("span",{style:{"margin-left":"6px"}},"マイリストに追加済み",-1))],64)):(c(),_(N,{key:1},[p(l,{icon:"fluent:add-16-filled",width:"18px",height:"18px",style:{"margin-bottom":"-1px"}}),e[5]||(e[5]=a("span",{style:{"margin-left":"6px"}},"マイリストに追加",-1))],64))])),[[b]])])]),a("section",ai,[(c(!0),_(N,null,j(t.playerStore.recorded_program.detail??{},(v,m)=>(c(),_("div",{class:"program-detail",key:m},[a("h2",oi,k(m),1),a("div",{class:"program-detail__text",innerHTML:t.Utils.URLtoLink(v)},null,8,ni)]))),128))])])}const li=B(Os,[["render",ri],["__scopeId","data-v-cb8ca67d"]]),ci=E({name:"Panel-Remocon",props:{modelValue:{type:Boolean,required:!0}},emits:{"update:modelValue":t=>!0}}),di={class:"remote-control-data-broadcasting remote-control-data-broadcasting--disabled"},_i={class:"remote-control__directional-key"},mi={class:"remote-control-button-up","data-arib-key-code":"1"},pi={class:"remote-control-button-left","data-arib-key-code":"3"},ui={class:"remote-control-button-select","data-arib-key-code":"18"},hi={class:"remote-control-button-right","data-arib-key-code":"4"},yi={class:"remote-control-button-down","data-arib-key-code":"2"},fi={class:"remote-control__control-key"},gi={class:"remote-control-button-data","data-arib-key-code":"20"},vi={class:"remote-control-button-back","data-arib-key-code":"19"},bi={class:"remote-control-button-blue bg-blue-darken-3","data-arib-key-code":"21"},wi={class:"remote-control-button-red bg-red-darken-3","data-arib-key-code":"22"},ki={class:"remote-control-button-green bg-green-darken-3","data-arib-key-code":"23"},Si={class:"remote-control-button-yellow bg-yellow-darken-3 text-text","data-arib-key-code":"24"},Ci={class:"remote-control__number-key"},$i={"data-remocon-id":"1","data-arib-key-code":"6"},Ti={"data-remocon-id":"2","data-arib-key-code":"7"},Li={"data-remocon-id":"3","data-arib-key-code":"8"},Pi={"data-remocon-id":"4","data-arib-key-code":"9"},Ri={"data-remocon-id":"5","data-arib-key-code":"10"},Mi={"data-remocon-id":"6","data-arib-key-code":"11"},Ii={"data-remocon-id":"7","data-arib-key-code":"12"},Ai={"data-remocon-id":"8","data-arib-key-code":"13"},Vi={"data-remocon-id":"9","data-arib-key-code":"14"},xi={"data-remocon-id":"10","data-arib-key-code":"15"},Ei={"data-remocon-id":"11","data-arib-key-code":"16"},Bi={"data-remocon-id":"12","data-arib-key-code":"17"};function Hi(t,e,s,i,o,d){const l=L("Icon");return c(),_("div",{class:S(["remote-control-container",{"remote-control-container--showing":t.modelValue}]),onClick:e[2]||(e[2]=f=>t.$emit("update:modelValue",!1))},[a("div",{class:"remote-control elevation-6",onClick:e[1]||(e[1]=te(()=>{},["stop"]))},[g((c(),_("div",{class:"remote-control__close d-flex align-center rounded-circle cursor-pointer px-2 py-2",onClick:e[0]||(e[0]=f=>t.$emit("update:modelValue",!1))},[p(l,{icon:"fluent:dismiss-12-filled",width:"23px",height:"23px"})])),[[b]]),a("div",di,[p($e,{indeterminate:"",size:"60",width:"6",class:"remote-control__loading"}),a("div",_i,[g((c(),_("button",mi,[p(l,{icon:"fluent:chevron-up-12-filled",width:"26px",height:"26px"})])),[[b]]),g((c(),_("button",pi,[p(l,{icon:"fluent:chevron-left-12-filled",width:"26px",height:"26px"})])),[[b]]),g((c(),_("button",ui,[...e[3]||(e[3]=[x(" 決定 ",-1)])])),[[b]]),g((c(),_("button",hi,[p(l,{icon:"fluent:chevron-right-12-filled",width:"26px",height:"26px"})])),[[b]]),g((c(),_("button",yi,[p(l,{icon:"fluent:chevron-down-12-filled",width:"26px",height:"26px"})])),[[b]])]),a("div",fi,[g((c(),_("button",gi,[...e[4]||(e[4]=[a("svg",{width:"20px",height:"20px",viewBox:"0 0 512 512"},[a("path",{fill:"currentColor",d:"M248.039 381.326L355.039 67.8258C367.539 28.3257 395.039 34.3258 406.539 34.3258C431.039 34.3258 453.376 61.3258 441.039 96.8258C362.639 322.426 343.539 375.326 340.539 384.826C338.486 391.326 342.039 391.326 345.539 391.326C377.039 391.326 386.539 418.326 386.539 435.326C386.539 458.826 371.539 477.326 350.039 477.326H214.539C179.039 477.326 85.8269 431.3 88.0387 335.826C91.0387 206.326 192.039 183.326 243.539 183.326H296.539L265.539 272.326H243.539C185.539 272.326 174.113 314.826 176.039 334.326C180.039 374.826 215.039 389.814 237.039 390.326C244.539 390.5 246.039 386.826 248.039 381.326Z"})],-1),a("span",{class:"ml-1"},"データ",-1)])])),[[b]]),g((c(),_("button",vi,[p(l,{icon:"fluent:chevron-left-12-filled",width:"20px"}),e[5]||(e[5]=a("span",{class:"ml-1"},"戻る",-1))])),[[b]]),g((c(),_("button",bi,[...e[6]||(e[6]=[x("青",-1)])])),[[b]]),g((c(),_("button",wi,[...e[7]||(e[7]=[x("赤",-1)])])),[[b]]),g((c(),_("button",ki,[...e[8]||(e[8]=[x("緑",-1)])])),[[b]]),g((c(),_("button",Si,[...e[9]||(e[9]=[x("黄",-1)])])),[[b]])])]),a("div",Ci,[g((c(),_("button",$i,[...e[10]||(e[10]=[x("1",-1)])])),[[b]]),g((c(),_("button",Ti,[...e[11]||(e[11]=[x("2",-1)])])),[[b]]),g((c(),_("button",Li,[...e[12]||(e[12]=[x("3",-1)])])),[[b]]),g((c(),_("button",Pi,[...e[13]||(e[13]=[x("4",-1)])])),[[b]]),g((c(),_("button",Ri,[...e[14]||(e[14]=[x("5",-1)])])),[[b]]),g((c(),_("button",Mi,[...e[15]||(e[15]=[x("6",-1)])])),[[b]]),g((c(),_("button",Ii,[...e[16]||(e[16]=[x("7",-1)])])),[[b]]),g((c(),_("button",Ai,[...e[17]||(e[17]=[x("8",-1)])])),[[b]]),g((c(),_("button",Vi,[...e[18]||(e[18]=[x("9",-1)])])),[[b]]),g((c(),_("button",xi,[...e[19]||(e[19]=[x("10",-1)])])),[[b]]),g((c(),_("button",Ei,[...e[20]||(e[20]=[x("11",-1)])])),[[b]]),g((c(),_("button",Bi,[...e[21]||(e[21]=[x("12",-1)])])),[[b]])])])],2)}const Di=B(ci,[["render",Hi],["__scopeId","data-v-87493572"]]),Oi=E({name:"Panel-SeriesTab",data(){return{Utils:Object.freeze(y)}},computed:{...z(I)}}),Fi={class:"series-container"};function Ui(t,e,s,i,o,d){return c(),_("div",Fi," 鋭意実装中… ")}const Ni=B(Oi,[["render",Ui],["__scopeId","data-v-6619a14a"]]),qi=E({name:"TwitterCaptures"}),Wi={class:"twitter-captures"};function zi(t,e,s,i,o,d){return c(),_("div",Wi)}const ji=B(qi,[["render",zi]]),Yi=E({name:"TwitterSearch"}),Gi={class:"twitter-search"};function Ki(t,e,s,i,o,d){return c(),_("div",Gi)}const Ji=B(Yi,[["render",Ki]]),Xi=E({name:"TwitterTimeline"}),Zi={class:"twitter-timeline"};function Qi(t,e,s,i,o,d){return c(),_("div",Zi)}const ea=B(Xi,[["render",Qi]]),ta=E({name:"Panel-TwitterTab",components:{draggable:rt,TwitterCaptures:ji,TwitterSearch:Ji,TwitterTimeline:ea},props:{playback_mode:{type:String,required:!0}},data(){return{Utils:Object.freeze(y),is_twitter_account_list_display:!1,saved_twitter_hashtags:D().settings.saved_twitter_hashtags.map((t,e)=>({id:y.time()+e,text:t,editing:!1})),is_hashtag_list_display:!1,captures_element:null,is_tweet_hashtag_form_focused:!1,is_tweet_text_form_focused:!1,tweet_hashtag:"",tweet_text:"",tweet_letter_remain_count:140,is_tweet_sending:!1}},computed:{...z(q,I,D,J,ct),is_tweet_button_disabled(){return this.twitterStore.is_logged_in_twitter===!1||this.tweet_letter_remain_count<0||(this.tweet_text.trim()===""||this.tweet_letter_remain_count===140)&&this.playerStore.twitter_selected_capture_blobs.length===0}},watch:{"channelsStore.channel.current.name":{handler(t,e){if(this.playback_mode==="Live"){const s=ie.getChannelHashtag(e)??"";this.tweet_hashtag=this.formatHashtag(this.tweet_hashtag.replaceAll(s,"")),this.updateTweetLetterCount(),this.settingsStore.settings.reset_hashtag_when_program_switches===!0&&(this.tweet_hashtag=this.formatHashtag(""),this.updateTweetLetterCount())}}},"channelsStore.channel.current.program_present":{deep:!0,handler(t,e){this.playback_mode==="Live"&&(t==null?void 0:t.id)!==(e==null?void 0:e.id)&&this.settingsStore.settings.reset_hashtag_when_program_switches===!0&&(this.tweet_hashtag=this.formatHashtag(""),this.updateTweetLetterCount())}},saved_twitter_hashtags:{deep:!0,handler(){this.settingsStore.settings.saved_twitter_hashtags=this.saved_twitter_hashtags.map(t=>t.text)}}},async created(){await this.userStore.fetchUser(),await this.twitterStore.update(),this.tweet_hashtag=this.formatHashtag(this.tweet_hashtag),this.updateTweetLetterCount(),this.playerStore.event_emitter.on("CaptureCompleted",async t=>{this.addCaptureList(t.capture,t.filename)})},beforeUnmount(){for(const t of this.playerStore.twitter_captures)URL.revokeObjectURL(t.image_url);this.playerStore.event_emitter.off("CaptureCompleted")},methods:{updateTweetLetterCount(){this.tweet_letter_remain_count=140-[...this.tweet_hashtag].length-[...this.tweet_text].length},pasteClipboardData(t){if(t.clipboardData!==null){for(const e of t.clipboardData.items)if(e.type.startsWith("image/")){const s=e.getAsFile();s&&this.addCaptureList(s,s.name)}}},clickHashtagListButton(){this.is_hashtag_list_display=!this.is_hashtag_list_display;for(const t of this.saved_twitter_hashtags)t.editing=!1},clickHashtag(t){this.tweet_hashtag=t.text,this.tweet_hashtag=this.formatHashtag(this.tweet_hashtag),this.updateTweetLetterCount(),window.setTimeout(()=>this.is_hashtag_list_display=!1,150)},clickAccountButton(){if(!this.twitterStore.is_logged_in_twitter){document.fullscreenElement&&document.exitFullscreen(),this.$router.push({path:"/settings/twitter"});return}this.is_twitter_account_list_display=!this.is_twitter_account_list_display,this.is_twitter_account_list_display===!0&&(this.is_hashtag_list_display=!1)},updateSelectedTwitterAccount(t){this.settingsStore.settings.selected_twitter_account_id=t.id,this.twitterStore.selected_twitter_account=t,this.twitterStore.initChallengeSolverIframe(t.screen_name),window.setTimeout(()=>this.is_twitter_account_list_display=!1,150)},addCaptureList(t,e){this.captures_element===null&&(this.captures_element=document.querySelector(".tab-content--capture")),this.playerStore.twitter_captures.length>100&&(URL.revokeObjectURL(this.playerStore.twitter_captures[0].image_url),this.playerStore.twitter_selected_capture_blobs=this.playerStore.twitter_selected_capture_blobs.filter(i=>i!==this.playerStore.twitter_captures[0].blob),this.playerStore.twitter_captures.shift());const s=URL.createObjectURL(t);this.playerStore.twitter_captures.push({blob:t,filename:e,image_url:s,selected:!1,focused:!1}),this.$nextTick(()=>{this.captures_element!==null&&this.captures_element.scrollTo({top:this.captures_element.scrollHeight,behavior:"smooth"})})},async drawProgramTitleOnCapture(t){var d;const e=await createImageBitmap(t),s="OffscreenCanvas"in window?new OffscreenCanvas(e.width,e.height):document.createElement("canvas"),i=s.getContext("2d",{alpha:!1,desynchronized:!0,willReadFrequently:!1});i.drawImage(e,0,0),e.close(),i.font='bold 22px "Open Sans", "YakuHanJPs", "Twemoji", "Hiragino Sans", "Noto Sans JP", sans-serif',i.fillStyle="rgba(255, 255, 255, 70%)",i.shadowColor="rgba(0, 0, 0, 100%)",i.shadowBlur=4,i.shadowOffsetX=0,i.shadowOffsetY=0;let o;switch(this.playback_mode==="Live"?o=((d=this.channelsStore.channel.current.program_present)==null?void 0:d.title)??"放送休止":o=this.playerStore.recorded_program.title,this.settingsStore.settings.tweet_capture_watermark_position){case"TopLeft":{i.textAlign="left",i.textBaseline="top",i.fillText(o,16,12);break}case"TopRight":{i.textAlign="right",i.textBaseline="top",i.fillText(o,s.width-16,12);break}case"BottomLeft":{i.textAlign="left",i.textBaseline="bottom",i.fillText(o,16,s.height-12);break}case"BottomRight":{i.textAlign="right",i.textBaseline="bottom",i.fillText(o,s.width-16,s.height-12);break}}return s instanceof OffscreenCanvas?await s.convertToBlob({type:"image/jpeg",quality:1}):new Promise((l,f)=>s.toBlob(v=>{v===null?f():l(v)},"image/jpeg",1))},formatHashtag(t,e=!1){const s=t.trim().replaceAll("♯","#").replaceAll("＃","#").replace(/#{2,}/g,"#").replaceAll("　"," ").replaceAll(/ +/g," ").split(" ").filter(i=>i!=="");for(let i in s)s[i].startsWith("#")||(s[i]=`#${s[i]}`);if(this.playback_mode==="Live"&&this.settingsStore.settings.auto_add_watching_channel_hashtag===!0&&e===!1){const i=ie.getChannelHashtag(this.channelsStore.channel.current.name);i!==null&&s.includes(i)===!1&&s.push(i)}return s.join(" ")},async sendTweet(){if(this.is_tweet_button_disabled===!0||this.twitterStore.selected_twitter_account===null||this.is_tweet_sending===!0)return;this.is_tweet_sending=!0,this.tweet_hashtag=this.formatHashtag(this.tweet_hashtag);const t=this.tweet_hashtag;this.updateTweetLetterCount();let e=this.tweet_text;if(t!=="")switch(this.settingsStore.settings.tweet_hashtag_position){case"Prepend":{e=`${t} ${this.tweet_text}`;break}case"Append":{e=`${this.tweet_text} ${t}`;break}case"PrependWithLineBreak":{e=`${t}
${this.tweet_text}`;break}case"AppendWithLineBreak":{e=`${this.tweet_text}
${t}`;break}}const s=[];for(let i of this.playerStore.twitter_selected_capture_blobs)this.settingsStore.settings.tweet_capture_watermark_position!=="None"&&(i=await this.drawProgramTitleOnCapture(i)),s.push(i);this.tweet_text="",this.updateTweetLetterCount();for(const i of this.playerStore.twitter_captures)i.selected=!1,i.focused=!1;this.playerStore.twitter_selected_capture_blobs=[],lt.sendTweet(this.twitterStore.selected_twitter_account.screen_name,e,s).then(i=>{this.playerStore.event_emitter.emit("SendNotification",{message:i.message,color:i.is_error?"#FF6F6A":void 0})}),this.is_tweet_sending=!1,this.settingsStore.settings.fold_panel_after_sending_tweet===!0&&(this.playerStore.is_panel_display=!1,this.$refs.tweet_text.blur())}}}),sa={class:"twitter-container"},ia={class:"tab-container"},aa={class:"tab-button-container"},oa={class:"tweet-form__hashtag"},na={class:"tweet-form__control"},ra=["src"],la={class:"account-button__screen-name"},ca={class:"limit-meter"},da={class:"limit-meter__content"},_a=["disabled"],ma={class:"hashtag-heading"},pa={class:"hashtag-heading__text"},ua=["onClick"],ha=["onUpdate:modelValue","disabled"],ya=["onClick"],fa={key:0,class:"iconify iconify--fluent",width:"17px",height:"17px",viewBox:"0 0 16 16"},ga={key:1,class:"iconify iconify--fluent",width:"17px",height:"17px",viewBox:"0 0 16 16"},va=["onClick"],ba=["onClick"],wa=["src"],ka={class:"twitter-account__info"},Sa={class:"twitter-account__name"},Ca={class:"twitter-account__screen-name"},$a={class:"twitter-account__check iconify iconify--fluent",width:"24px",height:"24px",viewBox:"0 0 16 16"};function Ta(t,e,s,i,o,d){var r,w;const l=L("TwitterSearch"),f=L("TwitterTimeline"),v=L("TwitterCaptures"),m=L("Icon"),u=L("draggable");return c(),_("div",sa,[a("div",ia,[p(l,{class:S({"tab-content--active":t.playerStore.twitter_active_tab==="Search"})},null,8,["class"]),p(f,{class:S({"tab-content--active":t.playerStore.twitter_active_tab==="Timeline"})},null,8,["class"]),p(v,{class:S({"tab-content--active":t.playerStore.twitter_active_tab==="Capture"})},null,8,["class"])]),a("div",aa,[g((c(),_("div",{class:S(["tab-button",{"tab-button--active":t.playerStore.twitter_active_tab==="Search"}]),onClick:e[0]||(e[0]=n=>t.playerStore.twitter_active_tab="Search")},[p(m,{icon:"fluent:search-16-filled",height:"18px"}),e[20]||(e[20]=a("span",{class:"tab-button__text"},"ツイート検索",-1))],2)),[[b]]),g((c(),_("div",{class:S(["tab-button",{"tab-button--active":t.playerStore.twitter_active_tab==="Timeline"}]),onClick:e[1]||(e[1]=n=>t.playerStore.twitter_active_tab="Timeline")},[p(m,{icon:"fluent:home-16-regular",height:"18px"}),e[21]||(e[21]=a("span",{class:"tab-button__text"},"タイムライン",-1))],2)),[[b]]),g((c(),_("div",{class:S(["tab-button",{"tab-button--active":t.playerStore.twitter_active_tab==="Capture"}]),onClick:e[2]||(e[2]=n=>t.playerStore.twitter_active_tab="Capture")},[p(m,{icon:"fluent:image-copy-20-regular",height:"18px"}),e[22]||(e[22]=a("span",{class:"tab-button__text"},"キャプチャ",-1))],2)),[[b]])]),a("div",{class:S(["tweet-form",{"tweet-form--focused":t.is_tweet_hashtag_form_focused||t.is_tweet_text_form_focused,"tweet-form--virtual-keyboard-display":t.playerStore.is_virtual_keyboard_display&&(t.Utils.hasActiveElementClass("tweet-form__hashtag-form")||t.Utils.hasActiveElementClass("tweet-form__textarea"))&&(t.is_hashtag_list_display=!1,!0)}])},[a("div",oa,[g(a("input",{class:"tweet-form__hashtag-form",type:"search",enterkeyhint:"done",placeholder:"#ハッシュタグ",spellcheck:"false","onUpdate:modelValue":e[3]||(e[3]=n=>t.tweet_hashtag=n),onInput:e[4]||(e[4]=n=>t.updateTweetLetterCount()),onFocus:e[5]||(e[5]=n=>t.is_tweet_hashtag_form_focused=!0),onBlur:e[6]||(e[6]=n=>t.is_tweet_hashtag_form_focused=!1),onChange:e[7]||(e[7]=n=>{t.tweet_hashtag=t.formatHashtag(t.tweet_hashtag),t.updateTweetLetterCount()})},null,544),[[ne,t.tweet_hashtag]]),g((c(),_("div",{class:"tweet-form__hashtag-list-button",onClick:e[8]||(e[8]=n=>t.clickHashtagListButton())},[p(m,{icon:"fluent:clipboard-text-ltr-32-regular",height:"22px"})])),[[b]])]),g(a("textarea",{class:"tweet-form__textarea",enterkeyhint:"enter",placeholder:"ツイート",spellcheck:"false","onUpdate:modelValue":e[9]||(e[9]=n=>t.tweet_text=n),ref:"tweet_text",onInput:e[10]||(e[10]=n=>t.updateTweetLetterCount()),onPaste:e[11]||(e[11]=n=>t.pasteClipboardData(n)),onFocus:e[12]||(e[12]=n=>t.is_tweet_text_form_focused=!0),onBlur:e[13]||(e[13]=n=>t.is_tweet_text_form_focused=!1)},"            ",544),[[ne,t.tweet_text]]),a("div",na,[g((c(),_("div",{class:S(["account-button",{"account-button--no-login":!t.twitterStore.is_logged_in_twitter}]),onClick:e[14]||(e[14]=n=>t.clickAccountButton())},[a("img",{class:"account-button__icon",src:t.twitterStore.is_logged_in_twitter?(r=t.twitterStore.selected_twitter_account)==null?void 0:r.icon_url:"/assets/images/account-icon-default.png"},null,8,ra),a("span",la,k(t.twitterStore.is_logged_in_twitter?`@${(w=t.twitterStore.selected_twitter_account)==null?void 0:w.screen_name}`:"連携されていません"),1),p(m,{class:"account-button__menu",icon:"fluent:more-circle-20-regular",width:"22px"})],2)),[[b]]),a("div",ca,[a("div",{class:S(["limit-meter__content",{"limit-meter__content--yellow":t.tweet_letter_remain_count<=20,"limit-meter__content--red":t.tweet_letter_remain_count<=0}])},[p(m,{icon:"fa-brands:twitter",width:"12px",style:{"margin-right":"-2px"}}),a("span",null,k(t.tweet_letter_remain_count),1)],2),a("div",da,[p(m,{icon:"fluent:image-16-filled",width:"14px"}),a("span",null,k(t.playerStore.twitter_selected_capture_blobs.length)+"/4",1)])]),g((c(),_("button",{class:"tweet-button",disabled:t.is_tweet_button_disabled,onClick:e[15]||(e[15]=n=>t.sendTweet()),onTouchstart:e[16]||(e[16]=n=>t.sendTweet())},[p(m,{icon:"fa-brands:twitter",height:"16px"}),e[23]||(e[23]=a("span",{class:"ml-1"},"ツイート",-1))],40,_a)),[[b,t.Utils.isTouchDevice()===!1]])])],2),a("div",{class:S(["hashtag-list",{"hashtag-list--display":t.is_hashtag_list_display,"hashtag-list--virtual-keyboard-display":t.playerStore.is_virtual_keyboard_display&&t.Utils.hasActiveElementClass("hashtag__input")}])},[a("div",ma,[a("div",pa,[p(m,{icon:"charm:hash",width:"17px"}),e[24]||(e[24]=a("span",{class:"ml-1"},"ハッシュタグリスト",-1))]),g((c(),_("button",{class:"hashtag-heading__add-button",onClick:e[17]||(e[17]=n=>t.saved_twitter_hashtags.push({id:t.Utils.time(),text:"#ここにハッシュタグを入力",editing:!1}))},[p(m,{icon:"fluent:add-12-filled",width:"17px"}),e[25]||(e[25]=a("span",{class:"ml-1"},"追加",-1))])),[[b]])]),p(u,{class:"hashtag-container",handle:".hashtag__sort-handle","item-key":"id",modelValue:t.saved_twitter_hashtags,"onUpdate:modelValue":e[19]||(e[19]=n=>t.saved_twitter_hashtags=n)},{item:M(({element:n})=>[g((c(),_("div",{class:S(["hashtag",{"hashtag--editing":n.editing}]),onClick:h=>t.clickHashtag(n)},[g(a("input",{type:"search",enterkeyhint:"done",class:"hashtag__input",spellcheck:"false","onUpdate:modelValue":h=>n.text=h,disabled:!n.editing,onClick:e[18]||(e[18]=te(()=>{},["stop"]))},null,8,ha),[[ne,n.text]]),g((c(),_("button",{class:"hashtag__edit-button",onClick:te(h=>{n.editing=!n.editing,n.text=t.formatHashtag(n.text,!0),t.updateTweetLetterCount()},["prevent","stop"])},[n.editing===!1?(c(),_("svg",fa,[...e[26]||(e[26]=[a("path",{fill:"currentColor",d:"M10.529 1.764a2.621 2.621 0 1 1 3.707 3.707l-.779.779L9.75 2.543l.779-.779ZM9.043 3.25L2.657 9.636a2.955 2.955 0 0 0-.772 1.354l-.87 3.386a.5.5 0 0 0 .61.608l3.385-.869a2.95 2.95 0 0 0 1.354-.772l6.386-6.386L9.043 3.25Z"},null,-1)])])):V("",!0),n.editing===!0?(c(),_("svg",ga,[...e[27]||(e[27]=[a("path",{fill:"currentColor",d:"M14.046 3.486a.75.75 0 0 1-.032 1.06l-7.93 7.474a.85.85 0 0 1-1.188-.022l-2.68-2.72a.75.75 0 1 1 1.068-1.053l2.234 2.267l7.468-7.038a.75.75 0 0 1 1.06.032Z"},null,-1)])])):V("",!0)],8,ya)),[[b]]),g((c(),_("button",{class:"hashtag__delete-button",onClick:te(h=>t.saved_twitter_hashtags.splice(t.saved_twitter_hashtags.indexOf(n),1),["prevent","stop"])},[...e[28]||(e[28]=[a("svg",{class:"iconify iconify--fluent",width:"17px",height:"17px",viewBox:"0 0 16 16"},[a("path",{fill:"currentColor",d:"M7 3h2a1 1 0 0 0-2 0ZM6 3a2 2 0 1 1 4 0h4a.5.5 0 0 1 0 1h-.564l-1.205 8.838A2.5 2.5 0 0 1 9.754 15H6.246a2.5 2.5 0 0 1-2.477-2.162L2.564 4H2a.5.5 0 0 1 0-1h4Zm1 3.5a.5.5 0 0 0-1 0v5a.5.5 0 0 0 1 0v-5ZM9.5 6a.5.5 0 0 0-.5.5v5a.5.5 0 0 0 1 0v-5a.5.5 0 0 0-.5-.5Z"})],-1)])],8,va)),[[b]]),e[29]||(e[29]=a("div",{class:"hashtag__sort-handle"},[a("svg",{class:"iconify iconify--material-symbols",width:"17px",height:"17px",viewBox:"0 0 24 24"},[a("path",{fill:"currentColor",d:"M5 15q-.425 0-.713-.288T4 14q0-.425.288-.713T5 13h14q.425 0 .713.288T20 14q0 .425-.288.713T19 15H5Zm0-4q-.425 0-.713-.288T4 10q0-.425.288-.713T5 9h14q.425 0 .713.288T20 10q0 .425-.288.713T19 11H5Z"})])],-1))],10,ua)),[[b,!n.editing]])]),_:1},8,["modelValue"])],2),a("div",{class:S(["twitter-account-list",{"twitter-account-list--display":t.is_twitter_account_list_display}])},[(c(!0),_(N,null,j(t.userStore.user?t.userStore.user.twitter_accounts:[],n=>g((c(),_("div",{class:"twitter-account",key:n.id,onClick:h=>t.updateSelectedTwitterAccount(n)},[a("img",{class:"twitter-account__icon",src:n.icon_url},null,8,wa),a("div",ka,[a("div",Sa,k(n.name),1),a("div",Ca,"@"+k(n.screen_name),1)]),g((c(),_("svg",$a,[...e[30]||(e[30]=[a("path",{fill:"currentColor",d:"M14.046 3.486a.75.75 0 0 1-.032 1.06l-7.93 7.474a.85.85 0 0 1-1.188-.022l-2.68-2.72a.75.75 0 1 1 1.068-1.053l2.234 2.267l7.468-7.038a.75.75 0 0 1 1.06.032Z"},null,-1)])],512)),[[Ee,n.id===t.settingsStore.settings.selected_twitter_account_id]])],8,ba)),[[b]])),128))],2)])}const La=B(ta,[["render",Ta],["__scopeId","data-v-f441ba35"]]),Pa=E({name:"Watch-Panel",components:{Channel:Kt,Comment:hs,Program:Ds,RecordedProgram:li,Remocon:Di,Series:Ni,Twitter:La},props:{playback_mode:{type:String,required:!0}},data(){return{Utils:Object.freeze(y)}},computed:{...z(q,I),panel_active_tab(){return this.playback_mode==="Live"?this.playerStore.tv_panel_active_tab:this.playerStore.video_panel_active_tab}}}),Ra={class:"watch-panel__header"},Ma={key:0,class:"panel-broadcaster"},Ia=["src"],Aa={class:"panel-broadcaster__number"},Va={class:"panel-broadcaster__name"},xa={class:"watch-panel__content-container"},Ea={class:"watch-panel__navigation"};function Ba(t,e,s,i,o,d){const l=L("Icon"),f=L("Program"),v=L("RecordedProgram"),m=L("Channel"),u=L("Series"),r=L("Comment"),w=L("Twitter"),n=L("Remocon");return c(),_("div",{class:"watch-panel",onMousemove:e[9]||(e[9]=h=>t.playerStore.event_emitter.emit("SetControlDisplayTimer",{event:h}))},[a("div",Ra,[g((c(),_("div",{class:"panel-close-button",onClick:e[0]||(e[0]=h=>t.playerStore.is_panel_display=!1)},[p(l,{class:"panel-close-button__icon",icon:"akar-icons:chevron-right",width:"25px"}),e[10]||(e[10]=a("span",{class:"panel-close-button__text"},"閉じる",-1))])),[[b]]),p(me),t.playback_mode==="Live"?(c(),_("div",Ma,[a("img",{class:"panel-broadcaster__icon",src:`${t.Utils.api_base_url}/channels/${t.channelsStore.channel.current.id}/logo`},null,8,Ia),a("div",Aa,k(t.channelsStore.channel.current.channel_number),1),a("div",Va,k(t.channelsStore.channel.current.name),1)])):V("",!0)]),a("div",xa,[t.playback_mode==="Live"?(c(),F(f,{key:0,class:S(["watch-panel__content",{"watch-panel__content--active":t.panel_active_tab==="Program"}])},null,8,["class"])):V("",!0),t.playback_mode==="Video"?(c(),F(v,{key:1,class:S(["watch-panel__content",{"watch-panel__content--active":t.panel_active_tab==="RecordedProgram"}])},null,8,["class"])):V("",!0),t.playback_mode==="Live"?(c(),F(m,{key:2,class:S(["watch-panel__content",{"watch-panel__content--active":t.panel_active_tab==="Channel"}])},null,8,["class"])):V("",!0),t.playback_mode==="Video"?(c(),F(u,{key:3,class:S(["watch-panel__content",{"watch-panel__content--active":t.panel_active_tab==="Series"}])},null,8,["class"])):V("",!0),p(r,{class:S(["watch-panel__content",{"watch-panel__content--active":t.panel_active_tab==="Comment"}]),playback_mode:t.playback_mode},null,8,["playback_mode","class"]),p(w,{class:S(["watch-panel__content",{"watch-panel__content--active":t.panel_active_tab==="Twitter"}]),playback_mode:t.playback_mode},null,8,["playback_mode","class"]),t.playback_mode==="Live"?g((c(),_("button",{key:4,class:S(["watch-panel__content-remocon-button elevation-8",{"watch-panel__content-remocon-button--active":t.panel_active_tab==="Program"||t.panel_active_tab==="Channel"}]),onClick:e[1]||(e[1]=h=>t.playerStore.is_remocon_display=!t.playerStore.is_remocon_display)},[p(l,{class:"panel-close-button__icon",icon:"material-symbols:remote-gen",width:"25px"})],2)),[[b]]):V("",!0),t.playback_mode==="Live"?(c(),F(n,{key:5,class:"watch-panel__remocon",modelValue:(t.panel_active_tab==="Program"||t.panel_active_tab==="Channel")&&t.playerStore.is_remocon_display===!0,"onUpdate:modelValue":e[2]||(e[2]=h=>t.playerStore.is_remocon_display=h)},null,8,["modelValue"])):V("",!0)]),a("div",Ea,[t.playback_mode==="Live"?g((c(),_("div",{key:0,class:S(["panel-navigation-button",{"panel-navigation-button--active":t.panel_active_tab==="Program"}]),onClick:e[3]||(e[3]=h=>t.playerStore.tv_panel_active_tab="Program")},[p(l,{class:"panel-navigation-button__icon",icon:"fa-solid:info-circle",width:"33px"}),e[11]||(e[11]=a("span",{class:"panel-navigation-button__text"},"番組情報",-1))],2)),[[b]]):V("",!0),t.playback_mode==="Video"?g((c(),_("div",{key:1,class:S(["panel-navigation-button",{"panel-navigation-button--active":t.panel_active_tab==="RecordedProgram"}]),onClick:e[4]||(e[4]=h=>t.playerStore.video_panel_active_tab="RecordedProgram")},[p(l,{class:"panel-navigation-button__icon",icon:"fa-solid:info-circle",width:"33px"}),e[12]||(e[12]=a("span",{class:"panel-navigation-button__text"},"番組情報",-1))],2)),[[b]]):V("",!0),t.playback_mode==="Live"?g((c(),_("div",{key:2,class:S(["panel-navigation-button",{"panel-navigation-button--active":t.panel_active_tab==="Channel"}]),onClick:e[5]||(e[5]=h=>t.playerStore.tv_panel_active_tab="Channel")},[p(l,{class:"panel-navigation-button__icon",icon:"fa-solid:broadcast-tower",width:"34px"}),e[13]||(e[13]=a("span",{class:"panel-navigation-button__text"},"チャンネル",-1))],2)),[[b]]):V("",!0),t.playback_mode==="Video"?g((c(),_("div",{key:3,class:S(["panel-navigation-button",{"panel-navigation-button--active":t.panel_active_tab==="Series"}]),onClick:e[6]||(e[6]=h=>t.playerStore.video_panel_active_tab="Series")},[p(l,{class:"panel-navigation-button__icon",icon:"fluent:video-clip-multiple-16-filled",width:"34px",style:{width:"39px",height:"39px","margin-top":"-4px","margin-bottom":"-4px"}}),e[14]||(e[14]=a("span",{class:"panel-navigation-button__text"},"シリーズ",-1))],2)),[[b]]):V("",!0),g((c(),_("div",{class:S(["panel-navigation-button",{"panel-navigation-button--active":t.panel_active_tab==="Comment"}]),onClick:e[7]||(e[7]=h=>t.playback_mode==="Live"?t.playerStore.tv_panel_active_tab="Comment":t.playerStore.video_panel_active_tab="Comment")},[p(l,{class:"panel-navigation-button__icon",icon:"bi:chat-left-text-fill",width:"29px"}),e[15]||(e[15]=a("span",{class:"panel-navigation-button__text"},"コメント",-1))],2)),[[b]]),g((c(),_("div",{class:S(["panel-navigation-button",{"panel-navigation-button--active":t.panel_active_tab==="Twitter"}]),onClick:e[8]||(e[8]=h=>t.playback_mode==="Live"?t.playerStore.tv_panel_active_tab="Twitter":t.playerStore.video_panel_active_tab="Twitter")},[p(l,{class:"panel-navigation-button__icon",icon:"fa-brands:twitter",width:"34px"}),e[16]||(e[16]=a("span",{class:"panel-navigation-button__text"},"Twitter",-1))],2)),[[b]])])],32)}const Ha=B(Pa,[["render",Ba],["__scopeId","data-v-598a6b71"]]),Da={class:"watch-player__background-wrapper"},Oa=E({__name:"Player",props:{playback_mode:{type:String,required:!0}},setup(t){const e=q(),s=I(),i=D(),o=()=>{const d=document.querySelector(".dplayer-mask");d&&d.click()};return(d,l)=>{const f=L("Icon"),v=Be("ftooltip");return c(),_("div",{class:S(["watch-player",{"watch-player--loading":$(s).is_loading,"watch-player--virtual-keyboard-display":$(s).is_virtual_keyboard_display&&$(y).hasActiveElementClass("dplayer-comment-input"),"watch-player--video":t.playback_mode==="Video","watch-player--pure-black":$(i).settings.use_pure_black_player_background}])},[a("div",Da,[a("div",{class:S(["watch-player__background",{"watch-player__background--display":$(s).is_background_display,"watch-player__background--background-hide":$(i).settings.show_player_background_image===!1}]),style:se({backgroundImage:`url(${$(s).background_url})`})},[...l[6]||(l[6]=[a("img",{class:"watch-player__background-logo",src:Fe},null,-1)])],6)]),p($e,{indeterminate:"",size:"60",width:"6",class:S(["watch-player__buffering",{"watch-player__buffering--display":$(s).is_video_buffering}])},null,8,["class"]),l[7]||(l[7]=a("div",{class:"watch-player__dplayer"},null,-1)),a("div",{class:S(["watch-player__dplayer-setting-cover",{"watch-player__dplayer-setting-cover--display":$(s).is_player_setting_panel_open}]),onClick:o},null,2),a("div",{class:"watch-player__button",onMousemove:l[3]||(l[3]=m=>$(s).event_emitter.emit("SetControlDisplayTimer",{event:m})),onTouchmove:l[4]||(l[4]=m=>$(s).event_emitter.emit("SetControlDisplayTimer",{event:m})),onClick:l[5]||(l[5]=m=>$(s).event_emitter.emit("SetControlDisplayTimer",{event:m}))},[t.playback_mode==="Live"?g((c(),_("div",{key:0,class:"switch-button switch-button-up",onClick:l[0]||(l[0]=m=>{$(s).is_zapping=!0,d.$router.push({path:`/tv/watch/${$(e).channel.previous.display_channel_id}`})})},[p(f,{class:"switch-button-icon",icon:"fluent:ios-arrow-left-24-filled",width:"32px",style:{transform:"rotate(90deg)"}})])),[[b],[v,"前のチャンネル",void 0,{top:!0}]]):V("",!0),g((c(),_("div",{class:S(["switch-button switch-button-panel",{"switch-button-panel--open":$(s).is_panel_display}]),onClick:l[1]||(l[1]=m=>$(s).is_panel_display=!$(s).is_panel_display)},[p(f,{class:"switch-button-icon",icon:"fluent:navigation-16-filled",width:"32px"})],2)),[[b]]),t.playback_mode==="Live"?g((c(),_("div",{key:1,class:"switch-button switch-button-down",onClick:l[2]||(l[2]=m=>{$(s).is_zapping=!0,d.$router.push({path:`/tv/watch/${$(e).channel.next.display_channel_id}`})})},[p(f,{class:"switch-button-icon",icon:"fluent:ios-arrow-right-24-filled",width:"33px",style:{transform:"rotate(90deg)"}})])),[[b],[v,"次のチャンネル",void 0,{bottom:!0}]]):V("",!0)],32)],2)}}}),Fa=B(Oa,[["__scopeId","data-v-fa4f3f48"]]),Ua=E({name:"Watch",components:{KeyboardShortcutList:Ne,LShapedScreenCropSettings:Rt,WatchHeader:ft,WatchNavigation:Ue,WatchPanel:Ha,WatchPlayer:Fa},props:{playback_mode:{type:String,required:!0}},data(){return{Utils:Object.freeze(y)}},computed:{...z(I,D)},watch:{"playerStore.is_panel_display":{handler(){this.settingsStore.settings.showed_panel_last_time=this.playerStore.is_panel_display}}},created(){"virtualKeyboard"in navigator&&(navigator.virtualKeyboard.overlaysContent=!0,navigator.virtualKeyboard.ongeometrychange=t=>{t.target.boundingRect.width===0&&t.target.boundingRect.height===0?this.playerStore.is_virtual_keyboard_display=!1:this.playerStore.is_virtual_keyboard_display=!0}),this.playerStore.startWatching()},beforeUnmount(){this.playerStore.stopWatching(),"virtualKeyboard"in navigator&&(navigator.virtualKeyboard.overlaysContent=!1)}}),Na={class:"route-container"};function qa(t,e,s,i,o,d){const l=L("WatchNavigation"),f=L("WatchHeader"),v=L("WatchPlayer"),m=L("WatchPanel"),u=L("KeyboardShortcutList"),r=L("LShapedScreenCropSettings");return c(),_("div",Na,[a("main",{class:S(["watch-container",{"watch-container--control-display":t.playerStore.is_control_display,"watch-container--panel-display":t.Utils.isSmartphoneVertical()||t.Utils.isTabletVertical()?!0:t.playerStore.is_panel_display,"watch-container--fullscreen":t.playerStore.is_fullscreen,"watch-container--document-pip":t.playerStore.is_document_pip,"watch-container--video":t.playback_mode==="Video"}])},[p(l),a("div",{class:"watch-content",onMousemove:e[0]||(e[0]=w=>t.playerStore.event_emitter.emit("SetControlDisplayTimer",{event:w,is_player_region_event:!0})),onTouchmove:e[1]||(e[1]=w=>t.playerStore.event_emitter.emit("SetControlDisplayTimer",{event:w,is_player_region_event:!0})),onClick:e[2]||(e[2]=w=>t.playerStore.event_emitter.emit("SetControlDisplayTimer",{event:w,is_player_region_event:!0}))},[p(f,{playback_mode:t.playback_mode},null,8,["playback_mode"]),p(v,{playback_mode:t.playback_mode},null,8,["playback_mode"])],32),p(m,{playback_mode:t.playback_mode},null,8,["playback_mode"])],2),p(u,{playback_mode:t.playback_mode},null,8,["playback_mode"]),p(r)])}const uo=B(Ua,[["render",qa],["__scopeId","data-v-c9d62209"]]);class Wa extends qe{constructor(s,i){super(s,i);T(this,"onCustomBufferFlushingHandler");T(this,"dontFlush",!1);T(this,"sse",null);T(this,"serverBufferingRange",null);this.onCustomBufferFlushingHandler=this.onCustomBufferFlushing.bind(this),this.dontFlush=!1}onBufferReset(){if(this.dontFlush){this.dontFlush=!1;return}super.onBufferReset()}onMediaAttaching(s,i){super.onMediaAttaching(s,i);const o=this.hls;this.media.addEventListener("seeking",this.onCustomBufferFlushingHandler),this.sse=new EventSource(o.url.replace("playlist","buffer")),this.sse.addEventListener("buffer_range_update",l=>{this.serverBufferingRange=JSON.parse(l.data),console.log("[CustomBufferController] Updated Server Buffering Range:",this.serverBufferingRange)})}onMediaDetaching(){this.media.removeEventListener("seeking",this.onCustomBufferFlushingHandler),this.sse&&(this.sse.close(),this.sse=null),super.onMediaDetaching()}onCustomBufferFlushing(){const s=this.hls,i=this.media;if(!i)return;let o=!1,d=!1;const l=i.duration;for(let f=0;f<i.buffered.length;f++)if(i.currentTime>=i.buffered.start(f)&&i.currentTime<=i.buffered.end(f)){o=!0;break}if(this.serverBufferingRange&&i.currentTime>=this.serverBufferingRange.begin&&i.currentTime<=this.serverBufferingRange.end&&(o=!0),i.currentTime>=l-.5&&(d=!0),console.log("[CustomBufferController] Server Buffering Range:",this.serverBufferingRange,"Current Time:",i.currentTime),!o&&!d){console.log("[CustomBufferController] Flushing Buffer..."),s.trigger(ae.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.dontFlush=!0;const f=new URL(s.url);f.searchParams.set("cache_key",crypto.randomUUID().split("-")[0]),s.trigger(ae.Events.MANIFEST_LOADING,{url:f.toString()})}}}function za(t,e=0,{start:s=!0,middle:i=!0,once:o=!1}={}){let d=s,l=0,f,v=!1;function m(...u){if(v)return;const r=Date.now()-l;l=Date.now(),s&&i&&r>=e&&(d=!0),d?(d=!1,t.apply(this,u),o&&m.cancel()):(i&&r<e||!i)&&(clearTimeout(f),f=setTimeout(()=>{l=Date.now(),t.apply(this,u),o&&m.cancel()},i?e-r:e))}return m.cancel=()=>{clearTimeout(f),v=!0},m}class be{constructor(e){T(this,"restart_required_when_quality_switched",!1);T(this,"player");T(this,"watch_session",null);T(this,"comment_session",null);T(this,"vpos_base_timestamp",0);T(this,"keep_seat_interval_id",null);T(this,"abort_controller",new AbortController);T(this,"reconnecting",!1);T(this,"destroyed",!1);this.player=e}get watch_session_type(){var e;return((e=this.watch_session)==null?void 0:e.url.includes("nicovideo.jp"))===!0?"ニコニコ実況":"NX-Jikkyo "}async init(){const e=I(),s=J();this.destroyed=!1,await s.fetchUser();const i=await this.initWatchSession();if(i.is_success===!1){e.live_comment_init_failed_message=i.detail,console.error(`[LiveCommentManager][WatchSession] Error: ${i.detail}`),i.detail!=="このチャンネルはニコニコ実況に対応していません。"&&this.player.template.notice.textContent.includes("再起動しています…")===!1&&this.player.notice(i.detail,void 0,void 0,"#FF6F6A");return}this.initCommentSession(i),console.log("[LiveCommentManager] Initialized.")}async initWatchSession(){var v;const e=q(),s=D(),i=J();let o=!1;const d=await Oe.fetchWebSocketInfo(e.channel.current.id);if(d===null)return{is_success:!1,detail:"コメント受信用 WebSocket API の情報を取得できませんでした。"};if(d.watch_session_url===null)return{is_success:!1,detail:"このチャンネルはニコニコ実況に対応していません。"};let l=d.watch_session_url;s.settings.prefer_posting_to_nicolive===!0&&(d.nicolive_watch_session_url!==null?(console.log("[LiveCommentManager][WatchSession] Post comments to Nicolive."),l=d.nicolive_watch_session_url):d.is_nxjikkyo_exclusive===!0?console.warn("[LiveCommentManager][WatchSession] Failed to get Nicolive watch session URL. (This channel is exclusive to NX-Jikkyo.)"):i.user===null?console.warn("[LiveCommentManager][WatchSession] Failed to get Nicolive watch session URL. (Not logged in to KonomiTV)"):((v=i.user)==null?void 0:v.niconico_user_id)===null?console.warn("[LiveCommentManager][WatchSession] Failed to get Nicolive watch session URL. (Not linked with Niconico account)"):d.nicolive_watch_session_error!==null&&(console.warn(`[LiveCommentManager][WatchSession] Failed to get Nicolive watch session URL. (${d.nicolive_watch_session_error})`),this.player.notice(`${d.nicolive_watch_session_error}代わりに NX-Jikkyo にコメントします。`,void 0,void 0,"#FFA86A"))),console.log(`[LiveCommentManager][WatchSession] Connected to ${l}`),this.watch_session=new WebSocket(l),this.watch_session.addEventListener("open",()=>{var m;(m=this.watch_session)==null||m.send(JSON.stringify({type:"startWatching",data:{reconnect:!1}}))},{signal:this.abort_controller.signal});const f=async m=>{if(o===!0)return;const u=m instanceof CloseEvent?m.code:"Error";this.player.template.notice.textContent.includes("再起動しています…")===!1&&this.player.notice(`${this.watch_session_type}との接続が切断されました。(Code: ${u})`,void 0,void 0,"#FF6F6A"),console.error(`[LiveCommentManager][WatchSession] Connection closed. (Code: ${u})`),await y.sleep(3),await this.reconnect()};return this.watch_session.addEventListener("close",f,{signal:this.abort_controller.signal}),this.watch_session.addEventListener("error",f,{signal:this.abort_controller.signal}),this.watch_session.addEventListener("message",async m=>{if(this.watch_session===null)return;const u=JSON.parse(m.data);switch(u.type){case"seat":{if(this.keep_seat_interval_id!==null)break;this.keep_seat_interval_id=window.setInterval(()=>{this.watch_session&&this.watch_session.readyState===WebSocket.OPEN?this.watch_session.send(JSON.stringify({type:"keepSeat"})):window.clearInterval(this.keep_seat_interval_id??0)},u.data.keepIntervalSec*1e3);break}case"ping":{this.watch_session.send(JSON.stringify({type:"pong"}));break}case"error":{if(u.data.code==="COMMENT_POST_NOT_ALLOWED"||u.data.code==="INVALID_MESSAGE")break;let r=`${this.watch_session_type}でエラーが発生しています。(Code: ${u.data.code})`;switch(u.data.code){case"CONNECT_ERROR":r=`${this.watch_session_type}のコメントサーバーに接続できません。`;break;case"CONTENT_NOT_READY":r=`${this.watch_session_type}が配信できない状態です。`;break;case"NO_THREAD_AVAILABLE":r=`${this.watch_session_type}のコメントスレッドを取得できません。`;break;case"NO_ROOM_AVAILABLE":r=`${this.watch_session_type}のコメント部屋を取得できません。`;break;case"NO_PERMISSION":r=`${this.watch_session_type}の API にアクセスする権限がありません。`;break;case"NOT_ON_AIR":r=`${this.watch_session_type}が放送中ではありません。`;break;case"BROADCAST_NOT_FOUND":r=`${this.watch_session_type}の配信情報を取得できません。`;break;case"INTERNAL_SERVERERROR":r=`${this.watch_session_type}でサーバーエラーが発生しています。`;break}this.player.template.notice.textContent.includes("再起動しています…")===!1&&this.player.notice(r,void 0,void 0,"#FF6F6A"),console.error(`[LiveCommentManager][WatchSession] Error occurred. (Code: ${u.data.code})`),await y.sleep(3),await this.reconnect();break}case"reconnect":{await this.reconnect();break}case"disconnect":{o=!0;let r=`${this.watch_session_type}との接続が切断されました。(${u.data.reason})`;switch(u.data.reason){case"TAKEOVER":r=`${this.watch_session_type}の番組から追い出されました。`;break;case"NO_PERMISSION":r=`${this.watch_session_type}の番組の座席を取得できませんでした。`;break;case"END_PROGRAM":r=`${this.watch_session_type}がリセットされたか、コミュニティの番組が終了しました。`;break;case"PING_TIMEOUT":r="コメントサーバーとの接続生存確認に失敗しました。";break;case"TOO_MANY_CONNECTIONS":r=`${this.watch_session_type}の同一ユーザからの接続数上限を越えています。`;break;case"TOO_MANY_WATCHINGS":r=`${this.watch_session_type}の同一ユーザからの視聴番組数上限を越えています。`;break;case"CROWDED":r=`${this.watch_session_type}の番組が満席です。`;break;case"MAINTENANCE_IN":r=`${this.watch_session_type}はメンテナンス中です。`;break;case"SERVICE_TEMPORARILY_UNAVAILABLE":r=`${this.watch_session_type}で一時的にサーバーエラーが発生しています。`;break}this.player.template.notice.textContent.includes("再起動しています…")===!1&&this.player.notice(r,void 0,void 0,"#FF6F6A"),console.error(`[LiveCommentManager][WatchSession] Disconnected. (Reason: ${u.data.reason})`),await y.sleep(3),await this.reconnect();break}}},{signal:this.abort_controller.signal}),new Promise(m=>{this.watch_session.addEventListener("message",async u=>{const r=JSON.parse(u.data);if(r.type==="room")return this.vpos_base_timestamp=W(r.data.vposBaseTime).valueOf(),console.log(`[LiveCommentManager][WatchSession] Connected.
Thread ID: ${r.data.threadId}`),m({is_success:!0,detail:"視聴セッションを取得しました。",message_server_url:r.data.messageServer.uri,thread_id:r.data.threadId,your_post_key:r.data.yourPostKey?r.data.yourPostKey:null});if(r.type==="messageServer"){this.vpos_base_timestamp=W(r.data.vposBaseTime).valueOf();const w=r.data.hashedUserId;return console.log("[LiveCommentManager][WatchSession] Connected."),m({is_success:!0,detail:"視聴セッションを取得しました。",message_server_url:d.comment_session_url,thread_id:"",your_post_key:`nicolive:${w}`})}},{signal:this.abort_controller.signal})})}initCommentSession(e){const s=I(),i=J(),o=[];let d=!1;const l=[];this.comment_session=new WebSocket(e.message_server_url),this.comment_session.addEventListener("open",()=>{this.comment_session!==null&&this.comment_session.send(JSON.stringify([{ping:{content:"rs:0"}},{ping:{content:"ps:0"}},{thread:{version:"20061206",thread:e.thread_id,threadkey:e.your_post_key,user_id:"",res_from:-100}},{ping:{content:"pf:0"}},{ping:{content:"rf:0"}}]))},{signal:this.abort_controller.signal});const f=async m=>{const u=m instanceof CloseEvent?m.code:"Error";this.player.template.notice.textContent.includes("再起動しています…")===!1&&this.player.notice(`NX-Jikkyo との接続が切断されました。(Code: ${u})`,void 0,void 0,"#FF6F6A"),console.error(`[LiveCommentManager][CommentSession] Connection closed. (Code: ${u})`),await y.sleep(3),await this.reconnect()};this.comment_session.addEventListener("close",f,{signal:this.abort_controller.signal}),this.comment_session.addEventListener("error",f,{signal:this.abort_controller.signal});const v=za(()=>{y.isSafari()===!1&&console.debug("[LiveCommentManager][CommentSession] Comments buffer length:",l.length),this.destroyed===!1&&s.event_emitter.emit("CommentReceived",{is_initial_comments:!1,comments:l}),l.length=0},333);this.comment_session.addEventListener("message",async m=>{var A,U;const u=JSON.parse(m.data);if(u.thread!==void 0&&u.thread.resultcode!==0){console.error(`[LiveCommentManager][CommentSession] Connection failed. (Code: ${u.thread.resultcode})`);return}if(u.ping!==void 0&&u.ping.content==="rf:0"){d=!0,this.destroyed===!1&&s.event_emitter.emit("CommentReceived",{is_initial_comments:!0,comments:o});return}const r=u.chat;if(r===void 0||r.content===void 0||r.content===""||r.yourpost&&r.yourpost===1&&d===!0||((U=(A=i.user)==null?void 0:A.niconico_user_id)==null?void 0:U.toString())===r.user_id.replace("nicolive:",""))return;const{color:w,position:n,size:h}=X.parseCommentCommand(r.mail);if(X.isMutedComment(r.content,r.user_id,w,n,h))return;const C={id:r.no,text:r.content,time:y.apply28HourClock(W(r.date*1e3).format("HH:mm:ss")),playback_position:this.player.video.currentTime,user_id:r.user_id,my_post:!1};if(d===!1){o.push(C);return}let P=0;this.player.video.buffered.length>=1&&(P=this.player.video.buffered.end(0));const R=Math.max(P-this.player.video.currentTime,0);y.isSafari()===!1&&console.debug(`[LiveCommentManager][CommentSession] Delay: ${R} sec.`),await y.sleep(R),l.push(C),v(),this.player.video.paused===!1&&this.player.danmaku.draw({text:r.content,color:w,type:n,size:h})},{signal:this.abort_controller.signal})}sendComment(e){var m,u;const s=I(),i=D(),o=J();if(s.live_comment_init_failed_message!==null){e.error(s.live_comment_init_failed_message);return}if(i.settings.prefer_posting_to_nicolive===!0&&(o.user===null?this.player.notice("ニコニコ実況にコメントするには、KonomiTV アカウントにログインしてください。代わりに NX-Jikkyo にコメントします。",void 0,void 0,"#FFA86A"):o.user.niconico_user_id===null&&this.player.notice("ニコニコ実況にコメントするには、ニコニコアカウントと連携してください。代わりに NX-Jikkyo にコメントします。",void 0,void 0,"#FFA86A")),this.watch_session_type==="ニコニコ実況"){if(((m=o.user)==null?void 0:m.niconico_user_premium)===!1&&(e.data.type==="top"||e.data.type==="bottom")){e.error("ニコニコ実況でコメントを上下に固定するには、ニコニコアカウントのプレミアム会員登録が必要です。");return}if(((u=o.user)==null?void 0:u.niconico_user_premium)===!1&&e.data.size==="big"){e.error("ニコニコ実況でコメントサイズを大きめに設定するには、ニコニコアカウントのプレミアム会員登録が必要です。");return}}if(this.watch_session===null||this.watch_session.readyState!==WebSocket.OPEN){console.error("[LiveCommentManager][WatchSession] Comment sending failed. (Connection is not established.)"),e.error("コメントの送信に失敗しました。WebSocket 接続が確立されていません。");return}const d={"#FFEAEA":"white","#F02840":"red","#FD7E80":"pink","#FDA708":"orange","#FFE133":"yellow","#64DD17":"green","#00D4F5":"cyan","#4763FF":"blue"},l={top:"ue",right:"naka",bottom:"shita"},f=Math.round((W().valueOf()-this.vpos_base_timestamp)/10);this.watch_session.send(JSON.stringify({type:"postComment",data:{text:e.data.text,color:d[e.data.color.toUpperCase()],position:l[e.data.type],size:e.data.size,vpos:f,isAnonymous:!0}}));const v=new AbortController;this.watch_session.addEventListener("message",r=>{var n;const w=JSON.parse(r.data);switch(w.type){case"postCommentResult":{e.success(),s.event_emitter.emit("CommentSendCompleted",{comment:{id:y.time(),text:e.data.text,time:y.apply28HourClock(W().format("HH:mm:ss")),playback_position:this.player.video.currentTime,user_id:`${((n=o.user)==null?void 0:n.niconico_user_id)??"Unknown"}`,my_post:!0}}),v.abort();break}case"error":{let h=`コメントの送信に失敗しました。(${w.data.code})`;switch(w.data.code){case"COMMENT_POST_NOT_ALLOWED":h="コメントが許可されていません。";break;case"INVALID_MESSAGE":h="コメント内容が無効です。";break}console.error(`[LiveCommentManager][WatchSession] Comment sending failed. (Code: ${w.data.code})`),e.error(h),v.abort();break}}},{signal:v.signal})}async reconnect(){const e=I(),s=this.watch_session!==null&&(this.watch_session.readyState===WebSocket.CLOSING||this.watch_session.readyState===WebSocket.CLOSED),i=this.comment_session!==null&&(this.comment_session.readyState===WebSocket.CLOSING||this.comment_session.readyState===WebSocket.CLOSED);if(this.reconnecting===!0&&s===!1&&i===!1)return;this.reconnecting=!0,console.warn("[LiveCommentManager] Reconnecting..."),this.player.template.notice.textContent.includes("再起動しています…")===!1&&this.player.notice(`${this.watch_session_type}に再接続しています…`),await this.destroy();const o=await this.initWatchSession();if(o.is_success===!1){e.live_comment_init_failed_message=o.detail,console.error("[LiveCommentManager] Reconnection failed."),this.player.template.notice.textContent.includes("再起動しています…")===!1&&this.player.notice(o.detail,void 0,void 0,"#FF6F6A"),this.reconnecting=!1;return}this.initCommentSession(o),this.destroyed=!1,this.reconnecting=!1,console.warn("[LiveCommentManager] Reconnected.")}async destroy(){const e=I();this.abort_controller.abort(),this.abort_controller=new AbortController,this.watch_session!==null&&(this.watch_session.close(),this.watch_session=null),this.comment_session!==null&&(this.comment_session.close(),this.comment_session=null),this.keep_seat_interval_id!==null&&(window.clearInterval(this.keep_seat_interval_id),this.keep_seat_interval_id=null),this.vpos_base_timestamp=0,e.live_comment_init_failed_message=null,this.destroyed=!0,console.log("[LiveCommentManager] Destroyed.")}}const O=class O{constructor(e){T(this,"player",null);T(this,"player_managers",[]);T(this,"playback_mode");T(this,"quality_profile_type");T(this,"live_force_seek_interval_timer_cancel",null);T(this,"video_keep_alive_interval_timer_cancel",null);T(this,"player_container_resize_observer",null);T(this,"player_control_ui_hide_timer_id",0);T(this,"watched_history_threshold_timer_id",0);T(this,"screen_wake_lock",null);T(this,"romsounds_context",new AudioContext);T(this,"romsounds_buffers",[]);T(this,"lshaped_screen_crop_watchers",[]);T(this,"destroying",!1);T(this,"destroyed",!1);this.playback_mode=e,K.getNetworkCircuitType()==="Cellular"?this.quality_profile_type="Cellular":this.quality_profile_type="Wi-Fi",(async()=>{for(let i=1;i<=14;i++){const o=`/assets/romsounds/${i.toString().padStart(2,"0")}.wav`,d=await ue.get(o,{baseURL:"",responseType:"arraybuffer"});d.type==="success"&&this.romsounds_buffers.push(await this.romsounds_context.decodeAudioData(d.data))}})()}get quality_profile(){const e=D();return this.quality_profile_type==="Cellular"?{tv_streaming_quality:e.settings.tv_streaming_quality_cellular,tv_data_saver_mode:e.settings.tv_data_saver_mode_cellular,tv_low_latency_mode:e.settings.tv_low_latency_mode_cellular,video_streaming_quality:e.settings.video_streaming_quality_cellular,video_data_saver_mode:e.settings.video_data_saver_mode_cellular}:{tv_streaming_quality:e.settings.tv_streaming_quality,tv_data_saver_mode:e.settings.tv_data_saver_mode,tv_low_latency_mode:e.settings.tv_low_latency_mode,video_streaming_quality:e.settings.video_streaming_quality,video_data_saver_mode:e.settings.video_data_saver_mode}}get live_playback_buffer_seconds(){let e=this.quality_profile.tv_low_latency_mode?O.LIVE_PLAYBACK_BUFFER_SECONDS_LOW_LATENCY:O.LIVE_PLAYBACK_BUFFER_SECONDS;return y.isSafari()===!0&&(e+=.3),e}async init(e={default_quality:null,playback_rate:null,seek_seconds:null}){var r,w;const s=q(),i=I(),o=D();console.log("\x1B[31m[PlayerController] Initializing..."),this.destroyed=!1,i.is_player_initialized=!0,window.mpegts=G,window.Hls=ae;let d=!1;K.isHEVCVideoSupported()&&(this.playback_mode==="Live"&&this.quality_profile.tv_data_saver_mode===!0||this.playback_mode==="Video"&&this.quality_profile.video_data_saver_mode===!0)&&(d=!0);const l=await G.supportWorkerForMSEH265Playback(),f=this.playback_mode==="Live"?o.settings.tv_show_superimpose:o.settings.video_show_superimpose;let v=e.seek_seconds;if(v===null){const n=o.settings.watched_history.find(h=>h.video_id===i.recorded_program.id);n?(v=n.last_playback_position,console.log(`\x1B[31m[PlayerController] Seeking to ${v} seconds. (Watched History)`)):(v=i.recorded_program.recording_start_margin+2,console.log(`\x1B[31m[PlayerController] Seeking to ${v} seconds. (Recording Start Margin + 2)`))}localStorage.getItem("dplayer-danmaku-opacity")===null&&localStorage.setItem("dplayer-danmaku-opacity","0.5");const m=[];if(this.playback_mode==="Video"&&((w=(r=i.recorded_program)==null?void 0:r.recorded_video)!=null&&w.cm_sections)){const n=i.recorded_program.recorded_video.cm_sections,C=i.recorded_program.recorded_video.duration-2;for(const P of n)P.start_time<=C&&m.push({text:"CM",time:P.start_time}),P.end_time<=C&&m.push({text:"本編",time:P.end_time});console.log("\x1B[31m[PlayerController] Added CM section markers:",m)}this.player=new We({container:document.querySelector(".watch-player__dplayer"),theme:"#E64F97",lang:"ja-jp",live:this.playback_mode==="Live",liveSyncMinBufferSize:this.live_playback_buffer_seconds-.1,loop:this.playback_mode!=="Live",autoplay:!0,airplay:!1,hotkey:!1,screenshot:!1,crossOrigin:"anonymous",volume:1,playbackSpeed:[.25,.5,.75,1,1.1,1.25,1.5,1.75,2],highlight:m.length>0?m:void 0,video:(()=>{const n=[],h=d===!0?"-hevc":"";if(this.playback_mode==="Live"){const C=`${y.api_base_url}/streams/live/${s.channel.current.display_channel_id}`;if(s.channel.current.is_radiochannel===!0)n.push({name:"48kHz/192kbps",type:"mpegts",url:`${C}/1080p/mpegts`});else for(const R of He)n.push({name:R==="1080p-60fps"?"1080p (60fps)":R,type:"mpegts",url:`${C}/${R}${h}/mpegts`});let P=this.quality_profile.tv_streaming_quality;return e.default_quality!==null&&(P=e.default_quality),s.channel.current.is_radiochannel&&(P="48kHz/192kbps"),{quality:n,defaultQuality:P}}else{const C=`${y.api_base_url}/streams/video/${i.recorded_program.id}`;for(const R of De){const A=crypto.randomUUID().split("-")[0];n.push({name:R==="1080p-60fps"?"1080p (60fps)":R,type:"hls",url:`${C}/${R}${h}/playlist?session_id=${A}`})}let P=this.quality_profile.video_streaming_quality;return e.default_quality!==null&&(P=e.default_quality),{quality:n,defaultQuality:P,thumbnails:{url:`${y.api_base_url}/videos/${i.recorded_program.id}/thumbnail/tiled`,interval:(()=>{const R=Math.floor(i.recorded_program.recorded_video.duration/60),A=30,U=5,Z=30;if(R<=A)return U;const Q=R/A;return Math.min(Z,U*Q/Math.log2(1+Q/2))})(),width:480,height:270,columnCount:34}}}})(),danmaku:{user:"KonomiTV",speedRate:o.settings.comment_speed_rate,fontSize:o.settings.comment_font_size,closeCommentFormAfterSend:o.settings.close_comment_form_after_sending},apiBackend:{read:async n=>{if(this.playback_mode==="Live")n.success([]);else{const h=await dt.fetchVideoJikkyoComments(i.recorded_program.id);if(h.is_success===!1)i.video_comment_init_failed_message=h.detail,h.detail!=="この録画番組の過去ログコメントは存在しないか、現在取得中です。"?n.error(h.detail):n.success([]);else{const P=i.recorded_program.recorded_video.recording_start_time;let R=0;i.event_emitter.emit("CommentReceived",{is_initial_comments:!0,comments:h.comments.map(A=>({id:R++,text:A.text,time:y.apply28HourClock(W(P).add(A.time,"seconds").format("MM/DD HH:mm:ss")),playback_position:A.time,user_id:A.author,my_post:!1}))}),n.success(h.comments)}this.player.danmaku.seek();let C=this.player.video.currentTime;(C===0||isNaN(C))&&(C=v),await y.sleep(.1),i.event_emitter.emit("PlaybackPositionChanged",{playback_position:C}),console.log(`\x1B[31m[PlayerController] Comment list seeking to ${C} seconds.`)}},send:async n=>{if(this.playback_mode==="Live"){for(const h of this.player_managers)if(h instanceof be){h.sendComment(n);return}}else n.error("録画番組にはコメントできません。")}},subtitle:{type:"aribb24"},pluginOptions:{mpegts:{config:{enableWorker:!0,enableWorkerForMSE:!(d===!0&&l===!1),enableStashBuffer:!0,stashInitialSize:Math.floor(2048*1024),liveSync:this.quality_profile.tv_low_latency_mode,liveSyncMaxLatency:3,liveSyncTargetLatency:this.live_playback_buffer_seconds,liveSyncPlaybackRate:1.1}},hls:{...ae.DefaultConfig,enableWorker:!0,preferManagedMediaSource:!1,bufferController:Wa,manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e6,maxLoadTimeMs:1e6,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e6,maxLoadTimeMs:1e6,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e6,maxLoadTimeMs:1e6,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}}},aribb24:{disableSuperimposeRenderer:f===!1,normalFont:(()=>{let n=o.settings.caption_font;return n==="sans-serif"?"sans-serif":(n==="Yu Gothic"&&(n='Yu Gothic Medium","Yu Gothic","YuGothic'),`"${n}", "Rounded M+ 1m for ARIB", sans-serif`)})(),forceStrokeColor:o.settings.always_border_caption_text,forceBackgroundColor:(()=>{if(o.settings.specify_caption_opacity===!0)return`rgba(0, 0, 0, ${o.settings.caption_opacity})`})(),drcsReplacement:!0,enableRawCanvas:!0,useStroke:!0,usePUA:(()=>{const n=o.settings.caption_font,h=document.createElement("canvas").getContext("2d");return h.font='10px "Rounded M+ 1m for ARIB"',h.fillText("Test",0,0),h.font=`10px "${n}"`,h.fillText("Test",0,0),!!n.startsWith("Windows TV")})(),PRACallback:async n=>{if(f===!1)return;this.romsounds_context.state==="suspended"&&await this.romsounds_context.resume();const h=this.romsounds_context.createBufferSource();h.buffer=this.romsounds_buffers[n];const C=this.romsounds_context.createGain();h.connect(C),C.connect(this.romsounds_context.destination),C.gain.value=3,h.start(0)}}}}),window.player=this.player,this.player.container.classList.contains("dplayer-mobile")===!0&&this.player.volume(1,void 0,!0),this.player.controller.setAutoHide=n=>{},this.setupVideoPlaybackHandler(),this.setupFullscreenHandler(),this.setupSettingPanelHandler(),this.setupLShapedScreenCropHandler(),this.setupPlayerContainerResizeHandler(),this.setControlDisplayTimer(),this.playback_mode==="Video"&&(e.playback_rate!==null&&this.player.speed(e.playback_rate),this.player.seek(v),this.player.bar.set("played",v/i.recorded_program.recorded_video.duration,"width"),v>i.recorded_program.recording_start_margin+2?this.player.notice("前回視聴した続きから再生します"):this.player.hideNotice(),this.player.play(),console.log(`\x1B[31m[PlayerController] Seeking to ${v} seconds.`)),i.event_emitter.off("SendNotification"),i.event_emitter.on("SendNotification",n=>{this.destroyed===!0||this.player===null||this.player.notice(n.message,n.duration,n.opacity,n.color)});let u=!1;i.event_emitter.off("PlayerRestartRequired"),i.event_emitter.on("PlayerRestartRequired",async n=>{var R,A,U,Z;if(this.destroyed===!0||this.player===null)return;if(console.warn("\x1B[31m[PlayerController] PlayerRestartRequired event received. Message: ",n.message),this.playback_mode==="Live"&&G.isSupported()!==!0){console.warn("\x1B[31m[PlayerController] PlayerRestartRequired event received, but mpegts.js is not supported. Ignored."),(R=this.player)==null||R.notice("iOS (Safari) 17.0 以下での視聴には対応していません。速やかに iOS を 17.1 以降に更新してください。",-1,void 0,"#FF6F6A");return}if(u===!0){console.warn("\x1B[31m[PlayerController] PlayerRestartRequired event received, but already restarting. Ignored.");return}u=!0;const h=(A=this.player)!=null&&A.qualityIndex?this.player.options.video.quality[this.player.qualityIndex]:null,C=((U=this.player)==null?void 0:U.video.playbackRate)??null,P=((Z=this.player)==null?void 0:Z.video.currentTime)??null;if(await this.destroy(),this.playback_mode==="Live"&&await y.sleep(.5),await this.init({default_quality:h?h.name:null,playback_rate:this.playback_mode==="Video"?C:null,seek_seconds:this.playback_mode==="Video"?P:null}),u=!1,H(this.player!==null),n.message){await y.sleep(n.message_delay_seconds??0);const Q=n.is_error_message===!1?void 0:"#FF6F6A";this.player.notice(n.message,void 0,void 0,Q)}}),i.event_emitter.off("SetControlDisplayTimer"),i.event_emitter.on("SetControlDisplayTimer",n=>{this.setControlDisplayTimer(n.event,n.is_player_region_event,n.timeout_seconds)}),this.player.container.querySelector(".dplayer-icons.dplayer-icons-right").insertAdjacentHTML("afterbegin",`
            <div class="dplayer-icon dplayer-player-restart-icon" aria-label="プレイヤーを再起動"
                data-balloon-nofocus="" data-balloon-pos="up">
                <span class="dplayer-icon-content">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 5V3.21c0-.45-.54-.67-.85-.35l-2.8 2.79c-.2.2-.2.51 0 .71l2.79 2.79c.32.31.86.09.86-.36V7c3.31 0 6 2.69 6 6c0 2.72-1.83 5.02-4.31 5.75c-.42.12-.69.52-.69.95c0 .65.62 1.16 1.25.97A7.991 7.991 0 0 0 20 13c0-4.42-3.58-8-8-8zm-6 8c0-1.34.44-2.58 1.19-3.59c.3-.4.26-.95-.09-1.31c-.42-.42-1.14-.38-1.5.1a7.991 7.991 0 0 0 4.15 12.47c.63.19 1.25-.32 1.25-.97c0-.43-.27-.83-.69-.95C7.83 18.02 6 15.72 6 13z"/></svg>
                </span>
            </div>
        `),this.player.container.querySelector(".dplayer-player-restart-icon").addEventListener("click",async()=>{var P,R,A,U;const n=(P=this.player)!=null&&P.qualityIndex?this.player.options.video.quality[this.player.qualityIndex]:null,h=((R=this.player)==null?void 0:R.video.playbackRate)??null,C=((A=this.player)==null?void 0:A.video.currentTime)??null;await this.destroy(),await this.init({default_quality:n?n.name:null,playback_rate:this.playback_mode==="Video"?h:null,seek_seconds:this.playback_mode==="Video"?C:null}),(U=this.player)==null||U.notice("プレイヤーを再起動しました。",void 0,void 0,void 0)}),"wakeLock"in navigator&&navigator.wakeLock.request("screen").then(n=>{this.screen_wake_lock=n,console.log("\x1B[31m[PlayerController] Screen Wake Lock API: Screen Wake Lock acquired.")}),this.playback_mode==="Live"?this.player_managers=[new ze(this.player),new be(this.player),new je(this.player),new ve(this.player,this.playback_mode),new he(this.player,this.playback_mode),new ye(this.player,this.playback_mode),new fe(this.player,this.playback_mode)]:this.player_managers=[new ve(this.player,this.playback_mode),new he(this.player,this.playback_mode),new ye(this.player,this.playback_mode),new fe(this.player,this.playback_mode)],await Promise.all(this.player_managers.map(n=>n.init())),console.log("\x1B[31m[PlayerController] Initialized.")}getPlaybackBufferSeconds(){if(this.player===null)return 0;if(this.playback_mode==="Live")try{const e=this.player.video.buffered.length,s=this.player.video.buffered.end(e-1)-this.player.video.currentTime;return y.mathFloor(s,3)}catch{return 0}else return 0}async recoverPlayback(){var s,i,o,d;H(this.player!==null);const e=I();if(await y.sleep(1),e.is_video_buffering===!0&&((i=(s=this.player)==null?void 0:s.video)==null?void 0:i.readyState)<3){console.warn("\x1B[31m[PlayerController] Video still buffering. (HTMLVideoElement.readyState < HAVE_FUTURE_DATA) Trying to recover."),this.player.video.pause(),await y.sleep(.25);try{await this.player.video.play()}catch{H(this.player!==null),console.warn("\x1B[31m[PlayerController] HTMLVideoElement.play() rejected. paused."),this.player.pause();return}if(await y.sleep(.5),e.is_video_buffering===!0&&((d=(o=this.player)==null?void 0:o.video)==null?void 0:d.readyState)<3){console.warn("\x1B[31m[PlayerController] Video still buffering. (HTMLVideoElement.readyState < HAVE_FUTURE_DATA) Trying to recover."),this.player.video.pause(),await y.sleep(.25);try{await this.player.video.play()}catch{H(this.player!==null),console.warn("\x1B[31m[PlayerController] (retry) HTMLVideoElement.play() rejected. paused."),this.player.pause()}}}}setupVideoPlaybackHandler(){H(this.player!==null);const e=q(),s=I(),i=D();this.playback_mode==="Live"&&(this.live_force_seek_interval_timer_cancel=y.setIntervalInWorker(()=>{this.player!==null&&this.player.video.paused&&this.player.video.buffered.length>=1&&this.player.video.buffered.end(0)-this.player.video.currentTime>30&&this.player.sync()},60*1e3)),this.playback_mode==="Video"&&(this.video_keep_alive_interval_timer_cancel=y.setIntervalInWorker(async()=>{if(this.player===null)return;const m=K.extractVideoAPIQualityFromDPlayer(this.player),u=K.extractSessionIdFromDPlayer(this.player);await ue.put(`${y.api_base_url}/streams/video/${s.recorded_program.id}/${m}/keep-alive?session_id=${u}`)},5*1e3));const o=()=>{this.player!==null&&(s.is_video_paused=this.player.video.paused,this.player.video.paused===!0&&s.is_loading===!1&&(s.is_video_buffering=!1),this.player.setting.hide(),this.setControlDisplayTimer())};this.player.on("play",o),this.player.on("pause",o),this.player.on("waiting",()=>{s.is_video_buffering=!0}),this.player.on("playing",()=>{s.is_loading===!1&&(s.is_video_buffering=!1),this.playback_mode==="Live"&&this.recoverPlayback()});const d=async()=>{var m,u;H(this.player!==null),s.background_url=K.generatePlayerBackgroundURL();for(const r of this.player_managers)r.restart_required_when_quality_switched===!0&&r.destroy().then(()=>r.init());if(this.playback_mode==="Live"){if((m=this.player.plugins.mpegts)==null||m.on(G.Events.ERROR,async(n,h)=>{this.player!==null&&(await y.sleep(1),navigator.onLine===!1&&(this.player.notice("現在ネットワーク接続がありません。オンラインになるまで待機しています…",void 0,void 0,"#FF6F6A"),console.warn("\x1B[31m[PlayerController] mpegts.js error event: Network error. Waiting for online..."),await y.waitUntilOnline()),console.error("\x1B[31m[PlayerController] mpegts.js error event:",n,h),s.event_emitter.emit("PlayerRestartRequired",{message:`再生中にエラーが発生しました。(${n}: ${h}) プレイヤーを再起動しています…`}))}),this.player.on("error",async n=>{this.player===null||s.live_stream_status==="Offline"||(await y.sleep(1),this.player.video.error?(console.error("\x1B[31m[PlayerController] HTMLVideoElement error event:",this.player.video.error),s.event_emitter.emit("PlayerRestartRequired",{message:`再生中にエラーが発生しました。(Native: ${this.player.video.error.code}: ${this.player.video.error.message}) プレイヤーを再起動しています…`})):s.event_emitter.emit("PlayerRestartRequired",{message:"再生中にエラーが発生しました。(Native: unknown error) プレイヤーを再起動しています…"}))}),s.is_loading=!0,this.player.video.muted=!0,this.player.video.paused===!0){let n=0;const h=5,C=.05,P=async()=>{var R;if(n>=h){console.warn(`\x1B[31m[PlayerController] Failed to start playback after ${h} attempts.`);return}try{await((R=this.player)==null?void 0:R.video.play()),console.log("\x1B[31m[PlayerController] Playback started successfully.")}catch(A){console.warn(`\x1B[31m[PlayerController] Attempt ${n+1} to start playback failed:`,A),n++,await y.sleep(C),await P()}};await P()}let r=!1;const w=async()=>{if(this.player===null||r===!0)return;this.player.video.oncanplay=null,this.player.video.oncanplaythrough=null,r=!0,console.log("\x1B[31m[PlayerController] Buffering..."),this.player.video.playbackRate=0;const n=this.live_playback_buffer_seconds;let h=this.getPlaybackBufferSeconds();for(;h<n;)await y.sleep(.1),h=this.getPlaybackBufferSeconds();this.player.video.playbackRate=1,console.log("\x1B[31m[PlayerController] Buffering completed."),s.is_loading=!1,s.is_video_buffering=!1,this.recoverPlayback(),e.channel.current.is_radiochannel===!0?s.is_background_display=!0:s.is_background_display=!1,this.player.video.muted=!1,this.player.video.volume=0;const C=this.player.user.get("volume"),P=C/10;for(let R=0;R<10;R++)await y.sleep(.5/10),this.player.video.volume=Math.min(y.mathFloor(this.player.video.volume+P,3),C);this.player.video.volume=C};if(this.player.video.oncanplay=w,this.player.video.oncanplaythrough=w,(u=this.player.plugins.mpegts)==null||u.on(G.Events.MEDIA_INFO,async n=>{console.log("\x1B[31m[PlayerController] mpegts.js media info:",n),await y.sleep(.25),r===!1&&(console.warn("\x1B[31m[PlayerController] mpegts.js media info fired, but canplay(through) event not fired. Trying to manually start playback."),w())}),(async()=>{let n=0;for(;this.player!==null&&this.player.video.readyState<4;){if(this.player.video.readyState<3)n=0;else if(++n>100)break;await y.sleep(.05)}await y.sleep(.1),r===!1&&(console.warn("\x1B[31m[PlayerController] canplay(through) event not fired. Trying to manually start playback."),w())})(),await y.sleep(15),this.destroyed===!0||this.player===null)return;s.live_stream_status==="ONAir"&&s.is_video_buffering===!0&&r===!1&&s.event_emitter.emit("PlayerRestartRequired",{message:"再生開始までに時間が掛かっています。プレイヤーを再起動しています…"})}else{s.is_loading=!0,s.is_background_display=!0;let r=!1;const w=async()=>{this.player!==null&&r!==!0&&(this.player.video.oncanplaythrough=null,r=!0,s.is_loading=!1,s.is_video_buffering=!1,s.is_background_display=!1)};this.player.video.oncanplaythrough=w,this.player.on("error",async n=>{this.player!==null&&(this.player.video.error?(console.error("\x1B[31m[PlayerController] HTMLVideoElement error event:",this.player.video.error),s.event_emitter.emit("PlayerRestartRequired",{message:`再生中にエラーが発生しました。(Native: ${this.player.video.error.code}: ${this.player.video.error.message}) プレイヤーを再起動しています…`})):s.event_emitter.emit("PlayerRestartRequired",{message:"再生中にエラーが発生しました。(Native: unknown error) プレイヤーを再起動しています…"}))})}};d(),this.player.on("quality_start",d);let l=0,f=0;const v=document.querySelector(".program-info__next");if(v!==null&&(v.ontouchstart=()=>{if(this.player===null)return;const m=new Date().getTime(),u=m-f;u<500&&u>0&&(l++,l===3&&(this.player.infoPanel.toggle(),l=0)),f=m}),this.playback_mode==="Video"){this.player.on("timeupdate",()=>{!this.player||!this.player.video||s.event_emitter.emit("PlaybackPositionChanged",{playback_position:this.player.video.currentTime})});let m=0;this.player.on("timeupdate",()=>{if(!this.player||!this.player.video)return;const u=new Date().getTime();if(u-m<O.WATCHED_HISTORY_UPDATE_INTERVAL*1e3)return;m=u;const r=this.player.video.currentTime,w=s.recorded_program.id,n=i.settings.watched_history.findIndex(h=>h.video_id===w);n!==-1&&(i.settings.watched_history[n].last_playback_position=r,i.settings.watched_history[n].updated_at=y.time(),console.log(`\x1B[31m[PlayerController] Last playback position updated. (Video ID: ${w}, last_playback_position: ${r})`))}),this.watched_history_threshold_timer_id=window.setTimeout(()=>{if(!this.player||!this.player.video)return;const u=s.recorded_program.id;if(i.settings.watched_history.findIndex(w=>w.video_id===u)===-1){if(i.settings.watched_history.length>=O.WATCHED_HISTORY_MAX_COUNT){const w=i.settings.watched_history.reduce((n,h,C,P)=>h.created_at<P[n].created_at?C:n,0);i.settings.watched_history.splice(w,1)}i.settings.watched_history.push({video_id:u,last_playback_position:this.player.video.currentTime,created_at:y.time(),updated_at:y.time()}),console.log(`\x1B[31m[PlayerController] Watched history added. (Video ID: ${u}, last_playback_position: ${this.player.video.currentTime})`)}},O.WATCHED_HISTORY_THRESHOLD_SECONDS*1e3)}}setupFullscreenHandler(){H(this.player!==null);const e=I(),s=document.body;this.player.fullScreen.isFullScreen=o=>!!(document.fullscreenElement||document.webkitFullscreenElement),this.player.fullScreen.request=o=>{if(H(this.player!==null),this.player.fullScreen.isFullScreen()){this.player.fullScreen.cancel();return}if(s.requestFullscreen=s.requestFullscreen||s.webkitRequestFullscreen,s.requestFullscreen)s.requestFullscreen();else{this.player.notice("iPhone Safari は動画のフルスクリーン表示に対応していません。",void 0,void 0,"#FF6F6A");return}screen.orientation&&screen.orientation.lock("landscape").catch(()=>{})},this.player.fullScreen.cancel=o=>{document.exitFullscreen=document.exitFullscreen||document.webkitExitFullscreen,document.exitFullscreen&&document.exitFullscreen(),screen.orientation&&screen.orientation.unlock()};const i=()=>{H(this.player!==null),e.is_fullscreen=this.player.fullScreen.isFullScreen()===!0};s.onfullscreenchange!==void 0?s.onfullscreenchange=i:s.onwebkitfullscreenchange!==void 0&&(s.onwebkitfullscreenchange=i)}setupSettingPanelHandler(){H(this.player!==null);const e=I(),s=this.player.setting.hide,i=this.player.setting.show;this.player.setting.hide=()=>{this.player!==null&&(s.call(this.player.setting),e.is_player_setting_panel_open=!1)},this.player.setting.show=()=>{this.player!==null&&(i.call(this.player.setting),e.is_player_setting_panel_open=!0)},this.player.template.audio.insertAdjacentHTML("afterend",`
            <div class="dplayer-setting-item dplayer-setting-mobile-profile">
                <span class="dplayer-label">モバイル回線向け画質</span>
                <div class="dplayer-toggle">
                    <input class="dplayer-mobile-profile-setting-input" type="checkbox" name="dplayer-toggle-mobile-profile">
                    <label for="dplayer-toggle-mobile-profile" style="--theme-color:#E64F97"></label>
                </div>
            </div>
        `);const o=this.player.container.querySelector(".dplayer-mobile-profile-setting-input");o.checked=this.quality_profile_type==="Cellular",this.player.container.querySelector(".dplayer-setting-mobile-profile").addEventListener("click",()=>{o.checked=!o.checked,o.checked?(this.quality_profile_type="Cellular",e.event_emitter.emit("PlayerRestartRequired",{message:"モバイル回線向けの画質プロファイルに切り替えました。",message_delay_seconds:this.quality_profile.tv_low_latency_mode||this.playback_mode==="Video"?2:4.5,is_error_message:!1})):(this.quality_profile_type="Wi-Fi",e.event_emitter.emit("PlayerRestartRequired",{message:"Wi-Fi 回線向けの画質プロファイルに切り替えました。",message_delay_seconds:this.quality_profile.tv_low_latency_mode||this.playback_mode==="Video"?2:4.5,is_error_message:!1}))}),this.player.template.settingOriginPanel.insertAdjacentHTML("beforeend",`
            <div class="dplayer-setting-item dplayer-setting-lshaped-screen-crop">
                <span class="dplayer-label">Ｌ字画面のクロップ</span>
                <div class="dplayer-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 32 32">
                        <path d="M22 16l-10.105-10.6-1.895 1.987 8.211 8.613-8.211 8.612 1.895 1.988 8.211-8.613z"></path>
                    </svg>
                </div>
            </div>
        `),this.player.template.settingOriginPanel.querySelector(".dplayer-setting-lshaped-screen-crop").addEventListener("click",()=>{H(this.player!==null),this.player.setting.hide(),e.lshaped_screen_crop_settings_modal=!0}),y.isTouchDevice()===!1&&(this.player.template.settingOriginPanel.insertAdjacentHTML("beforeend",`
                <div class="dplayer-setting-item dplayer-setting-keyboard-shortcut">
                    <span class="dplayer-label">キーボードショートカット</span>
                    <div class="dplayer-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 32 32">
                            <path d="M22 16l-10.105-10.6-1.895 1.987 8.211 8.613-8.211 8.612 1.895 1.988 8.211-8.613z"></path>
                        </svg>
                    </div>
                </div>
            `),this.player.template.settingOriginPanel.querySelector(".dplayer-setting-keyboard-shortcut").addEventListener("click",()=>{H(this.player!==null),this.player.setting.hide(),e.shortcut_key_modal=!0}))}setupLShapedScreenCropHandler(){H(this.player!==null);const e=D();let s=this.player.video;this.player.on("quality_end",()=>{!this.player||!this.player.video||(s=this.player.video,i())});const i=()=>{if(e.settings.lshaped_screen_crop_enabled===!1){s.style.position="",s.style.transform="",s.style.transformOrigin="";return}const o=e.settings.lshaped_screen_crop_zoom_level,d=e.settings.lshaped_screen_crop_x_position,l=e.settings.lshaped_screen_crop_y_position,f=e.settings.lshaped_screen_crop_zoom_origin;if(o===100&&d===0&&l===0)s.style.position="",s.style.transform="",s.style.transformOrigin="";else{switch(s.style.position="relative",s.style.transform="",f){case"TopRight":{s.style.transformOrigin="right top",s.style.transform+=`translateX(${(o-100)*(d/100)}%) `,s.style.transform+=`translateY(-${(o-100)*(l/100)}%) `;break}case"BottomRight":{s.style.transformOrigin="right bottom",s.style.transform+=`translateX(${(o-100)*(d/100)}%) `,s.style.transform+=`translateY(${(o-100)*(l/100)}%) `;break}case"TopLeft":{s.style.transformOrigin="left top",s.style.transform+=`translateX(-${(o-100)*(d/100)}%) `,s.style.transform+=`translateY(-${(o-100)*(l/100)}%) `;break}case"BottomLeft":{s.style.transformOrigin="left bottom",s.style.transform+=`translateX(-${(o-100)*(d/100)}%) `,s.style.transform+=`translateY(${(o-100)*(l/100)}%) `;break}}s.style.transform+=`scale(${o/100})`}};i(),this.lshaped_screen_crop_watchers=[Y(()=>e.settings.lshaped_screen_crop_enabled,i,{immediate:!0}),Y(()=>e.settings.lshaped_screen_crop_zoom_level,i,{immediate:!0}),Y(()=>e.settings.lshaped_screen_crop_x_position,i,{immediate:!0}),Y(()=>e.settings.lshaped_screen_crop_y_position,i,{immediate:!0}),Y(()=>e.settings.lshaped_screen_crop_zoom_origin,i,{immediate:!0})]}setupPlayerContainerResizeHandler(){const e=document.querySelector(".watch-player"),s=()=>{if(this.player===null)return;const i=this.player.danmaku.container,o=i.clientWidth,d=i.clientWidth*(9/16);if(e===null||e.clientHeight===null)return;const l=(e.clientHeight-d)/2,f=y.isSmartphoneVertical()?0:y.isSmartphoneHorizontal()?50:66;if(l<f){const v=(f-l)*2,m=o,u=d-v,r=(h,C)=>C===0?h:r(C,h%C),w=r(m,u),n=`${m/w} / ${u/w}`;i.style.transition="none",i.style.setProperty("--comment-area-aspect-ratio",n),i.style.setProperty("--comment-area-vertical-margin",`${v}px`),window.setTimeout(()=>i.style.transition="",.2*1e3)}else i.style.removeProperty("--comment-area-aspect-ratio"),i.style.removeProperty("--comment-area-vertical-margin")};s(),this.player_container_resize_observer=new ResizeObserver(s),this.player_container_resize_observer.observe(e)}setControlDisplayTimer(e=null,s=!1,i=3){const o=I();if(y.isTouchDevice()===!0&&e!==null&&e.type==="mousemove"||y.isTouchDevice()===!1&&e!==null&&(e.type==="touchmove"||e.type==="click"))return;window.clearTimeout(this.player_control_ui_hide_timer_id);const d=()=>{if(this.player!==null){if(this.player.template.controller.classList.contains("dplayer-controller-comment")){this.player_control_ui_hide_timer_id=window.setTimeout(d,i*1e3);return}o.is_control_display=!1,this.player.controller.hide(),this.player.setting.hide()}};this.player!==null&&(y.isTouchDevice()===!0&&s===!0?this.player.controller.isShow()?(o.is_control_display=!0,this.player.controller.show(),this.player_control_ui_hide_timer_id=window.setTimeout(d,i*1e3)):(o.is_control_display=!1,this.player.controller.hide(),this.player.setting.hide()):(o.is_control_display=!0,this.player.controller.show(),this.player_control_ui_hide_timer_id=window.setTimeout(d,i*1e3)))}async destroy(){const e=D(),s=I();if(this.destroyed!==!0&&this.destroying!==!0){if(this.destroying=!0,this.playback_mode==="Video"&&this.player&&this.player.video){const i=e.settings.watched_history.findIndex(o=>o.video_id===s.recorded_program.id);if(i!==-1){const o=this.player.video.currentTime-10;e.settings.watched_history[i].last_playback_position=o,e.settings.watched_history[i].updated_at=y.time(),console.log(`\x1B[31m[PlayerController] Last playback position updated. (Video ID: ${s.recorded_program.id}, last_playback_position: ${o})`)}}if(console.log("\x1B[31m[PlayerController] Destroying..."),await Promise.all(this.player_managers.map(async i=>i.destroy())),this.player_managers=[],this.screen_wake_lock!==null&&(this.screen_wake_lock.release(),this.screen_wake_lock=null,console.log("\x1B[31m[PlayerController] Screen Wake Lock API: Screen Wake Lock released.")),s.is_background_display=!1,s.is_loading=!0,s.live_comment_init_failed_message=null,s.video_comment_init_failed_message=null,this.player!==null){const o=this.player.user.get("volume")/10;for(let d=0;d<10;d++)await y.sleep(.2/10),this.player&&this.player.video&&(this.player.video.volume=Math.max(y.mathFloor(this.player.video.volume-o,3),0));this.player.video.volume=0}if(this.live_force_seek_interval_timer_cancel!==null&&(this.live_force_seek_interval_timer_cancel(),this.live_force_seek_interval_timer_cancel=null),this.video_keep_alive_interval_timer_cancel!==null&&(this.video_keep_alive_interval_timer_cancel(),this.video_keep_alive_interval_timer_cancel=null),window.clearTimeout(this.watched_history_threshold_timer_id),window.clearTimeout(this.player_control_ui_hide_timer_id),this.player_container_resize_observer!==null&&(this.player_container_resize_observer.disconnect(),this.player_container_resize_observer=null),this.lshaped_screen_crop_watchers.length>0&&(this.lshaped_screen_crop_watchers.forEach(i=>i()),this.lshaped_screen_crop_watchers=[]),this.player!==null){if(this.player.events.events.error&&(this.player.events.events.error=[]),this.player.plugins.mpegts)try{this.player.plugins.mpegts.unload(),this.player.plugins.mpegts.detachMediaElement(),this.player.plugins.mpegts.destroy()}catch{}this.player.danmaku.clear();try{this.player.destroy(!0)}catch{}this.player=null}this.destroying=!1,this.destroyed=!0,s.is_player_initialized=!1,console.log("\x1B[31m[PlayerController] Destroyed.")}}};T(O,"LIVE_PLAYBACK_BUFFER_SECONDS_LOW_LATENCY",.9),T(O,"LIVE_PLAYBACK_BUFFER_SECONDS",4),T(O,"WATCHED_HISTORY_MAX_COUNT",50),T(O,"WATCHED_HISTORY_THRESHOLD_SECONDS",30),T(O,"WATCHED_HISTORY_UPDATE_INTERVAL",10);let we=O;export{we as P,uo as W};

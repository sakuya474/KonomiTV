var Z=Object.defineProperty;var q=(p,t,a)=>t in p?Z(p,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):p[t]=a;var y=(p,t,a)=>q(p,typeof t!="symbol"?t+"":t,a);import{w as E,a as I,u as x,t as V}from"./symbol-BZj_adzX.js";import{C as z}from"./Captures-BDGhK9r3.js";import{u as Y,I as j,b as P}from"./ChannelsStore-Bu7sgVAg.js";import{aq as C,u as D,U as v,cW as U}from"./index-C8qqk6Xt.js";function k(p,t,a,e){function c(n){return n instanceof a?n:new a(function(i){i(n)})}return new(a||(a=Promise))(function(n,i){function o(s){try{r(e.next(s))}catch(u){i(u)}}function d(s){try{r(e.throw(s))}catch(u){i(u)}}function r(s){s.done?n(s.value):c(s.value).then(o,d)}r((e=e.apply(p,[])).next())})}function O(p){return k(this,void 0,void 0,function*(){return new Promise(function(t,a){const e=document.createElement("img");e.crossOrigin="anonymous",e.src=p,e.onload=function(c){const n=c.target;t(n)},e.onabort=a,e.onerror=a})})}function W(p){return k(this,void 0,void 0,function*(){return new Promise(function(t,a){const e=document.createElement("canvas"),c=e.getContext("2d");if(c){const{width:n,height:i}=p;e.width=n,e.height=i,c.drawImage(p,0,0,n,i),e.toBlob(function(o){o?t(o):a("Cannot get blob from image element")},"image/png",1)}})})}function $(p){return k(this,void 0,void 0,function*(){const t=URL.createObjectURL(p),a=yield O(t);return yield W(a)})}function N(p){return k(this,void 0,void 0,function*(){const t={[p.type]:p},a=new ClipboardItem(t);yield navigator.clipboard.write([a])})}const T=E(new Worker(new URL("/assets/CaptureCompositor-7XzGzHUA.js",import.meta.url),{}));class R{constructor(t,a){y(this,"restart_required_when_quality_switched",!1);y(this,"player");y(this,"playback_mode");y(this,"capture_button",null);y(this,"comment_capture_button",null);this.player=t,this.playback_mode=a}async init(){const t=this.player.container.querySelector(".dplayer-capture-icon"),a=this.player.container.querySelector(".dplayer-comment-capture-icon");t!==null&&t.remove(),a!==null&&a.remove(),this.player.container.querySelector(".dplayer-player-restart-icon").insertAdjacentHTML("afterend",`
            <div class="dplayer-icon dplayer-capture-icon" aria-label="キャプチャ"
                data-balloon-nofocus="" data-balloon-pos="up">
                <span class="dplayer-icon-content">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M16 23c-3.309 0-6-2.691-6-6s2.691-6 6-6 6 2.691 6 6-2.691 6-6 6zM16 13c-2.206 0-4 1.794-4 4s1.794 4 4 4c2.206 0 4-1.794 4-4s-1.794-4-4-4zM27 28h-22c-1.654 0-3-1.346-3-3v-16c0-1.654 1.346-3 3-3h3c0.552 0 1 0.448 1 1s-0.448 1-1 1h-3c-0.551 0-1 0.449-1 1v16c0 0.552 0.449 1 1 1h22c0.552 0 1-0.448 1-1v-16c0-0.551-0.448-1-1-1h-11c-0.552 0-1-0.448-1-1s0.448-1 1-1h11c1.654 0 3 1.346 3 3v16c0 1.654-1.346 3-3 3zM24 10.5c0 0.828 0.672 1.5 1.5 1.5s1.5-0.672 1.5-1.5c0-0.828-0.672-1.5-1.5-1.5s-1.5 0.672-1.5 1.5zM15 4c0 0.552-0.448 1-1 1h-4c-0.552 0-1-0.448-1-1v0c0-0.552 0.448-1 1-1h4c0.552 0 1 0.448 1 1v0z"></path></svg>
                </span>
            </div>
        `),this.capture_button=this.player.container.querySelector(".dplayer-capture-icon"),this.capture_button.insertAdjacentHTML("afterend",`
            <div class="dplayer-icon dplayer-comment-capture-icon" aria-label="コメントを付けてキャプチャ"
                data-balloon-nofocus="" data-balloon-pos="up">
                <span class="dplayer-icon-content">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 37 32"><path d="M34.18 18.5682H24.4869C23.4829 18.5682 22.6693 19.3525 22.6693 20.32V27.314C22.6693 28.2815 23.4829 29.0658 24.4869 29.0658H26.3045V27.9118H29.916L26.1407 31.3811L26.8138 32L30.0067 29.0658H34.18C35.1835 29.0658 35.9976 28.2815 35.9976 27.314V20.32C35.9976 19.3521 35.1835 18.5682 34.18 18.5682ZM34.786 26.7441C34.786 27.3888 34.2436 27.9118 33.5744 27.9118H29.9813L29.9487 27.8817L29.916 27.9118H25.0925C24.4233 27.9118 23.8809 27.3888 23.8809 26.7441V20.9037C23.8809 20.2585 24.4233 19.7355 25.0925 19.7355H33.574C34.2432 19.7355 34.7855 19.6749 34.7855 20.3196V26.7437L34.786 26.7441ZM26.4773 22.9422C25.9521 22.9422 25.5253 23.3337 25.5253 23.8172C25.5253 24.3007 25.9516 24.6918 26.4773 24.6918C27.0033 24.6918 27.4297 24.3003 27.4297 23.8172C27.4297 23.3341 27.0033 22.9422 26.4773 22.9422ZM32.1892 22.9422C31.6631 22.9422 31.2372 23.3337 31.2372 23.8172C31.2372 24.3007 31.6631 24.6918 32.1892 24.6918C32.7152 24.6918 33.1412 24.3003 33.1412 23.8172C33.1412 23.3341 32.7152 22.9422 32.1892 22.9422ZM29.3337 22.9422C28.8076 22.9422 28.3817 23.3337 28.3817 23.8172C28.3817 24.3007 28.8076 24.6918 29.3337 24.6918C29.8589 24.6918 30.2856 24.3003 30.2856 23.8172C30.2856 23.3341 29.8593 22.9422 29.3337 22.9422Z"/><path fill-rule="evenodd" clip-rule="evenodd" d="M16 23C12.691 23 10 20.309 10 17C10 13.691 12.691 11 16 11C19.309 11 22 13.691 22 17C22 20.309 19.309 23 16 23ZM16 13C13.794 13 12 14.794 12 17C12 19.206 13.794 21 16 21C18.206 21 20 19.206 20 17C20 14.794 18.206 13 16 13ZM30 9V16.4888H28V9C28 8.449 27.552 8 27 8H16C15.448 8 15 7.552 15 7C15 6.448 15.448 6 16 6H27C28.654 6 30 7.346 30 9ZM20.5905 28V26H5C4.449 26 4 25.552 4 25V9C4 8.449 4.449 8 5 8H8C8.552 8 9 7.552 9 7C9 6.448 8.552 6 8 6H5C3.346 6 2 7.346 2 9V25C2 26.654 3.346 28 5 28H20.5905ZM24 10.5C24 11.328 24.672 12 25.5 12C26.328 12 27 11.328 27 10.5C27 9.672 26.328 9 25.5 9C24.672 9 24 9.672 24 10.5ZM15 4C15 4.552 14.552 5 14 5H10C9.448 5 9 4.552 9 4C9 3.448 9.448 3 10 3H14C14.552 3 15 3.448 15 4Z"/></svg>
                </span>
            </div>
        `),this.comment_capture_button=this.player.container.querySelector(".dplayer-comment-capture-icon"),this.capture_button.addEventListener("click",()=>this.captureAndSave(!1)),this.comment_capture_button.addEventListener("click",()=>this.captureAndSave(!0)),await T.loadFonts(),console.log("[CaptureManager] Initialized.")}addHighlight(t=!1){I(this.capture_button!==null&&this.comment_capture_button!==null),t?this.comment_capture_button.classList.add("dplayer-capturing"):this.capture_button.classList.add("dplayer-capturing")}removeHighlight(t=!1){I(this.capture_button!==null&&this.comment_capture_button!==null),t?this.comment_capture_button.classList.remove("dplayer-capturing"):this.capture_button.classList.remove("dplayer-capturing")}createCaptureCommentData(){const t={container_width:this.player.danmaku.container.offsetWidth,container_height:this.player.danmaku.container.offsetHeight,opacity:this.player.danmaku._opacity,comments:[]},a=".dplayer-danmaku-item:not(.dplayer-danmaku-item--demo)";for(const e of this.player.danmaku.container.querySelectorAll(a)){if(e.textContent===null)continue;const c=window.getComputedStyle(e);t.comments.push({top:e.getBoundingClientRect().top-this.player.danmaku.container.getBoundingClientRect().top,left:e.getBoundingClientRect().left-this.player.danmaku.container.getBoundingClientRect().left,color:c.color,font_size:parseFloat(c.fontSize.replaceAll("px","")),text:e.textContent.trim()})}return t.comments.length===0?null:t}createCaptureExifData(){var d,r,s,u,_,g;const t=Y(),a=x(),e=C().format(),c=this.player.plugins.aribb24Caption,i=c.isShowing===!0&&c.isPresent()?c.getTextContent():null;let o;return this.playback_mode==="Live"?o={captured_at:e,captured_playback_position:-1,network_id:t.channel.current.network_id,service_id:t.channel.current.service_id,event_id:((d=t.channel.current.program_present)==null?void 0:d.event_id)??-1,title:((r=t.channel.current.program_present)==null?void 0:r.title)??"放送休止",description:((s=t.channel.current.program_present)==null?void 0:s.description)??"",start_time:((u=t.channel.current.program_present)==null?void 0:u.start_time)??"2000-01-01T00:00:00+09:00",end_time:((_=t.channel.current.program_present)==null?void 0:_.end_time)??"2000-01-01T00:00:00+09:00",duration:((g=t.channel.current.program_present)==null?void 0:g.duration)??0,caption_text:i,is_caption_composited:!1,is_comment_composited:!1}:o={captured_at:e,captured_playback_position:-1,network_id:a.recorded_program.network_id??-1,service_id:a.recorded_program.service_id??-1,event_id:a.recorded_program.event_id??-1,title:a.recorded_program.title,description:a.recorded_program.description,start_time:a.recorded_program.start_time,end_time:a.recorded_program.end_time,duration:a.recorded_program.duration,caption_text:i,is_caption_composited:!1,is_comment_composited:!1},this.playback_mode==="Live"?o.captured_playback_position=C().diff(C(o.start_time),"second",!0):o.captured_playback_position=this.player.video.currentTime-a.recorded_program.recording_start_margin,o}async cropImageForLShapedScreen(t){const a=D(),e=new OffscreenCanvas(t.width,t.height),c=e.getContext("2d",{alpha:!1,desynchronized:!0,willReadFrequently:!1}),n=a.settings.lshaped_screen_crop_zoom_level/100,i=a.settings.lshaped_screen_crop_x_position/100,o=a.settings.lshaped_screen_crop_y_position/100,d=a.settings.lshaped_screen_crop_zoom_origin,r=e.width/n,s=e.height/n;let u=0,_=0;switch(d){case"TopRight":u=e.width-r-(e.width-r)*i,_=(e.height-s)*o;break;case"BottomRight":u=e.width-r-(e.width-r)*i,_=e.height-s-(e.height-s)*o;break;case"TopLeft":u=(e.width-r)*i,_=(e.height-s)*o;break;case"BottomLeft":u=(e.width-r)*i,_=e.height-s-(e.height-s)*o;break}return c.drawImage(t,u,_,r,s,0,0,e.width,e.height),await createImageBitmap(e)}async captureAndSave(t){const a=Y(),e=x(),c=D(),n=v.time();if(this.playback_mode==="Live"&&a.channel.current.is_radiochannel===!0){this.player.notice("ラジオチャンネルはキャプチャできません。",void 0,void 0,"#FF6F6A");return}if(this.player.video.videoWidth===0&&this.player.video.videoHeight===0){this.player.notice("読み込み中はキャプチャできません。",void 0,void 0,"#FF6F6A");return}if(t===!0&&this.player.danmaku.showing===!1){this.player.notice("コメントを付けてキャプチャするには、コメント表示をオンにしてください。",void 0,void 0,"#FF6F6A");return}this.addHighlight(t);const i=this.player.plugins.aribb24Caption,o=this.player.plugins.aribb24Superimpose??null,d=i.getRawCanvas(),r=(o==null?void 0:o.getRawCanvas())??null,s=i.isShowing===!0&&i.isPresent(),u=o&&o.isShowing===!0&&o.isPresent(),_=await Promise.all([createImageBitmap(this.player.video),s?createImageBitmap(d):null,u?createImageBitmap(r):null]);let g=_[0];c.settings.lshaped_screen_crop_enabled&&(g=await this.cropImageForLShapedScreen(g));const m=_[1],w=_[2],b=t?this.createCaptureCommentData():null,S=this.createCaptureExifData(),l=[g,m,w].filter(M=>M!==null);console.log("\x1B[36m[CaptureManager] Composite start:");const f=v.time(),h=await(await new T(V({mode:c.settings.capture_caption_mode,capture:g,caption:m,superimpose:w,capture_comment_data:b,capture_exif_data:S},l))).composite();console.log("\x1B[36m[CaptureManager] Composite end:",v.mathFloor(v.time()-f,3),"sec");const B=R.generateCaptureFilename(),H=`${B}.jpg`,L=`${B}_caption.jpg`;h.capture_normal!==null&&(e.event_emitter.emit("CaptureCompleted",{capture:h.capture_normal,filename:H}),["Browser","Both"].includes(c.settings.capture_save_mode)&&v.downloadBlobData(h.capture_normal,H),["UploadServer","Both"].includes(c.settings.capture_save_mode)&&z.uploadCapture(h.capture_normal,H)),h.capture_caption!==null&&(e.event_emitter.emit("CaptureCompleted",{capture:h.capture_caption,filename:H}),["Browser","Both"].includes(c.settings.capture_save_mode)&&v.downloadBlobData(h.capture_caption,L),["UploadServer","Both"].includes(c.settings.capture_save_mode)&&z.uploadCapture(h.capture_caption,L));const F=v.mathFloor(v.time()-n,3);if(F<.1?setTimeout(()=>this.removeHighlight(t),100):this.removeHighlight(t),console.log("\x1B[36m[CaptureManager] Total:",F,"sec"),c.settings.capture_copy_to_clipboard===!0){for(const M of[h.capture_normal,h.capture_caption])if(M!==null)try{await N(await $(M))}catch(A){this.player.notice("クリップボードへのキャプチャのコピーに失敗しました。",void 0,void 0,"#FF6F6A"),console.error(A)}}}async destroy(){console.log("[CaptureManager] Destroyed.")}static generateCaptureFilename(){var w,b,S;const t=Y(),a=x(),c=D().settings.capture_filename_pattern,n=C();let i,o;if(a.is_watching&&a.recorded_program.id!==-1){const l=a.recorded_program;i={name:((w=l.channel)==null?void 0:w.name)??"不明なチャンネル",service_id:((b=l.channel)==null?void 0:b.service_id)??0,remocon_id:((S=l.channel)==null?void 0:S.remocon_id)??0},o={event_id:l.event_id??-1,title:l.title,start_time:l.start_time,end_time:l.end_time,duration:l.duration}}else{const l=t.channel.current.id==="NID0-SID0"?structuredClone(j):t.channel.current,f=l.program_present??structuredClone(P);l.id==="NID0-SID0"?(i={name:"アフリカ中央テレビ",service_id:1024,remocon_id:9},o={event_id:65535,title:"[二][字]今日のニュース",start_time:"2024-04-01T12:00:00+09:00",end_time:"2024-04-01T12:15:00+09:00",duration:15*60*1e3}):(i={name:l.name,service_id:l.service_id,remocon_id:l.remocon_id},o={event_id:f.event_id,title:f.title,start_time:f.start_time,end_time:f.end_time,duration:f.duration})}const d=C(o.start_time),r=C(o.end_time),s=U.duration(r.diff(d)),u={"%date%":n.format("YYYYMMDD"),"%year%":n.format("YYYY"),"%year2%":n.format("YY"),"%month%":n.format("M"),"%month2%":n.format("MM"),"%day%":n.format("D"),"%day2%":n.format("DD"),"%time%":n.format("HHmmss"),"%hour%":n.format("H"),"%hour2%":n.format("HH"),"%minute%":n.format("m"),"%minute2%":n.format("mm"),"%second%":n.format("s"),"%second2%":n.format("ss"),"%day-of-week%":n.format("ddd"),"%start-date%":d.format("YYYYMMDD"),"%start-year%":d.format("YYYY"),"%start-year2%":d.format("YY"),"%start-month%":d.format("M"),"%start-month2%":d.format("MM"),"%start-day%":d.format("D"),"%start-day2%":d.format("DD"),"%start-time%":d.format("HHmmss"),"%start-hour%":d.format("H"),"%start-hour2%":d.format("HH"),"%start-minute%":d.format("m"),"%start-minute2%":d.format("mm"),"%start-second%":d.format("s"),"%start-second2%":d.format("ss"),"%start-day-of-week%":d.format("ddd"),"%end-date%":r.format("YYYYMMDD"),"%end-year%":r.format("YYYY"),"%end-year2%":r.format("YY"),"%end-month%":r.format("M"),"%end-month2%":r.format("MM"),"%end-day%":r.format("D"),"%end-day2%":r.format("DD"),"%end-time%":r.format("HHmmss"),"%end-hour%":r.format("H"),"%end-hour2%":r.format("HH"),"%end-minute%":r.format("m"),"%end-minute2%":r.format("mm"),"%end-second%":r.format("s"),"%end-second2%":r.format("ss"),"%end-day-of-week%":r.format("ddd"),"%event-duration-hour%":s.hours().toString(),"%event-duration-hour2%":s.hours().toString().padStart(2,"0"),"%event-duration-min%":s.minutes().toString(),"%event-duration-min2%":s.minutes().toString().padStart(2,"0"),"%event-duration-sec%":s.seconds().toString(),"%event-duration-sec2%":s.seconds().toString().padStart(2,"0"),"%channel-name%":i.name,"%channel-no%":i.remocon_id.toString(),"%channel-no2%":i.remocon_id.toString().padStart(2,"0"),"%channel-no3%":i.remocon_id.toString().padStart(3,"0"),"%event-name%":o.title,"%event-id%":o.event_id.toString(),"%service-name%":i.name,"%service-id%":i.service_id.toString()},_=Object.keys(u).sort((l,f)=>f.length-l.length),g=new RegExp(_.map(l=>l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).join("|"),"g");let m=c.replace(g,l=>u[l]);return m=m.replace(/\\/g,"￥"),m=m.replace(/\//g,"／"),m=m.replace(/:/g,"："),m=m.replace(/\*/g,"＊"),m=m.replace(/\?/g,"？"),m=m.replace(/"/g,"”"),m=m.replace(/</g,"＜"),m=m.replace(/>/g,"＞"),m=m.replace(/\|/g,"｜"),m}}export{R as C};

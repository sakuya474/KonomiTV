var de=Object.defineProperty;var ye=(r,t,e)=>t in r?de(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var m=(r,t,e)=>ye(r,typeof t!="symbol"?t+"":t,e);import{d as R,m as U,aq as Z,U as p,P as G,_ as H,c as g,w as I,e as C,k as V,h as pe,a as w,r as P,t as B,n as $,o as h,R as A,b as v,F as ee,g as te,u as F,f as ue,ai as f,aj as he,j as _e,A as re,am as ie}from"./index-26jul5yA.js";import{W as me,K as ge,H as ae,D as fe,m as z,L as be,a as ve,b as le,c as se,M as oe}from"./MediaSessionManager-spRS7xOJ.js";import{u as x}from"./ChannelsStore-Be00E35Y.js";import{u as S,a as D}from"./symbol-Dlk6Hjaz.js";import{u as K}from"./BDLibraryStore-Cgay0P0o.js";import{V as ne,_ as ke}from"./VSpacer-D77fs5_2.js";import{B as Y}from"./BDLibrary-Bb45fGJY.js";import{u as N}from"./BDLibraryHistoryStore-wFv8Ll5B.js";import{P as M}from"./PlayerUtils-D6ABkBVB.js";import"./VCard-Cvs9lGZ1.js";import"./VRow-DRl3VpwY.js";import"./VDialog-xXriaxfi.js";import"./VOverlay-CQXLzbkN.js";import"./forwardRefs-DboJVnh3.js";import"./dialog-transition-BLjzztn0.js";import"./Videos-DZc2zBNv.js";const we=R({name:"BDLibraryWatch-Header",props:{playback_mode:{type:String,required:!0},title_override:{type:String,required:!1,default:void 0},show_time:{type:Boolean,required:!1,default:!0},show_now:{type:Boolean,required:!1,default:!0}},data(){return{Utils:Object.freeze(p),ProgramUtils:Object.freeze(G),time:Z().format(p.isSmartphoneHorizontal()?"HH:mm:ss":"YYYY/MM/DD HH:mm:ss")}},computed:{...U(x,S,K),title_html(){return this.title_override&&this.title_override.length>0?this.title_override:G.decorateProgramInfo(this.playback_mode==="Live"?this.channelsStore.channel.current.program_present:this.playerStore.recorded_program,"title")},bd_title_html(){var r;return this.title_override&&this.title_override.length>0?this.title_override:((r=this.bdLibraryStore.bdItem)==null?void 0:r.title)||"BD視聴"}},methods:{updateTimeCore(){const r=Z();this.time=r.format(p.isSmartphoneHorizontal()?"HH:mm:ss":"YYYY/MM/DD HH:mm:ss");const t=r.millisecond();return t>800?500:1e3-t},uptimeTime(){setTimeout(()=>{this.uptimeTime()},this.updateTimeCore())}},created(){setTimeout(()=>{this.uptimeTime()},1e3)},beforeUnmount(){this.uptimeTime=()=>{}}}),Se=["src"],Ce=["innerHTML"],Pe=["innerHTML"],Le={key:3,class:"watch-header__program-time"},De={key:5,class:"watch-header__now"};function Te(r,t,e,s,a,i){const l=P("Icon"),n=P("router-link");return h(),g("header",{class:$(["watch-header",{"watch-header--video":r.playback_mode==="Video"}])},[I((h(),V(n,{class:"watch-header__back-icon",to:r.playback_mode==="Live"?"/tv/":"/videos/"},{default:pe(()=>[w(l,{icon:"fluent:chevron-left-12-filled",width:"21px"})]),_:1},8,["to"])),[[A]]),r.playback_mode==="Live"?(h(),g("img",{key:0,class:"watch-header__broadcaster",src:`${r.Utils.api_base_url}/channels/${r.channelsStore.channel.current.id}/logo`},null,8,Se)):C("",!0),r.playback_mode==="Live"?(h(),g("span",{key:1,class:"watch-header__program-title",innerHTML:r.title_html},null,8,Ce)):C("",!0),r.playback_mode==="Video"?(h(),g("span",{key:2,class:"watch-header__program-title",innerHTML:r.bd_title_html},null,8,Pe)):C("",!0),r.show_time&&r.playback_mode==="Live"?(h(),g("span",Le,B(r.ProgramUtils.getProgramTime(r.channelsStore.channel.current.program_present,!0)),1)):C("",!0),r.playback_mode==="Live"?(h(),V(ne,{key:4})):C("",!0),r.show_now&&r.playback_mode==="Live"?(h(),g("span",De,B(r.time),1)):C("",!0)],2)}const Be=H(we,[["render",Te],["__scopeId","data-v-812a0704"]]),$e=R({name:"Panel-BDLibraryPanelContent",props:{title:{type:String,required:!1,default:""},chapters:{type:Array,required:!0}},emits:["seek"],setup(r,{emit:t}){function e(i,l,n){let o=i.StartTime||i.startTime;if(o||(o=a(i)),i&&o!=null){const y=Number(o);if(!isNaN(y)){let d="";if(i.Title&&Array.isArray(i.Chapters))d=`${i.Title}まで移動しました`;else if(l&&n!==void 0){const _=l.Title||r.title||"タイトル",u=String(n+1).padStart(2,"0");d=`${_}のチャプター${u}まで移動しました`}else d="チャプターまで移動しました";t("seek",y,d)}}}function s(i){if(i==null||i==="")return"--:--";const l=Number(i);if(isNaN(l))return"--:--";const n=Math.floor(l/3600),o=Math.floor(l%3600/60),y=Math.floor(l%60);return n>0?`${n}:${o.toString().padStart(2,"0")}:${y.toString().padStart(2,"0")}`:`${o}:${y.toString().padStart(2,"0")}`}function a(i){if(i.StartTime||i.startTime)return i.StartTime||i.startTime;if(Array.isArray(i.Chapters)&&i.Chapters.length>0){const l=i.Chapters[0];if(l&&(l.StartTime||l.startTime))return l.StartTime||l.startTime}return 0}return{handleChapterClick:e,formatTime:s,getTitleGroupTime:a}}}),qe={class:"bd-panel"},Ie={key:0,class:"bd-panel__title"},Ae={class:"bd-panel__chapters"},Fe=["onClick"],Re={class:"chapter-title__text"},He={class:"chapter-title__time"},Ee={key:0,class:"chapter-list"},We=["onClick"],Me={class:"chapter-item__number"},Ne={key:0,class:"chapter-item__title"},Ve={key:1,class:"chapter-item__time"},xe={key:1,class:"no-chapters"};function Ue(r,t,e,s,a,i){return h(),g("div",qe,[r.title?(h(),g("div",Ie,B(r.title),1)):C("",!0),v("div",Ae,[Array.isArray(r.chapters)&&r.chapters.length>0?(h(!0),g(ee,{key:0},te(r.chapters,l=>(h(),g("div",{key:l.Title,class:"chapter-title-group"},[v("div",{class:"chapter-title",onClick:n=>r.handleChapterClick(l)},[v("span",Re,B(l.Title),1),v("span",He,B(r.formatTime(r.getTitleGroupTime(l))),1)],8,Fe),Array.isArray(l.Chapters)&&l.Chapters.length>0?(h(),g("div",Ee,[(h(!0),g(ee,null,te(l.Chapters,(n,o)=>(h(),g("div",{key:n.ChapterIndex||n.Title||o,class:"chapter-item",onClick:y=>r.handleChapterClick(n,l,o)},[v("span",Me,"Chapter "+B(String(o+1).padStart(2,"0")),1),n.Title&&n.Title!==`Chapter ${String(o+1).padStart(2,"0")}`?(h(),g("span",Ne,B(n.Title),1)):C("",!0),n.StartTime?(h(),g("span",Ve,B(r.formatTime(n.StartTime)),1)):C("",!0)],8,We))),128))])):C("",!0)]))),128)):(h(),g("div",xe," チャプター情報がありません "))])])}const Oe=H($e,[["render",Ue],["__scopeId","data-v-90028e16"]]),ze=R({name:"BDLibraryWatch-Panel",components:{BDLibraryPanelContent:Oe},props:{playback_mode:{type:String,required:!0}},data(){return{Utils:Object.freeze(p)}},computed:{...U(K,S),groupedChapters(){var e,s;const r=this.bdLibraryStore;let t=[];if((e=r.bdItem)!=null&&e.chapters&&Array.isArray(r.bdItem.chapters)&&r.bdItem.chapters.length>0)t=r.bdItem.chapters;else if((s=r.bdItem)!=null&&s.titles&&Array.isArray(r.bdItem.titles)&&r.bdItem.titles.length>0){const a=r.bdItem.titles[0];a&&Array.isArray(a.chapters)&&(t=a.chapters)}return t}},methods:{handleClosePanel(){this.playerStore.is_panel_display=!1},seekToChapter(r,t){var s;const e=(s=this.$parent)==null?void 0:s.$parent;if(e&&typeof e.getBDPlayerController=="function"){const a=e.getBDPlayerController();a&&typeof a.seek=="function"&&a.seek(r,t)}}}}),Ye={class:"watch-panel__header"},je={class:"watch-panel__content-container"},Ke={class:"watch-panel__navigation"},Qe={class:"panel-navigation-button panel-navigation-button--active"};function Xe(r,t,e,s,a,i){var o;const l=P("Icon"),n=P("BDLibraryPanelContent");return h(),g("div",{class:"watch-panel",onMousemove:t[2]||(t[2]=y=>r.playerStore.event_emitter.emit("SetControlDisplayTimer",{event:y}))},[v("div",Ye,[I((h(),g("div",{class:"panel-close-button",onClick:t[0]||(t[0]=(...y)=>r.handleClosePanel&&r.handleClosePanel(...y))},[w(l,{class:"panel-close-button__icon",icon:"akar-icons:chevron-right",width:"25px"}),t[3]||(t[3]=v("span",{class:"panel-close-button__text"},"閉じる",-1))])),[[A]]),w(ne)]),v("div",je,[w(n,{class:"watch-panel__content watch-panel__content--active",title:((o=r.bdLibraryStore.bdItem)==null?void 0:o.title)??"",chapters:r.groupedChapters,onSeek:t[1]||(t[1]=(y,d)=>r.seekToChapter(y,d))},null,8,["title","chapters"])]),v("div",Ke,[I((h(),g("div",Qe,[w(l,{class:"panel-navigation-button__icon",icon:"fa-solid:list",width:"33px"}),t[4]||(t[4]=v("span",{class:"panel-navigation-button__text"},"チャプター",-1))])),[[A]])])],32)}const Je=H(ze,[["render",Xe],["__scopeId","data-v-e495ed15"]]),Ze={class:"watch-player__background-wrapper"},Ge=["disabled"],et=R({__name:"BDLibraryWatchPlayer",props:{playback_mode:{type:String,required:!0}},setup(r){const t=x(),e=S(),s=F(),a=()=>{const i=document.querySelector(".dplayer-mask");i&&i.click()};return(i,l)=>{const n=P("Icon"),o=_e("ftooltip");return h(),g("div",{class:$(["watch-player",{"watch-player--loading":f(e).is_loading,"watch-player--virtual-keyboard-display":f(e).is_virtual_keyboard_display&&f(p).hasActiveElementClass("dplayer-comment-input"),"watch-player--video":r.playback_mode==="Video","watch-player--pure-black":f(s).settings.use_pure_black_player_background}])},[v("div",Ze,[v("div",{class:$(["watch-player__background",{"watch-player__background--display":f(e).is_background_display,"watch-player__background--background-hide":f(s).settings.show_player_background_image===!1}]),style:ue({backgroundImage:`url(${f(e).background_url})`})},[...l[7]||(l[7]=[v("img",{class:"watch-player__background-logo",src:ke},null,-1)])],6)]),w(he,{indeterminate:"",size:"60",width:"6",class:$(["watch-player__buffering",{"watch-player__buffering--display":f(e).is_video_buffering}])},null,8,["class"]),l[8]||(l[8]=v("div",{class:"watch-player__dplayer"},null,-1)),v("div",{class:$(["watch-player__dplayer-setting-cover",{"watch-player__dplayer-setting-cover--display":f(e).is_player_setting_panel_open}]),onClick:a},null,2),v("div",{class:"watch-player__button",onMousemove:l[4]||(l[4]=y=>f(e).event_emitter.emit("SetControlDisplayTimer",{event:y})),onTouchmove:l[5]||(l[5]=y=>f(e).event_emitter.emit("SetControlDisplayTimer",{event:y})),onClick:l[6]||(l[6]=y=>f(e).event_emitter.emit("SetControlDisplayTimer",{event:y}))},[r.playback_mode==="Live"?I((h(),g("div",{key:0,class:"switch-button switch-button-up",onClick:l[0]||(l[0]=y=>{f(e).is_zapping=!0,i.$router.push({path:`/tv/watch/${f(t).channel.previous.display_channel_id}`})})},[w(n,{class:"switch-button-icon",icon:"fluent:ios-arrow-left-24-filled",width:"32px",style:{transform:"rotate(90deg)"}})])),[[A],[o,"前のチャンネル",void 0,{top:!0}]]):C("",!0),I((h(),g("div",{class:$(["switch-button switch-button-panel",{"switch-button-panel--open":f(e).is_panel_display}]),onClick:l[1]||(l[1]=y=>f(e).is_panel_display=!f(e).is_panel_display)},[w(n,{class:"switch-button-icon",icon:"fluent:navigation-16-filled",width:"32px"})],2)),[[A]]),r.playback_mode==="Live"?I((h(),g("div",{key:1,class:"switch-button switch-button-down",onClick:l[2]||(l[2]=y=>{f(e).is_zapping=!0,i.$router.push({path:`/tv/watch/${f(t).channel.next.display_channel_id}`})})},[w(n,{class:"switch-button-icon",icon:"fluent:ios-arrow-right-24-filled",width:"33px",style:{transform:"rotate(90deg)"}})])),[[A],[o,"次のチャンネル",void 0,{bottom:!0}]]):C("",!0),I((h(),g("div",{class:$(["switch-button switch-button-subtitle",{active:f(e).is_subtitle_on}]),disabled:f(e).subtitle_tracks.length===0,onClick:l[3]||(l[3]=y=>f(e).toggleSubtitle())},[w(n,{class:"switch-button-icon",icon:"mdi:closed-caption",width:"28px"})],10,Ge)),[[A],[o,"字幕ON/OFF",void 0,{bottom:!0}]])],32)],2)}}}),tt=H(et,[["__scopeId","data-v-59d2ec7d"]]),rt=R({name:"BDLibraryWatchMain",components:{KeyboardShortcutList:ge,BDLibraryWatchHeader:Be,WatchNavigation:me,BDLibraryWatchPanel:Je,BDLibraryWatchPlayer:tt},props:{playback_mode:{type:String,required:!0}},data(){return{Utils:Object.freeze(p)}},computed:{...U(S,F)},watch:{"playerStore.is_panel_display":{handler(){this.settingsStore.settings.showed_panel_last_time=this.playerStore.is_panel_display}}},created(){"virtualKeyboard"in navigator&&(navigator.virtualKeyboard.overlaysContent=!0,navigator.virtualKeyboard.ongeometrychange=r=>{r.target.boundingRect.width===0&&r.target.boundingRect.height===0?this.playerStore.is_virtual_keyboard_display=!1:this.playerStore.is_virtual_keyboard_display=!0}),this.playerStore.startWatching()},beforeUnmount(){this.playerStore.stopWatching(),"virtualKeyboard"in navigator&&(navigator.virtualKeyboard.overlaysContent=!1)}}),it={class:"route-container"};function at(r,t,e,s,a,i){const l=P("WatchNavigation"),n=P("BDLibraryWatchHeader"),o=P("BDLibraryWatchPlayer"),y=P("BDLibraryWatchPanel"),d=P("KeyboardShortcutList");return h(),g("div",it,[v("main",{class:$(["watch-container",{"watch-container--control-display":r.playerStore.is_control_display,"watch-container--panel-display":r.Utils.isSmartphoneVertical()||r.Utils.isTabletVertical()?!0:r.playerStore.is_panel_display,"watch-container--fullscreen":r.playerStore.is_fullscreen,"watch-container--document-pip":r.playerStore.is_document_pip,"watch-container--video":r.playback_mode==="Video","watch-container--bdlibrary":!0}])},[w(l),v("div",{class:"watch-content",onMousemove:t[0]||(t[0]=_=>r.playerStore.event_emitter.emit("SetControlDisplayTimer",{event:_,is_player_region_event:!0})),onTouchmove:t[1]||(t[1]=_=>r.playerStore.event_emitter.emit("SetControlDisplayTimer",{event:_,is_player_region_event:!0})),onClick:t[2]||(t[2]=_=>r.playerStore.event_emitter.emit("SetControlDisplayTimer",{event:_,is_player_region_event:!0}))},[w(n,{playback_mode:r.playback_mode},null,8,["playback_mode"]),w(o,{playback_mode:r.playback_mode},null,8,["playback_mode"])],32),w(y,{playback_mode:r.playback_mode},null,8,["playback_mode"])],2),w(d,{playback_mode:r.playback_mode},null,8,["playback_mode"])])}const lt=H(rt,[["render",at],["__scopeId","data-v-10a40d12"]]),T=class T{constructor(t,e=[],s=0,a=null){m(this,"player",null);m(this,"player_managers",[]);m(this,"playback_mode");m(this,"quality_profile_type");m(this,"live_force_seek_interval_timer_cancel",null);m(this,"video_keep_alive_interval_timer_cancel",null);m(this,"player_container_resize_observer",null);m(this,"player_control_ui_hide_timer_id",0);m(this,"watched_history_threshold_timer_id",0);m(this,"screen_wake_lock",null);m(this,"romsounds_context",new AudioContext);m(this,"romsounds_buffers",[]);m(this,"lshaped_screen_crop_watchers",[]);m(this,"destroying",!1);m(this,"destroyed",!1);m(this,"m3u8Path");m(this,"qualities");m(this,"defaultQuality");m(this,"bdItem");this.m3u8Path=t,this.qualities=e,this.defaultQuality=s,this.bdItem=a,this.playback_mode="Video",M.getNetworkCircuitType()==="Cellular"?this.quality_profile_type="Cellular":this.quality_profile_type="Wi-Fi",(async()=>{for(let l=1;l<=14;l++){const n=`/assets/romsounds/${l.toString().padStart(2,"0")}.wav`,o=await re.get(n,{baseURL:"",responseType:"arraybuffer"});o.type==="success"&&this.romsounds_buffers.push(await this.romsounds_context.decodeAudioData(o.data))}})()}getComputedM3u8Path(t){let e=this.m3u8Path;return t&&t!=="original"&&(e=e.replace("/original/",`/${t}/`)),e}get quality_profile(){const t=F();return this.quality_profile_type==="Cellular"?{tv_streaming_quality:t.settings.tv_streaming_quality_cellular,tv_data_saver_mode:t.settings.tv_data_saver_mode_cellular,tv_low_latency_mode:t.settings.tv_low_latency_mode_cellular,video_streaming_quality:t.settings.video_streaming_quality_cellular,video_data_saver_mode:t.settings.video_data_saver_mode_cellular}:{tv_streaming_quality:t.settings.tv_streaming_quality,tv_data_saver_mode:t.settings.tv_data_saver_mode,tv_low_latency_mode:t.settings.tv_low_latency_mode,video_streaming_quality:t.settings.video_streaming_quality,video_data_saver_mode:t.settings.video_data_saver_mode}}get live_playback_buffer_seconds(){let t=this.quality_profile.tv_low_latency_mode?T.LIVE_PLAYBACK_BUFFER_SECONDS_LOW_LATENCY:T.LIVE_PLAYBACK_BUFFER_SECONDS;return p.isSafari()===!0&&(t+=.3),t}async init(t,e=[],s=[]){x();const a=S();F(),console.log("\x1B[31m[PlayerController] Initializing..."),this.destroyed=!1,a.is_player_initialized=!0,window.Hls=ae;let i=0;const n=N().history_items.find(c=>c.bd_id===this.bdItem.id);n?(i=n.position,console.log(`\x1B[31m[BDLibraryPlayerController] Seeking to ${i} seconds. (BD Watched History)`)):console.log("\x1B[31m[BDLibraryPlayerController] No BD history found, starting from beginning.");const o=[],y=t.querySelector(".watch-player__dplayer");if(!y)throw new Error("BDLibraryPlayerController: .watch-player__dplayer element not found");let d;if(this.qualities&&this.qualities.length>0){const c=this.quality_profile.video_streaming_quality;this.qualities.includes(c)?d=c:(d=this.qualities[0],console.warn(`[BDLibraryPlayerController] Configured quality "${c}" not available, using "${d}"`))}else d=this.quality_profile.video_streaming_quality;const _=this.getComputedM3u8Path(d);console.log(`[BDLibraryPlayerController] Using quality "${d}"`),console.log("[BDLibraryPlayerController] Using computed URL:",_),this.player=new fe({container:y,theme:"#E64F97",lang:"ja-jp",live:!1,loop:!1,autoplay:!0,airplay:!1,hotkey:!1,screenshot:!1,crossOrigin:"anonymous",volume:1,playbackSpeed:[.25,.5,.75,1,1.1,1.25,1.5,1.75,2],highlight:o,video:this.qualities&&this.qualities.length>0?{quality:this.qualities.map((c,b)=>({name:c,url:this.getComputedM3u8Path(c),type:"hls"})),defaultQuality:this.qualities.indexOf(d)!==-1?this.qualities.indexOf(d):0}:{url:_,type:"hls"},danmaku:!1,subtitle:{type:"aribb24"},pluginOptions:{hls:{...ae.DefaultConfig},aribb24:{disableSuperimposeRenderer:!1,normalFont:'"Yu Gothic Medium","Yu Gothic","YuGothic", "Rounded M+ 1m for ARIB", sans-serif',forceStrokeColor:!0,drcsReplacement:!0,enableRawCanvas:!0,useStroke:!0}}}),window.player=this.player,this.player.container.classList.contains("dplayer-mobile")===!0&&this.player.volume(1,void 0,!0),this.player.controller.setAutoHide=c=>{},this.setupVideoPlaybackHandler(),this.setupFullscreenHandler(),this.setupSettingPanelHandler(),this.setupPlayerContainerResizeHandler(),this.setControlDisplayTimer(),this.playback_mode==="Video"&&(this.player.seek(i),this.player.bar.set("played",i/a.recorded_program.recorded_video.duration,"width"),i>a.recorded_program.recording_start_margin+2?this.player.notice("前回視聴した続きから再生します"):this.player.hideNotice(),this.player.play(),console.log(`\x1B[31m[PlayerController] Seeking to ${i} seconds.`)),a.event_emitter.off("SendNotification"),a.event_emitter.on("SendNotification",c=>{this.destroyed===!0||this.player===null||this.player.notice(c.message,c.duration,c.opacity,c.color)}),this.player.on("loadedmetadata",()=>{console.log("\x1B[31m[BDLibraryPlayerController] Video metadata loaded");const c=this.player.video.audioTracks;c&&c.length>0&&(console.log(`\x1B[31m[BDLibraryPlayerController] Found ${c.length} audio tracks in video element`),c.length>0&&(c[0].enabled=!0,console.log(`\x1B[31m[BDLibraryPlayerController] Enabled audio track: ${c[0].id}`)));const b=this.player.video.textTracks;if(b&&b.length>0){console.log(`\x1B[31m[BDLibraryPlayerController] Found ${b.length} text tracks in video element`);for(let k=0;k<b.length;k++)b[k].mode="hidden"}}),setTimeout(()=>{this.addCustomSettingItems(e,s)},1e3),this.observeSettingPanel(e,s);let u=!1;a.event_emitter.off("PlayerRestartRequired"),a.event_emitter.on("PlayerRestartRequired",async c=>{var W,Q,X,J;if(this.destroyed===!0||this.player===null)return;if(console.warn("\x1B[31m[PlayerController] PlayerRestartRequired event received. Message: ",c.message),this.playback_mode==="Live"&&z.isSupported()!==!0){console.warn("\x1B[31m[PlayerController] PlayerRestartRequired event received, but mpegts.js is not supported. Ignored."),(W=this.player)==null||W.notice("iOS (Safari) 17.0 以下での視聴には対応していません。速やかに iOS を 17.1 以降に更新してください。",-1,void 0,"#FF6F6A");return}if(u===!0){console.warn("\x1B[31m[PlayerController] PlayerRestartRequired event received, but already restarting. Ignored.");return}u=!0,(Q=this.player)!=null&&Q.qualityIndex&&this.player.options.video.quality[this.player.qualityIndex];const b=((X=this.player)==null?void 0:X.video.playbackRate)??null,k=((J=this.player)==null?void 0:J.video.currentTime)??null;await this.destroy(),await p.sleep(.5);const L=document.querySelector(".watch-player");if(!L){console.error("[BDLibraryPlayerController] Container element not found during restart"),u=!1;return}try{await this.init(L,[],[]),console.log("[BDLibraryPlayerController] Player restart completed successfully")}catch(q){console.error("[BDLibraryPlayerController] Error during player restart:",q),u=!1;return}if(u=!1,k!==null&&this.player!==null&&(this.player.video.currentTime=k,console.log(`[BDLibraryPlayerController] Resumed playback at ${k} seconds after restart (skip message disabled)`)),b!==null&&this.player!==null&&(this.player.video.playbackRate=b,console.log(`[BDLibraryPlayerController] Restored playback rate to ${b}x after restart`)),this.player!==null&&this.player.switchQuality){const q=this.quality_profile.video_streaming_quality,O=(this.player.options.video.quality||[]).findIndex(ce=>ce.name===q);O!==-1?(this.player.switchQuality(O),console.log(`[BDLibraryPlayerController] Switched to quality "${q}" (index: ${O}) after restart`)):console.warn(`[BDLibraryPlayerController] Target quality "${q}" not found in available qualities`)}if(D(this.player!==null),c.message){await p.sleep(c.message_delay_seconds??0);const q=c.is_error_message===!1?void 0:"#FF6F6A";this.player.notice(c.message,void 0,void 0,q)}}),a.event_emitter.off("SetControlDisplayTimer"),a.event_emitter.on("SetControlDisplayTimer",c=>{this.setControlDisplayTimer(c.event,c.is_player_region_event,c.timeout_seconds)}),this.player.container.querySelector(".dplayer-icons.dplayer-icons-right").insertAdjacentHTML("afterbegin",`
            <div class="dplayer-icon dplayer-player-restart-icon" aria-label="プレイヤーを再起動"
                data-balloon-nofocus="" data-balloon-pos="up">
                <span class="dplayer-icon-content">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 5V3.21c0-.45-.54-.67-.85-.35l-2.8 2.79c-.2.2-.2.51 0 .71l2.79 2.79c.32.31.86.09.86-.36V7c3.31 0 6 2.69 6 6c0 2.72-1.83 5.02-4.31 5.75c-.42.12-.69.52-.69.95c0 .65.62 1.16 1.25.97A7.991 7.991 0 0 0 20 13c0-4.42-3.58-8-8-8zm-6 8c0-1.34.44-2.58 1.19-3.59c.3-.4.26-.95-.09-1.31c-.42-.42-1.14-.38-1.5.1a7.991 7.991 0 0 0 4.15 12.47c.63.19 1.25-.32 1.25-.97c0-.43-.27-.83-.69-.95C7.83 18.02 6 15.72 6 13z"/></svg>
                </span>
            </div>
        `),this.player.container.querySelector(".dplayer-player-restart-icon").addEventListener("click",async()=>{var c,b,k,L;(c=this.player)!=null&&c.qualityIndex&&this.player.options.video.quality[this.player.qualityIndex],(b=this.player)==null||b.video.playbackRate,(k=this.player)==null||k.video.currentTime,await this.destroy(),await this.init(document.querySelector(".watch-player__dplayer"),[],[]),(L=this.player)==null||L.notice("プレイヤーを再起動しました。",void 0,void 0,void 0)}),"wakeLock"in navigator&&navigator.wakeLock.request("screen").then(c=>{this.screen_wake_lock=c,console.log("\x1B[31m[PlayerController] Screen Wake Lock API: Screen Wake Lock acquired.")}),this.playback_mode==="Live"?this.player_managers=[new be(this.player),new ve(this.player),new le(this.player,this.playback_mode),new se(this.player,this.playback_mode),new oe(this.player,this.playback_mode)]:this.player_managers=[new le(this.player,this.playback_mode),new se(this.player,this.playback_mode),new oe(this.player,this.playback_mode)],await Promise.all(this.player_managers.map(c=>c.init())),this.player!==null&&(this.player.template.container.style.cursor=""),console.log("\x1B[31m[PlayerController] Initialized.")}getSubtitleTracks(){return this.player&&this.player.subtitle?this.player.subtitle.tracks||[]:[]}getAudioTracks(){return this.player&&this.player.audio?this.player.audio||[]:[]}switchSubtitleTrack(t){this.player&&this.player.subtitle&&this.getSubtitleTracks()[t]&&this.player.subtitle.switch(t)}switchAudioTrack(t){this.player&&this.player.audio&&this.getAudioTracks()[t]&&this.player.audio.switch(t)}getPlaybackBufferSeconds(){if(this.player===null)return 0;if(this.playback_mode==="Live")try{const t=this.player.video.buffered.length,e=this.player.video.buffered.end(t-1)-this.player.video.currentTime;return p.mathFloor(e,3)}catch{return 0}else return 0}async recoverPlayback(){var e,s,a,i;D(this.player!==null);const t=S();if(await p.sleep(1),t.is_video_buffering===!0&&((s=(e=this.player)==null?void 0:e.video)==null?void 0:s.readyState)<3){console.warn("\x1B[31m[PlayerController] Video still buffering. (HTMLVideoElement.readyState < HAVE_FUTURE_DATA) Trying to recover."),this.player.video.pause(),await p.sleep(.25);try{await this.player.video.play()}catch{D(this.player!==null),console.warn("\x1B[31m[PlayerController] HTMLVideoElement.play() rejected. paused."),this.player.pause();return}if(await p.sleep(.5),t.is_video_buffering===!0&&((i=(a=this.player)==null?void 0:a.video)==null?void 0:i.readyState)<3){console.warn("\x1B[31m[PlayerController] Video still buffering. (HTMLVideoElement.readyState < HAVE_FUTURE_DATA) Trying to recover."),this.player.video.pause(),await p.sleep(.25);try{await this.player.video.play()}catch{D(this.player!==null),console.warn("\x1B[31m[PlayerController] (retry) HTMLVideoElement.play() rejected. paused."),this.player.pause()}}}}setupVideoPlaybackHandler(){D(this.player!==null);const t=x(),e=S();F(),this.playback_mode==="Live"&&(this.live_force_seek_interval_timer_cancel=p.setIntervalInWorker(()=>{this.player!==null&&this.player.video.paused&&this.player.video.buffered.length>=1&&this.player.video.buffered.end(0)-this.player.video.currentTime>30&&this.player.sync()},60*1e3)),this.playback_mode==="Video"&&(this.video_keep_alive_interval_timer_cancel=p.setIntervalInWorker(async()=>{if(this.player===null)return;const o=M.extractVideoAPIQualityFromDPlayer(this.player),y=M.extractSessionIdFromDPlayer(this.player);await re.put(`${p.api_base_url}/streams/video/${e.recorded_program.id}/${o}/keep-alive?session_id=${y}`)},5*1e3));const s=()=>{this.player!==null&&(e.is_video_paused=this.player.video.paused,this.player.video.paused===!0&&e.is_loading===!1&&(e.is_video_buffering=!1),this.player.setting.hide(),this.setControlDisplayTimer())};this.player.on("play",s),this.player.on("pause",s),this.player.on("waiting",()=>{e.is_video_buffering=!0}),this.player.on("playing",()=>{e.is_loading===!1&&(e.is_video_buffering=!1),this.playback_mode==="Live"&&this.recoverPlayback()});const a=async()=>{var o,y;D(this.player!==null),e.background_url=M.generatePlayerBackgroundURL();for(const d of this.player_managers)d.restart_required_when_quality_switched===!0&&d.destroy().then(()=>d.init());if(this.playback_mode==="Live"){if((o=this.player.plugins.mpegts)==null||o.on(z.Events.ERROR,async(u,c)=>{this.player!==null&&(await p.sleep(1),navigator.onLine===!1&&(this.player.notice("現在ネットワーク接続がありません。オンラインになるまで待機しています…",void 0,void 0,"#FF6F6A"),console.warn("\x1B[31m[PlayerController] mpegts.js error event: Network error. Waiting for online..."),await p.waitUntilOnline()),console.error("\x1B[31m[PlayerController] mpegts.js error event:",u,c),e.event_emitter.emit("PlayerRestartRequired",{message:`再生中にエラーが発生しました。(${u}: ${c}) プレイヤーを再起動しています…`}))}),this.player.on("error",async u=>{this.player===null||e.live_stream_status==="Offline"||(await p.sleep(1),this.player.video.error?(console.error("\x1B[31m[PlayerController] HTMLVideoElement error event:",this.player.video.error),e.event_emitter.emit("PlayerRestartRequired",{message:`再生中にエラーが発生しました。(Native: ${this.player.video.error.code}: ${this.player.video.error.message}) プレイヤーを再起動しています…`})):e.event_emitter.emit("PlayerRestartRequired",{message:"再生中にエラーが発生しました。(Native: unknown error) プレイヤーを再起動しています…"}))}),e.is_loading=!0,this.player.video.muted=!0,this.player.video.paused===!0){let u=0;const c=5,b=.05,k=async()=>{var L;if(u>=c){console.warn(`\x1B[31m[PlayerController] Failed to start playback after ${c} attempts.`);return}try{await((L=this.player)==null?void 0:L.video.play()),console.log("\x1B[31m[PlayerController] Playback started successfully.")}catch(W){console.warn(`\x1B[31m[PlayerController] Attempt ${u+1} to start playback failed:`,W),u++,await p.sleep(b),await k()}};await k()}let d=!1;const _=async()=>{if(this.player===null||d===!0)return;this.player.video.oncanplay=null,this.player.video.oncanplaythrough=null,d=!0,console.log("\x1B[31m[PlayerController] Buffering..."),this.player.video.playbackRate=0;const u=this.live_playback_buffer_seconds;let c=this.getPlaybackBufferSeconds();for(;c<u;)await p.sleep(.1),c=this.getPlaybackBufferSeconds();this.player.video.playbackRate=1,console.log("\x1B[31m[PlayerController] Buffering completed."),e.is_loading=!1,e.is_video_buffering=!1,this.recoverPlayback(),t.channel.current.is_radiochannel===!0?e.is_background_display=!0:e.is_background_display=!1,this.player.video.muted=!1,this.player.video.volume=0;const b=this.player.user.get("volume"),k=b/10;for(let L=0;L<10;L++)await p.sleep(.5/10),this.player.video.volume=Math.min(p.mathFloor(this.player.video.volume+k,3),b);this.player.video.volume=b};if(this.player.video.oncanplay=_,this.player.video.oncanplaythrough=_,(y=this.player.plugins.mpegts)==null||y.on(z.Events.MEDIA_INFO,async u=>{console.log("\x1B[31m[PlayerController] mpegts.js media info:",u),await p.sleep(.25),d===!1&&(console.warn("\x1B[31m[PlayerController] mpegts.js media info fired, but canplay(through) event not fired. Trying to manually start playback."),_())}),(async()=>{let u=0;for(;this.player!==null&&this.player.video.readyState<4;){if(this.player.video.readyState<3)u=0;else if(++u>100)break;await p.sleep(.05)}await p.sleep(.1),d===!1&&(console.warn("\x1B[31m[PlayerController] canplay(through) event not fired. Trying to manually start playback."),_())})(),await p.sleep(15),this.destroyed===!0||this.player===null)return;e.live_stream_status==="ONAir"&&e.is_video_buffering===!0&&d===!1&&e.event_emitter.emit("PlayerRestartRequired",{message:"再生開始までに時間が掛かっています。プレイヤーを再起動しています…"})}else{e.is_loading=!0,e.is_background_display=!0;let d=!1;const _=async()=>{this.player!==null&&d!==!0&&(this.player.video.oncanplaythrough=null,d=!0,e.is_loading=!1,e.is_video_buffering=!1,e.is_background_display=!1)};this.player.video.oncanplaythrough=_,this.player.on("error",async u=>{this.player!==null&&(this.player.video.error?(console.error("\x1B[31m[PlayerController] HTMLVideoElement error event:",this.player.video.error),e.event_emitter.emit("PlayerRestartRequired",{message:`再生中にエラーが発生しました。(Native: ${this.player.video.error.code}: ${this.player.video.error.message}) プレイヤーを再起動しています…`})):e.event_emitter.emit("PlayerRestartRequired",{message:"再生中にエラーが発生しました。(Native: unknown error) プレイヤーを再起動しています…"}))})}};a(),this.player.on("quality_start",a);let i=0,l=0;const n=document.querySelector(".program-info__next");if(n!==null&&(n.ontouchstart=()=>{if(this.player===null)return;const o=new Date().getTime(),y=o-l;y<500&&y>0&&(i++,i===3&&(this.player.infoPanel.toggle(),i=0)),l=o}),this.playback_mode==="Video"){this.player.on("timeupdate",()=>{!this.player||!this.player.video||e.event_emitter.emit("PlaybackPositionChanged",{playback_position:this.player.video.currentTime})});let o=0;this.player.on("timeupdate",()=>{if(!this.player||!this.player.video)return;const y=new Date().getTime();if(y-o<T.WATCHED_HISTORY_UPDATE_INTERVAL*1e3)return;o=y;const d=this.player.video.currentTime,_=this.bdItem.id;if(!ie().is_logged_in)return;const c=N();c.history_items.find(k=>k.bd_id===_)&&c.addHistory(this.bdItem,Math.floor(d),Math.floor(this.player.video.duration))}),this.watched_history_threshold_timer_id=window.setTimeout(()=>{if(!this.player||!this.player.video)return;const y=this.bdItem.id;if(!ie().is_logged_in)return;const _=N();_.history_items.find(c=>c.bd_id===y)||_.addHistory(this.bdItem,Math.floor(this.player.video.currentTime),Math.floor(this.player.video.duration))},T.WATCHED_HISTORY_THRESHOLD_SECONDS*1e3)}}setupFullscreenHandler(){D(this.player!==null);const t=S(),e=document.body;this.player.fullScreen.isFullScreen=a=>!!(document.fullscreenElement||document.webkitFullscreenElement),this.player.fullScreen.request=a=>{if(D(this.player!==null),this.player.fullScreen.isFullScreen()){this.player.fullScreen.cancel();return}if(e.requestFullscreen=e.requestFullscreen||e.webkitRequestFullscreen,e.requestFullscreen)e.requestFullscreen();else{this.player.notice("iPhone Safari は動画のフルスクリーン表示に対応していません。",void 0,void 0,"#FF6F6A");return}screen.orientation&&screen.orientation.lock("landscape").catch(()=>{})},this.player.fullScreen.cancel=a=>{document.exitFullscreen=document.exitFullscreen||document.webkitExitFullscreen,document.exitFullscreen&&document.exitFullscreen(),screen.orientation&&screen.orientation.unlock()};const s=()=>{D(this.player!==null),t.is_fullscreen=this.player.fullScreen.isFullScreen()===!0};e.onfullscreenchange!==void 0?e.onfullscreenchange=s:e.onwebkitfullscreenchange!==void 0&&(e.onwebkitfullscreenchange=s)}setupSettingPanelHandler(){D(this.player!==null);const t=S(),e=this.player.setting.hide,s=this.player.setting.show;this.player.setting.hide=()=>{this.player!==null&&(e.call(this.player.setting),t.is_player_setting_panel_open=!1)},this.player.setting.show=()=>{this.player!==null&&(s.call(this.player.setting),t.is_player_setting_panel_open=!0)},this.player.template.audio.insertAdjacentHTML("afterend",`
            <div class="dplayer-setting-item dplayer-setting-mobile-profile">
                <span class="dplayer-label">モバイル回線向け画質</span>
                <div class="dplayer-toggle">
                    <input class="dplayer-mobile-profile-setting-input" type="checkbox" name="dplayer-toggle-mobile-profile">
                    <label for="dplayer-toggle-mobile-profile" style="--theme-color:#E64F97"></label>
                </div>
            </div>
        `);const a=this.player.container.querySelector(".dplayer-mobile-profile-setting-input");a.checked=this.quality_profile_type==="Cellular",this.player.container.querySelector(".dplayer-setting-mobile-profile").addEventListener("click",async()=>{try{a.checked=!a.checked,a.checked?(this.quality_profile_type="Cellular",console.log("[BDLibraryPlayerController] Switching to Cellular quality profile"),setTimeout(()=>{t.event_emitter.emit("PlayerRestartRequired",{message:"モバイル回線向けの画質プロファイルに切り替えました。",message_delay_seconds:this.quality_profile.tv_low_latency_mode||this.playback_mode==="Video"?2:4.5,is_error_message:!1})},100)):(this.quality_profile_type="Wi-Fi",console.log("[BDLibraryPlayerController] Switching to Wi-Fi quality profile"),setTimeout(()=>{t.event_emitter.emit("PlayerRestartRequired",{message:"Wi-Fi 回線向けの画質プロファイルに切り替えました。",message_delay_seconds:this.quality_profile.tv_low_latency_mode||this.playback_mode==="Video"?2:4.5,is_error_message:!1})},100))}catch(l){console.error("[BDLibraryPlayerController] Error during quality profile switch:",l),a.checked=!a.checked,this.player&&this.player.notice("画質プロファイルの切り替えに失敗しました。",3,void 0,"#FF6F6A")}}),p.isTouchDevice()===!1&&(this.player.template.settingOriginPanel.insertAdjacentHTML("beforeend",`
                <div class="dplayer-setting-item dplayer-setting-keyboard-shortcut">
                    <span class="dplayer-label">キーボードショートカット</span>
                    <div class="dplayer-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 32 32">
                            <path d="M22 16l-10.105-10.6-1.895 1.987 8.211 8.613-8.211 8.612 1.895 1.988 8.211-8.613z"></path>
                        </svg>
                    </div>
                </div>
            `),this.player.template.settingOriginPanel.querySelector(".dplayer-setting-keyboard-shortcut").addEventListener("click",()=>{D(this.player!==null),this.player.setting.hide(),t.shortcut_key_modal=!0}))}setupPlayerContainerResizeHandler(){const t=document.querySelector(".watch-player"),e=()=>{};this.player_container_resize_observer=new ResizeObserver(e),this.player_container_resize_observer.observe(t)}setControlDisplayTimer(t=null,e=!1,s=3){const a=S();if(p.isTouchDevice()===!0&&t!==null&&t.type==="mousemove"||p.isTouchDevice()===!1&&t!==null&&(t.type==="touchmove"||t.type==="click"))return;window.clearTimeout(this.player_control_ui_hide_timer_id);const i=()=>{this.player!==null&&(a.is_control_display=!1,this.player.controller.hide(),this.player.setting.hide(),this.player.template.container.style.cursor="none")};this.player!==null&&(p.isTouchDevice()===!0&&e===!0?this.player.controller.isShow()?(a.is_control_display=!0,this.player.controller.show(),this.player.template.container.style.cursor="",this.player_control_ui_hide_timer_id=window.setTimeout(i,s*1e3)):(a.is_control_display=!1,this.player.controller.hide(),this.player.setting.hide(),this.player.template.container.style.cursor="none"):(a.is_control_display=!0,this.player.controller.show(),this.player.template.container.style.cursor="",this.player_control_ui_hide_timer_id=window.setTimeout(i,s*1e3)))}seek(t,e){this.player&&(this.player.seek(t),e&&this.player.notice(e))}showController(){this.player&&this.player.controller.show()}hideController(){this.player&&this.player.controller.hide()}setAudioTrack(t){if(!this.player)return;console.log(`[BDLibraryPlayerController] Setting audio track to: ${t}`);const e=this.player.video.audioTracks;if(e&&e.length>0){console.log(`[BDLibraryPlayerController] Found ${e.length} audio tracks`);for(let s=0;s<e.length;s++){const a=e[s],i=a.id===t;a.enabled=i,console.log(`[BDLibraryPlayerController] Audio track ${a.id}: ${i?"enabled":"disabled"}`)}}else console.warn("[BDLibraryPlayerController] No audio tracks found in video element")}setSubtitleTrack(t){if(!this.player)return;console.log(`[BDLibraryPlayerController] Setting subtitle track to: ${t}`);const e=this.player.video.textTracks;if(e&&e.length>0){console.log(`[BDLibraryPlayerController] Found ${e.length} text tracks`);for(let s=0;s<e.length;s++){const a=e[s],i=t!==null&&a.id==t.toString();a.mode=i?"showing":"hidden",console.log(`[BDLibraryPlayerController] Text track ${a.id}: ${i?"showing":"hidden"}`)}}else console.warn("[BDLibraryPlayerController] No text tracks found in video element")}observeSettingPanel(t,e){const s=new MutationObserver(i=>{i.forEach(l=>{if(l.type==="childList"){const n=document.querySelector(".dplayer-setting-box");n&&n.style.display!=="none"&&setTimeout(()=>{this.addCustomSettingItems(t,e)},100)}})}),a=document.querySelector(".dplayer");a&&s.observe(a,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style"]})}addCustomSettingItems(t,e){var l,n;if(!this.player)return;console.log("[BDLibraryPlayerController] Adding custom setting items"),console.log("Audio tracks:",t),console.log("Subtitle tracks:",e);const s=document.querySelector(".dplayer-setting-box");if(!s){console.warn("[BDLibraryPlayerController] Setting box not found");return}const a=s.querySelector(".bdlibrary-audio-select"),i=s.querySelector(".bdlibrary-subtitle-select");if(a&&((l=a.parentElement)==null||l.remove()),i&&((n=i.parentElement)==null||n.remove()),t&&t.length>1){const o=document.createElement("div");o.className="dplayer-setting-item",o.innerHTML=`
                <span>音声</span>
                <select class="bdlibrary-audio-select">
                    ${t.map(d=>`<option value="${d.id}">${d.name||`Audio ${d.id}`} (${d.language||"und"}${d.channels?", "+d.channels+"ch":""})</option>`).join("")}
                </select>
            `,s.appendChild(o),o.querySelector(".bdlibrary-audio-select").addEventListener("change",d=>{const _=d.target,u=Number(_.value);console.log("[BDLibraryPlayerController] Audio track selected:",u),this.setAudioTrack(u)}),console.log("[BDLibraryPlayerController] Added audio selection item")}if(e&&e.length>0){const o=document.createElement("div");o.className="dplayer-setting-item",o.innerHTML=`
                <span>字幕</span>
                <select class="bdlibrary-subtitle-select">
                    <option value="">オフ</option>
                    ${e.map(d=>`<option value="${d.id}">${d.name||`Subtitle ${d.id}`} (${d.language||"und"})</option>`).join("")}
                </select>
            `,s.appendChild(o),o.querySelector(".bdlibrary-subtitle-select").addEventListener("change",d=>{const _=d.target,u=_.value?Number(_.value):null;console.log("[BDLibraryPlayerController] Subtitle track selected:",u),this.setSubtitleTrack(u)}),console.log("[BDLibraryPlayerController] Added subtitle selection item")}}async destroy(){const t=F(),e=S();if(this.destroyed!==!0&&this.destroying!==!0){if(this.destroying=!0,this.playback_mode==="Video"&&this.player&&this.player.video){const s=t.settings.watched_history.findIndex(a=>a.video_id===e.recorded_program.id);if(s!==-1){const a=this.player.video.currentTime-10;t.settings.watched_history[s].last_playback_position=a,t.settings.watched_history[s].updated_at=p.time(),console.log(`\x1B[31m[PlayerController] Last playback position updated. (Video ID: ${e.recorded_program.id}, last_playback_position: ${a})`)}}if(console.log("\x1B[31m[PlayerController] Destroying..."),await Promise.all(this.player_managers.map(async s=>s.destroy())),this.player_managers=[],this.screen_wake_lock!==null&&(this.screen_wake_lock.release(),this.screen_wake_lock=null,console.log("\x1B[31m[PlayerController] Screen Wake Lock API: Screen Wake Lock released.")),e.is_background_display=!1,e.is_loading=!0,e.live_comment_init_failed_message=null,e.video_comment_init_failed_message=null,this.player!==null){const a=this.player.user.get("volume")/10;for(let i=0;i<10;i++)await p.sleep(.2/10),this.player&&this.player.video&&(this.player.video.volume=Math.max(p.mathFloor(this.player.video.volume-a,3),0));this.player.video.volume=0}if(this.live_force_seek_interval_timer_cancel!==null&&(this.live_force_seek_interval_timer_cancel(),this.live_force_seek_interval_timer_cancel=null),this.video_keep_alive_interval_timer_cancel!==null&&(this.video_keep_alive_interval_timer_cancel(),this.video_keep_alive_interval_timer_cancel=null),window.clearTimeout(this.watched_history_threshold_timer_id),window.clearTimeout(this.player_control_ui_hide_timer_id),this.player_container_resize_observer!==null&&(this.player_container_resize_observer.disconnect(),this.player_container_resize_observer=null),this.player!==null){if(this.player.events.events.error&&(this.player.events.events.error=[]),this.player.plugins.mpegts)try{this.player.plugins.mpegts.unload(),this.player.plugins.mpegts.detachMediaElement(),this.player.plugins.mpegts.destroy()}catch{}this.player.template.container.style.cursor="";try{this.player.destroy(!0)}catch{}this.player=null}this.destroying=!1,this.destroyed=!0,e.is_player_initialized=!1,console.log("\x1B[31m[PlayerController] Destroyed.")}}};m(T,"LIVE_PLAYBACK_BUFFER_SECONDS_LOW_LATENCY",.9),m(T,"LIVE_PLAYBACK_BUFFER_SECONDS",4),m(T,"WATCHED_HISTORY_MAX_COUNT",50),m(T,"WATCHED_HISTORY_THRESHOLD_SECONDS",30),m(T,"WATCHED_HISTORY_UPDATE_INTERVAL",10);let j=T,E=null;const st=R({name:"BDLibraryWatch",components:{BDLibraryWatchMain:lt},computed:{...U(S,F,K,N)},created(){this.init()},beforeRouteUpdate(r,t,e){this.destroy().then(()=>this.init()),e()},beforeUnmount(){this.destroy()},methods:{async init(){if(this.$route.params.id===void 0){this.$router.push({path:"/not-found/"});return}console.log("BD ID:",this.$route.params.id);const r=await Y.fetchBDLibraryItem(parseInt(this.$route.params.id));if(console.log("BD Item fetched:",r),console.log("BD Item titles:",r==null?void 0:r.titles),console.log("BD Item chapters:",r==null?void 0:r.chapters),r===null){console.error("BD item not found for ID:",this.$route.params.id),this.$router.push({path:"/not-found/"});return}this.bdLibraryStore.bdItem=r,console.log("Attempting to fetch tracks for BD ID:",r.id);try{const i=await Y.fetchBDLibraryTracks(r.id);console.log("Tracks API response:",i),i&&i.audio&&i.subtitle?(console.log("Adding tracks to BD item"),r.audio=i.audio,r.subtitle=i.subtitle,this.bdLibraryStore.bdItem={...r,audio:i.audio,subtitle:i.subtitle},console.log("Updated BD item with tracks:",this.bdLibraryStore.bdItem)):console.log("No tracks data received or invalid format")}catch(i){console.error("Failed to fetch tracks:",i),console.log("Proceeding without tracks data")}await this.bdLibraryHistoryStore.fetchHistoryList(),console.log("Attempting to fetch chapters for BD ID:",r.id);try{const i=await Y.fetchBDLibraryChapters(r.id);console.log("Chapters API response:",i),i&&Array.isArray(i)?(console.log("Adding chapters to BD item"),r.chapters=i,this.bdLibraryStore.bdItem={...r,chapters:i},console.log("Updated BD item with chapters:",this.bdLibraryStore.bdItem)):console.log("No chapters data received or invalid format")}catch(i){console.error("Failed to fetch chapters:",i),console.log("Proceeding without chapters data")}this.playerStore.is_loading=!0,this.playerStore.is_background_display=!0,this.playerStore.is_video_buffering=!1,this.playerStore.is_panel_display=!0,setInterval(()=>{const i=!!document.fullscreenElement;this.playerStore.is_fullscreen!==i&&(console.log("[BDLibraryWatch] Updating fullscreen state:",i),this.playerStore.is_fullscreen=i)},500);const e=crypto.randomUUID().split("-")[0],s=`/api/streams/bd-library/${r.id}/original/playlist.m3u8?session_id=${e}`;console.log("[BDLibraryWatch] Generated session_id:",e),console.log("[BDLibraryWatch] Final m3u8 path:",s),console.log("[BDLibraryWatch] Available qualities:",r.available_qualities),E=new j(s,r.available_qualities||[],0,r),await this.$nextTick(),await new Promise(i=>setTimeout(i,200));const a=document.querySelector(".watch-player");if(a){console.log("Initializing BDLibraryPlayerController with:",{m3u8Path:s,qualities:r.available_qualities,audio:r.audio,subtitle:r.subtitle});try{await E.init(a,r.audio||[],r.subtitle||[]),console.log("BDLibraryPlayerController initialized successfully");const i=a.querySelector(".dplayer");console.log("DPlayer element found:",i);const l=()=>{const n=a.querySelector(".dplayer"),o=n==null?void 0:n.querySelector("video");console.log("Checking player ready state..."),console.log("DPlayer classes:",n==null?void 0:n.className),console.log("Video element:",o),console.log("Video readyState:",o==null?void 0:o.readyState),console.log("Video networkState:",o==null?void 0:o.networkState),o&&o.readyState>=2?(console.log("Video is ready, clearing loading state"),this.playerStore.is_loading=!1,this.playerStore.is_background_display=!1):n&&!n.classList.contains("dplayer-loading")?(console.log("DPlayer loading class removed, clearing loading state"),this.playerStore.is_loading=!1,this.playerStore.is_background_display=!1):setTimeout(l,500)};setTimeout(l,1e3),setTimeout(()=>{console.log("[BDLibraryWatch] Force clearing loading state after 10 seconds"),this.playerStore.is_loading=!1,this.playerStore.is_background_display=!1;const n=a.querySelector(".dplayer");n&&n.classList.contains("dplayer-loading")&&(console.log("[BDLibraryWatch] Force removing dplayer-loading class"),n.classList.remove("dplayer-loading"))},1e4)}catch(i){console.error("Failed to initialize BDLibraryPlayerController:",i),this.playerStore.is_loading=!1}}else console.error("Player container not found"),this.playerStore.is_loading=!1},async destroy(){E!==null&&(await E.destroy(),E=null)},getBDPlayerController(){return E}}});function ot(r,t,e,s,a,i){const l=P("BDLibraryWatchMain");return h(),V(l,{playback_mode:"Video"})}const nt=H(st,[["render",ot],["__scopeId","data-v-168a1a32"]]),ct=R({name:"BDLibrary-Watch",components:{BDLibraryWatch:nt}});function dt(r,t,e,s,a,i){const l=P("BDLibraryWatch");return h(),V(l,{playback_mode:"Video"})}const Bt=H(ct,[["render",dt]]);export{Bt as default};
